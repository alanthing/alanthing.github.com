--- php.spec	2013-05-12 17:46:05.000000000 -0400
+++ php.spec-scl	2013-05-17 16:45:26.000000000 -0400
@@ -1,3 +1,25 @@
+%if 0%{?scl:1}
+%scl_package php
+%else
+%global pkg_name          %{name}
+%global _root_sysconfdir  %{_sysconfdir}
+%global _root_bindir      %{_bindir}
+%global _root_sbindir     %{_sbindir}
+%global _root_includedir  %{_includedir}
+%global _root_libdir      %{_libdir}
+%global _root_prefix      %{_prefix}
+%if 0%{?rhel} < 6
+%global _root_initddir    /etc
+%else
+%global _root_initddir    %{_initddir}
+%endif
+%endif
+
+# Ugly hack. Harcoded values to avoid relocation.
+%global _httpd_confdir     %{_root_sysconfdir}/httpd/conf.d
+%global _httpd_moddir      %{_libdir}/httpd/modules
+%global _root_httpd_moddir %{_root_libdir}/httpd/modules
+
 %{!?phpname:		%{expand: %%global phpname     php}}
 %define _default_patch_fuzz 2
 
@@ -14,7 +36,7 @@
 %global jsonver     1.2.1
 %global oci8ver     1.4.9
 
-%global httpd_mmn %(cat %{_includedir}/httpd/.mmn || echo missing-httpd-devel)
+%global httpd_mmn %(cat %{_root_includedir}/httpd/.mmn || echo missing-httpd-devel)
 
 %ifarch ppc ppc64
 %global oraclever 10.2.0.2
@@ -27,7 +49,7 @@
 
 # Use the arch-specific mysql_config binary to avoid mismatch with the
 # arch detection heuristic used by bindir/mysql_config.
-%global mysql_config %{_libdir}/mysql/mysql_config
+%global mysql_config %{_root_libdir}/mysql/mysql_config
 
 %global phpversion %{version}
 
@@ -60,9 +82,9 @@
 %global zipmod zip
 
 Summary: PHP scripting language for creating dynamic web sites
-Name: %{phpname}
+Name: %{?scl_prefix}%{phpname}
 Version: 5.3.25
-Release: 18.art
+Release: 18%{?dist}
 License: PHP
 Group: Development/Languages
 URL: http://www.php.net/
@@ -143,27 +165,32 @@
 BuildRequires: pcre-devel >= 7.8
 %endif
 BuildRequires: bzip2, perl, libtool >= 1.4.3, gcc-c++
-Obsoletes: php-mhash
-Conflicts: php-zend-optimizer
+Obsoletes: %{?scl_prefix}php-mhash
+Conflicts: %{?scl_prefix}php-zend-optimizer
 
 %if 0%{?rhel}%{?fedora} > 4
 BuildRequires: libtool-ltdl-devel
 %endif
 
-Obsoletes: %{phpname}-dbg, php3, phpfi, stronghold-php, %{phpname}-zts
-Provides: %{phpname}-zts = %{version}-%{release}
-Provides: %{phpname}-zts%{?_isa} = %{version}-%{release}
+Obsoletes: %{?scl_prefix}%{phpname}-dbg, %{?scl_prefix}php3, %{?scl_prefix}phpfi, %{?scl_prefix}stronghold-php, %{?scl_prefix}%{phpname}-zts
+Provides: %{?scl_prefix}%{phpname}-zts = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-zts%{?_isa} = %{version}-%{release}
 
 Requires: httpd-mmn = %{httpd_mmn}
 Provides: mod_php = %{version}-%{release}
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 # For backwards-compatibility, require php-cli for the time being:
-Requires: %{phpname}-cli%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-cli%{?_isa} = %{version}-%{release}
 # To ensure correct /var/lib/php/session ownership:
 Requires(pre): httpd
 
+# SCL mod_php integrates with built-in Apache, cannot have two versions of mod_php
+%if 0%{?scl:1}
+Conflicts: php53, php
+%else
 # php53
 Obsoletes: php53
+%endif
 
 
 
@@ -174,11 +201,15 @@
 %if %{phpname} == php
 %global peardir      %{_datadir}/pear
 %else
-%global _bindir      /usr/bin/%{phpname}
-%global _includedir  /usr/include/%{phpname}
-%global _sysconfdir  /etc/%{phpname}
+%if 0%{?scl:1}
+%global peardir      %{_datadir}/pear
+%else
+%global _bindir      %{_root_bindir}/%{phpname}
+%global _includedir  %{_root_includedir}/%{phpname}
+%global _sysconfdir  %{_root_sysconfdir}/%{phpname}
 %global peardir      %{_datadir}/%{phpname}/pear
 %endif
+%endif
 
 # RPM 4.8
 %{?filter_provides_in: %filter_provides_in %{_libdir}/%{phpname}/modules/.*\.so$}
@@ -198,32 +229,35 @@
 database-enabled webpage with PHP is fairly simple. The most common
 use of PHP coding is probably as a replacement for CGI scripts. 
 
-The php package contains the module which adds support for the PHP
+The %{?scl_prefix}%{phpname} package contains the module which adds support for the PHP
 language to Apache HTTP Server.
 
 %package cli
 Group: Development/Languages
 Summary: Command-line interface for PHP
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
-Provides: %{phpname}-cgi = %{version}-%{release}, %{phpname}-cgi%{?_isa} = %{version}-%{release}
-Provides: %{phpname}-pcntl, %{phpname}-pcntl%{?_isa}
-Provides: %{phpname}-readline, %{phpname}-readline%{?_isa}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-cgi = %{version}-%{release}, %{?scl_prefix}%{phpname}-cgi%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-pcntl, %{?scl_prefix}%{phpname}-pcntl%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-readline, %{?scl_prefix}%{phpname}-readline%{?_isa}
 # php53 overlap
+%if 0%{?!scl:1}
 Obsoletes: php53-cli
+%endif
 
 %description cli
-The %{phpname}-cli package contains the command-line interface 
-executing PHP scripts, /usr/bin/php, and the CGI interface.
+The %{?scl_prefix}%{phpname}-cli package contains the command-line interface
+executing PHP scripts, %{_bindir}/php, and the CGI interface.
 
 %if %{with_fpm}
 %package fpm
 Group: Development/Languages
 Summary: PHP FastCGI Process Manager
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 %if 0%{?fedora} >= 15
 Requires: systemd-units
 %endif
-BuildRequires: libevent-devel >= 1.4.11
+# libevent needed *until* 5.3.4, see http://bugzilla.redhat.com/show_bug.cgi?id=835671
+#BuildRequires: libevent-devel >= 1.4.11
 
 %description fpm
 PHP-FPM (FastCGI Process Manager) is an alternative PHP FastCGI
@@ -234,126 +268,137 @@
 %package common
 Group: Development/Languages
 Summary: Common files for PHP
+%{?scl:Requires:%scl_runtime}
 # Remove this when value change
-Provides: %{phpname}-api = %{apiver}, %{phpname}-zend-abi = %{zendver}
-Provides: %{phpname}(api) = %{apiver}, %{phpname}(zend-abi) = %{zendver}
+Provides: %{?scl_prefix}%{phpname}-api = %{apiver}, %{?scl_prefix}%{phpname}-zend-abi = %{zendver}
+Provides: %{?scl_prefix}%{phpname}(api) = %{apiver}, %{?scl_prefix}%{phpname}(zend-abi) = %{zendver}
 # New ABI/API check - Arch specific
-Provides: %{phpname}-api = %{apiver}%{isasuffix}, %{phpname}-zend-abi = %{zendver}%{isasuffix}
-Provides: %{phpname}(api) = %{apiver}%{isasuffix}, %{phpname}(zend-abi) = %{zendver}%{isasuffix}
+Provides: %{?scl_prefix}%{phpname}-api = %{apiver}%{isasuffix}, %{?scl_prefix}%{phpname}-zend-abi = %{zendver}%{isasuffix}
+Provides: %{?scl_prefix}%{phpname}(api) = %{apiver}%{isasuffix}, %{?scl_prefix}%{phpname}(zend-abi) = %{zendver}%{isasuffix}
 # Provides for all builtin/shared modules:
-Provides: %{phpname}-bz2, %{phpname}-bz2%{?_isa}
-Provides: %{phpname}-calendar, %{phpname}-calendar%{?_isa}
-Provides: %{phpname}-ctype, %{phpname}-ctype%{?_isa}
-Provides: %{phpname}-curl, %{phpname}-curl%{?_isa}
-Provides: %{phpname}-date, %{phpname}-date%{?_isa}
-Provides: %{phpname}-exif, %{phpname}-exif%{?_isa}
-Provides: %{phpname}-fileinfo, %{phpname}-fileinfo%{?_isa}
-Provides: %{phpname}-pecl-Fileinfo = %{fileinfover}, %{phpname}-pecl-Fileinfo%{?_isa} = %{fileinfover}
-Provides: %{phpname}-pecl(Fileinfo) = %{fileinfover}, %{phpname}-pecl(Fileinfo)%{?_isa} = %{fileinfover}
-Provides: %{phpname}-ftp, %{phpname}-ftp%{?_isa}
-Provides: %{phpname}-gettext, %{phpname}-gettext%{?_isa}
-Provides: %{phpname}-gmp, %{phpname}-gmp%{?_isa}
-Provides: %{phpname}-hash, %{phpname}-hash%{?_isa}
-Provides: %{phpname}-mhash = %{version}, %{phpname}-mhash%{?_isa} = %{version}
-Provides: %{phpname}-iconv, %{phpname}-iconv%{?_isa}
-Provides: %{phpname}-json, %{phpname}-json%{?_isa}
-Provides: %{phpname}-pecl-json = %{jsonver}, %{phpname}-pecl-json%{?_isa} = %{jsonver}
-Provides: %{phpname}-pecl(json) = %{jsonver}, %{phpname}-pecl(json)%{?_isa} = %{jsonver}
-Provides: %{phpname}-libxml, %{phpname}-libxml%{?_isa}
-Provides: %{phpname}-openssl, %{phpname}-openssl%{?_isa}
-Provides: %{phpname}-pecl-phar = %{pharver}, %{phpname}-pecl-phar%{?_isa} = %{pharver}
-Provides: %{phpname}-pecl(phar) = %{pharver}, %{phpname}-pecl(phar)%{?_isa} = %{pharver}
-Provides: %{phpname}-pcre, %{phpname}-pcre%{?_isa}
-Provides: %{phpname}-reflection, %{phpname}-reflection%{?_isa}
-Provides: %{phpname}-session, %{phpname}-session%{?_isa}
-Provides: %{phpname}-shmop, %{phpname}-shmop%{?_isa}
-Provides: %{phpname}-simplexml, %{phpname}-simplexml%{?_isa}
-Provides: %{phpname}-sockets, %{phpname}-sockets%{?_isa}
-Provides: %{phpname}-spl, %{phpname}-spl%{?_isa}
-Provides: %{phpname}-tokenizer, %{phpname}-tokenizer%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-bz2, %{?scl_prefix}%{phpname}-bz2%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-calendar, %{?scl_prefix}%{phpname}-calendar%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-ctype, %{?scl_prefix}%{phpname}-ctype%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-curl, %{?scl_prefix}%{phpname}-curl%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-date, %{?scl_prefix}%{phpname}-date%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-exif, %{?scl_prefix}%{phpname}-exif%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-fileinfo, %{?scl_prefix}%{phpname}-fileinfo%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-pecl-Fileinfo = %{fileinfover}, %{?scl_prefix}%{phpname}-pecl-Fileinfo%{?_isa} = %{fileinfover}
+Provides: %{?scl_prefix}%{phpname}-pecl(Fileinfo) = %{fileinfover}, %{?scl_prefix}%{phpname}-pecl(Fileinfo)%{?_isa} = %{fileinfover}
+Provides: %{?scl_prefix}%{phpname}-ftp, %{?scl_prefix}%{phpname}-ftp%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-gettext, %{?scl_prefix}%{phpname}-gettext%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-gmp, %{?scl_prefix}%{phpname}-gmp%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-hash, %{?scl_prefix}%{phpname}-hash%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-mhash = %{version}, %{?scl_prefix}%{phpname}-mhash%{?_isa} = %{version}
+Provides: %{?scl_prefix}%{phpname}-iconv, %{?scl_prefix}%{phpname}-iconv%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-json, %{?scl_prefix}%{phpname}-json%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-pecl-json = %{jsonver}, %{?scl_prefix}%{phpname}-pecl-json%{?_isa} = %{jsonver}
+Provides: %{?scl_prefix}%{phpname}-pecl(json) = %{jsonver}, %{?scl_prefix}%{phpname}-pecl(json)%{?_isa} = %{jsonver}
+Provides: %{?scl_prefix}%{phpname}-libxml, %{?scl_prefix}%{phpname}-libxml%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-openssl, %{?scl_prefix}%{phpname}-openssl%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-pecl-phar = %{pharver}, %{?scl_prefix}%{phpname}-pecl-phar%{?_isa} = %{pharver}
+Provides: %{?scl_prefix}%{phpname}-pecl(phar) = %{pharver}, %{?scl_prefix}%{phpname}-pecl(phar)%{?_isa} = %{pharver}
+Provides: %{?scl_prefix}%{phpname}-pcre, %{?scl_prefix}%{phpname}-pcre%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-reflection, %{?scl_prefix}%{phpname}-reflection%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-session, %{?scl_prefix}%{phpname}-session%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-shmop, %{?scl_prefix}%{phpname}-shmop%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-simplexml, %{?scl_prefix}%{phpname}-simplexml%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-sockets, %{?scl_prefix}%{phpname}-sockets%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-spl, %{?scl_prefix}%{phpname}-spl%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-tokenizer, %{?scl_prefix}%{phpname}-tokenizer%{?_isa}
 %if %{with_zip}
-Provides: %{phpname}-zip, %{phpname}-zip%{?_isa}
-Provides: %{phpname}-pecl-zip = %{zipver}, %{phpname}-pecl-zip%{?_isa} = %{zipver}
-Provides: %{phpname}-pecl(zip) = %{zipver}, %{phpname}-pecl(zip)%{?_isa} = %{zipver}
-Obsoletes: %{phpname}-pecl-zip
-%endif
-Provides: %{phpname}-zlib, %{phpname}-zlib%{?_isa}
-Obsoletes: %{phpname}-openssl, %{phpname}-pecl-json, %{phpname}-json, %{phpname}-pecl-phar, %{phpname}-pecl-Fileinfo
+Provides: %{?scl_prefix}%{phpname}-zip, %{?scl_prefix}%{phpname}-zip%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-pecl-zip = %{zipver}, %{?scl_prefix}%{phpname}-pecl-zip%{?_isa} = %{zipver}
+Provides: %{?scl_prefix}%{phpname}-pecl(zip) = %{zipver}, %{?scl_prefix}%{phpname}-pecl(zip)%{?_isa} = %{zipver}
+Obsoletes: %{?scl_prefix}%{phpname}-pecl-zip
+%endif
+Provides: %{?scl_prefix}%{phpname}-zlib, %{?scl_prefix}%{phpname}-zlib%{?_isa}
+Obsoletes: %{?scl_prefix}%{phpname}-openssl, %{?scl_prefix}%{phpname}-pecl-json, %{?scl_prefix}%{phpname}-json, %{?scl_prefix}%{phpname}-pecl-phar, %{?scl_prefix}%{phpname}-pecl-Fileinfo
+Obsoletes: %{?scl_prefix}%{phpname}-mhash < 5.3.0
 
 # php53 overlap
+%if 0%{?!scl:1}
 Provides: php53-common
 Obsoletes: php53-common
-Obsoletes: %{phpname}-mhash < 5.3.0
+%endif
 
 %description common
-The %{phpname}-common package contains files used by both the php
-package and the %{phpname}-cli package.
+The %{?scl_prefix}%{phpname}-common package contains files used by both the %{?scl_prefix}%{phpname}
+package and the %{?scl_prefix}%{phpname}-cli package.
 
 %package devel
 Group: Development/Libraries
 Summary: Files needed for building PHP extensions
-Requires: %{phpname}%{?_isa} = %{version}-%{release}, autoconf, automake
-Obsoletes: %{phpname}-pecl-pdo-devel
+Requires: %{?scl_prefix}%{phpname}-cli%{?_isa} = %{version}-%{release}, autoconf, automake
+Obsoletes: %{?scl_prefix}%{phpname}-pecl-pdo-devel
 # php53 overlap
+%if 0%{?!scl:1}
 Obsoletes: php53-devel
-Provides: php-zts-devel = %{version}-%{release}
-Provides: php-zts-devel%{?_isa} = %{version}-%{release}
+%endif
+Provides: %{?scl_prefix}php-zts-devel = %{version}-%{release}
+Provides: %{?scl_prefix}php-zts-devel%{?_isa} = %{version}-%{release}
 
 
 %description devel
-The %{phpname}-devel package contains the files needed for building PHP
+The %{?scl_prefix}%{phpname}-devel package contains the files needed for building PHP
 extensions. If you need to compile your own PHP extensions, you will
 need to install this package.
 
 %package imap
 Summary: A module for PHP applications that use IMAP
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
-Obsoletes: mod_php3-imap, stronghold-php-imap
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+Obsoletes: %{?scl_prefix}mod_php3-imap, %{?scl_prefix}stronghold-php-imap
 BuildRequires: krb5-devel, openssl-devel, libc-client-devel
 # php53 overlap
+%if 0%{?!scl:1}
 Obsoletes: php53-imap
+%endif
 
 %description imap
-The %{phpname}-imap package contains a dynamic shared object (DSO) for the
-Apache Web server. When compiled into Apache, the %{phpname}-imap module will
+The %{?scl_prefix}%{phpname}-imap package contains a dynamic shared object (DSO) for the
+Apache Web server. When compiled into Apache, the %{?scl_prefix}%{phpname}-imap module will
 add IMAP (Internet Message Access Protocol) support to PHP. IMAP is a
 protocol for retrieving and uploading e-mail messages on mail
 servers. PHP is an HTML-embedded scripting language. If you need IMAP
 support for PHP applications, you will need to install this package
-and the php package.
+and the %{?scl_prefix}%{phpname} package.
 
 %package ldap
 Summary: A module for PHP applications that use LDAP
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
-Obsoletes: mod_php3-ldap, stronghold-php-ldap
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+Obsoletes: %{?scl_prefix}mod_php3-ldap, %{?scl_prefix}stronghold-php-ldap
 BuildRequires: cyrus-sasl-devel, openldap-devel, openssl-devel
+%if 0%{?!scl:1}
 Obsoletes: php53-ldap
+%endif
 
 %description ldap
-The %{phpname}-ldap package is a dynamic shared object (DSO) for the Apache
+The %{?scl_prefix}%{phpname}-ldap package is a dynamic shared object (DSO) for the Apache
 Web server that adds Lightweight Directory Access Protocol (LDAP)
 support to PHP. LDAP is a set of protocols for accessing directory
 services over the Internet. PHP is an HTML-embedded scripting
 language. If you need LDAP support for PHP applications, you will
-need to install this package in addition to the php package.
+need to install this package in addition to the %{?scl_prefix}%{phpname} package.
 
 %package pdo
 Summary: A database access abstraction module for PHP applications
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
-Obsoletes: %{phpname}-pecl-pdo-sqlite, %{phpname}-pecl-pdo
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+Obsoletes: %{?scl_prefix}%{phpname}-pecl-pdo-sqlite, %{?scl_prefix}%{phpname}-pecl-pdo
 # Remove this when value change
-Provides: %{phpname}-pdo-abi = %{pdover}
+Provides: %{?scl_prefix}%{phpname}-pdo-abi = %{pdover}
 # New ABI/API check - Arch specific
-Provides: %{phpname}-pdo-abi = %{pdover}%{isasuffix}
-Provides: %{phpname}-sqlite3, %{phpname}-sqlite3%{?_isa}
-Provides: %{phpname}-pdo_sqlite, %{phpname}-pdo_sqlite%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-pdo-abi = %{pdover}%{isasuffix}
+Provides: %{?scl_prefix}%{phpname}-sqlite3, %{?scl_prefix}%{phpname}-sqlite3%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-pdo_sqlite, %{?scl_prefix}%{phpname}-pdo_sqlite%{?_isa}
+%if 0%{?!scl:1}
 Obsoletes: php53-pdo
+%endif
 
 %description pdo
-The %{phpname}-pdo package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-pdo package contains a dynamic shared object that will add
 a database access abstraction layer to PHP.  This module provides
 a common interface for accessing MySQL, PostgreSQL or other 
 databases.
@@ -362,15 +407,17 @@
 Summary: Extension for the SQLite V2 Embeddable SQL Database Engine
 Group: Development/Languages
 BuildRequires: sqlite2-devel >= 2.8.0
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
-Obsoletes: %{phpname}-sqlite2
-Provides: %{phpname}-sqlite2, %{phpname}-sqlite2%{?_isa}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+Obsoletes: %{?scl_prefix}%{phpname}-sqlite2
+Provides: %{?scl_prefix}%{phpname}-sqlite2, %{?scl_prefix}%{phpname}-sqlite2%{?_isa}
 # Plesk dependency
 Provides: any-php-sqlite2
-Provides: %{phpname}-sqlite2 = %{version}-%{release}
-Provides: %{phpname}-sqlite2%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-sqlite2 = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-sqlite2%{?_isa} = %{version}-%{release}
+%if 0%{?!scl:1}
 Obsoletes: php53-sqlite php53-sqlite2
 Provides: php53-sqlite php53-sqlite2
+%endif
 
 
 %description sqlite
@@ -382,108 +429,118 @@
 %package mysql
 Summary: A module for PHP applications that use MySQL databases
 Group: Development/Languages
-Requires: %{phpname}-pdo%{?_isa} = %{version}-%{release}
-Provides: %{phpname}_database
-Provides: %{phpname}-mysqli = %{version}-%{release}
-Provides: %{phpname}-mysqli%{?_isa} = %{version}-%{release}
-Provides: %{phpname}-pdo_mysql, %{phpname}-pdo_mysql%{?_isa}
-Obsoletes: mod_php3-mysql, stronghold-php-mysql
+Requires: %{?scl_prefix}%{phpname}-pdo%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}_database
+Provides: %{?scl_prefix}%{phpname}-mysqli = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-mysqli%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-pdo_mysql, %{?scl_prefix}%{phpname}-pdo_mysql%{?_isa}
+Obsoletes: %{?scl_prefix}mod_php3-mysql, %{?scl_prefix}stronghold-php-mysql
 BuildRequires: mysql-devel >= 4.1.0
+%if 0%{?!scl:1}
 Obsoletes: php53-mysql
-Conflicts: %{phpname}-mysqlnd
+%endif
+Conflicts: %{?scl_prefix}%{phpname}-mysqlnd
 
 
 %description mysql
-The %{phpname}-mysql package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-mysql package contains a dynamic shared object that will add
 MySQL database support to PHP. MySQL is an object-relational database
 management system. PHP is an HTML-embeddable scripting language. If
 you need MySQL support for PHP applications, you will need to install
-this package and the php package.
+this package and the %{?scl_prefix}%{phpname} package.
 
 %package mysqlnd
 Summary: A module for PHP applications that use MySQL databases
 Group: Development/Languages
-Requires: %{phpname}-pdo%{?_isa} = %{version}-%{release}
-Provides: %{phpname}_database
-Provides: %{phpname}-mysql = %{version}-%{release}
-Provides: %{phpname}-mysql%{?_isa} = %{version}-%{release}
-Provides: %{phpname}-mysqli = %{version}-%{release}
-Provides: %{phpname}-mysqli%{?_isa} = %{version}-%{release}
-Provides: %{phpname}-pdo_mysql, %{phpname}-pdo_mysql%{?_isa}
+Requires: %{?scl_prefix}%{phpname}-pdo%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}_database
+Provides: %{?scl_prefix}%{phpname}-mysql = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-mysql%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-mysqli = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-mysqli%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-pdo_mysql, %{?scl_prefix}%{phpname}-pdo_mysql%{?_isa}
 
 %description mysqlnd
-The %{phpname}-mysqlnd package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-mysqlnd package contains a dynamic shared object that will add
 MySQL database support to PHP. MySQL is an object-relational database
 management system. PHP is an HTML-embeddable scripting language. If
 you need MySQL support for PHP applications, you will need to install
-this package and the php package.
+this package and the %{?scl_prefix}%{phpname} package.
 
-This package use the MySQL Native Driver
+This package uses the MySQL Native Driver
 
 
 
 %package pgsql
 Summary: A PostgreSQL database module for PHP
 Group: Development/Languages
-Requires: %{phpname}-pdo%{?_isa} = %{version}-%{release}
-Provides: %{phpname}_database
-Provides: %{phpname}-pdo_pgsql, %{phpname}-pdo_pgsql%{?_isa}
-Obsoletes: mod_php3-pgsql, stronghold-php-pgsql
+Requires: %{?scl_prefix}%{phpname}-pdo%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}_database
+Provides: %{?scl_prefix}%{phpname}-pdo_pgsql, %{?scl_prefix}%{phpname}-pdo_pgsql%{?_isa}
+Obsoletes: %{?scl_prefix}mod_php3-pgsql, %{?scl_prefix}stronghold-php-pgsql
 BuildRequires: krb5-devel, openssl-devel, postgresql-devel
+%if 0%{?!scl:1}
 Obsoletes: php53-pgsql
+%endif
 
 %description pgsql
-The %{phpname}-pgsql package includes a dynamic shared object (DSO) that can
+The %{?scl_prefix}%{phpname}-pgsql package includes a dynamic shared object (DSO) that can
 be compiled in to the Apache Web server to add PostgreSQL database
 support to PHP. PostgreSQL is an object-relational database management
 system that supports almost all SQL constructs. PHP is an
 HTML-embedded scripting language. If you need back-end support for
 PostgreSQL, you should install this package in addition to the main
-php package.
+%{?scl_prefix}%{phpname} package.
 
 %package process
 Summary: Modules for PHP script using system process interfaces
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
-Provides: %{phpname}-posix, %{phpname}-posix%{?_isa}
-Provides: %{phpname}-sysvsem, %{phpname}-sysvsem%{?_isa}
-Provides: %{phpname}-sysvshm, %{phpname}-sysvshm%{?_isa}
-Provides: %{phpname}-sysvmsg, %{phpname}-sysvmsg%{?_isa}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-posix, %{?scl_prefix}%{phpname}-posix%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-sysvsem, %{?scl_prefix}%{phpname}-sysvsem%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-sysvshm, %{?scl_prefix}%{phpname}-sysvshm%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-sysvmsg, %{?scl_prefix}%{phpname}-sysvmsg%{?_isa}
+%if 0%{?!scl:1}
 Obsoletes: php53-process
+%endif
 
 %description process
-The %{phpname}-process package contains dynamic shared objects which add
+The %{?scl_prefix}%{phpname}-process package contains dynamic shared objects which add
 support to PHP using system interfaces for inter-process
 communication.
 
 %package odbc
 Group: Development/Languages
-Requires: %{phpname}-pdo%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-pdo%{?_isa} = %{version}-%{release}
 Summary: A module for PHP applications that use ODBC databases
-Provides: %{phpname}_database
-Provides: %{phpname}-pdo_odbc, %{phpname}-pdo_odbc%{?_isa}
-Obsoletes: stronghold-php-odbc
+Provides: %{?scl_prefix}%{phpname}_database
+Provides: %{?scl_prefix}%{phpname}-pdo_odbc, %{?scl_prefix}%{phpname}-pdo_odbc%{?_isa}
+Obsoletes: %{?scl_prefix}stronghold-php-odbc
 BuildRequires: unixODBC-devel
+%if 0%{?!scl:1}
 Obsoletes: php53-odbc
+%endif
 
 %description odbc
-The %{phpname}-odbc package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-odbc package contains a dynamic shared object that will add
 database support through ODBC to PHP. ODBC is an open specification
 which provides a consistent API for developers to use for accessing
 data sources (which are often, but not always, databases). PHP is an
 HTML-embeddable scripting language. If you need ODBC support for PHP
-applications, you will need to install this package and the php
+applications, you will need to install this package and the %{?scl_prefix}%{phpname}
 package.
 
 %package soap
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 Summary: A module for PHP applications that use the SOAP protocol
 BuildRequires: libxml2-devel
+%if 0%{?!scl:1}
 Obsoletes: php53-soap
+%endif
 
 %description soap
-The %{phpname}-soap package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-soap package contains a dynamic shared object that will add
 support to PHP for using the SOAP web services protocol.
 
 %if %{with_ibase}
@@ -491,13 +548,13 @@
 Summary: 	A module for PHP applications that use Interbase/Firebird databases
 Group: 		Development/Languages
 BuildRequires:  firebird-devel
-Requires:       %{phpname}-pdo%{?_isa} = %{version}-%{release}
-Provides: 	%{phpname}_database
-Provides: 	%{phpname}-firebird, %{phpname}-firebird%{?_isa}
-Provides: 	%{phpname}-pdo_firebird, %{phpname}-pdo_firebird%{?_isa}
+Requires:       %{?scl_prefix}%{phpname}-pdo%{?_isa} = %{version}-%{release}
+Provides:  %{?scl_prefix}%{phpname}_database
+Provides:  %{?scl_prefix}%{phpname}-firebird, %{?scl_prefix}%{phpname}-firebird%{?_isa}
+Provides:  %{?scl_prefix}%{phpname}-pdo_firebird, %{?scl_prefix}%{phpname}-pdo_firebird%{?_isa}
 
 %description interbase
-The %{phpname}-interbase package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-interbase package contains a dynamic shared object that will add
 database support through Interbase/Firebird to PHP.
 
 InterBase is the name of the closed-source variant of this RDBMS that was
@@ -515,28 +572,30 @@
 Summary: 	A module for PHP applications that use OCI8 databases
 Group: 		Development/Languages
 BuildRequires: 	oracle-instantclient-devel >= %{oraclever}
-Requires:       %{phpname}-pdo%{?_isa} = %{version}-%{release}
-Provides: 	%{phpname}_database 
-Provides: 	%{phpname}-pdo_oci = %{oci8ver}, %{phpname}-pdo_oci%{?_isa} = %{oci8ver}
-Provides:       %{phpname}-pecl-oci8 = %{oci8ver}, %{phpname}-pecl-oci8%{?_isa} = %{oci8ver}
-Provides:       %{phpname}-pecl(oci8) = %{oci8ver}, %{phpname}-pecl(oci8)%{?_isa} = %{oci8ver}
+Requires:       %{?scl_prefix}%{phpname}-pdo%{?_isa} = %{version}-%{release}
+Provides:  %{?scl_prefix}%{phpname}_database
+Provides:  %{?scl_prefix}%{phpname}-pdo_oci = %{oci8ver}, %{?scl_prefix}%{phpname}-pdo_oci%{?_isa} = %{oci8ver}
+Provides:       %{?scl_prefix}%{phpname}-pecl-oci8 = %{oci8ver}, %{?scl_prefix}%{phpname}-pecl-oci8%{?_isa} = %{oci8ver}
+Provides:       %{?scl_prefix}%{phpname}-pecl(oci8) = %{oci8ver}, %{?scl_prefix}%{phpname}-pecl(oci8)%{?_isa} = %{oci8ver}
 # Should requires libclntsh.so.11.1, but it's not provided by Oracle RPM.
 AutoReq: 	0
 
 %description oci8
-The %{phpname}-oci8 package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-oci8 package contains a dynamic shared object that will add
 support for accessing OCI8 databases to PHP.
 %endif
 
 %package snmp
 Summary: A module for PHP applications that query SNMP-managed devices
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}, net-snmp
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}, net-snmp
 BuildRequires: net-snmp-devel
+%if 0%{?!scl:1}
 Obsoletes: php53-snmp
+%endif
 
 %description snmp
-The %{phpname}-snmp package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-snmp package contains a dynamic shared object that will add
 support for querying SNMP devices to PHP.  PHP is an HTML-embeddable
 scripting language. If you need SNMP support for PHP applications, you
 will need to install this package and the php package.
@@ -544,44 +603,50 @@
 %package xml
 Summary: A module for PHP applications which use XML
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
-Obsoletes: %{phpname}-domxml, %{phpname}-dom
-Provides: %{phpname}-dom, %{phpname}-dom%{?_isa}
-Provides: %{phpname}-xsl, %{phpname}-xsl%{?_isa}
-Provides: %{phpname}-domxml, %{phpname}-domxml%{?_isa}
-Provides: %{phpname}-wddx, %{phpname}-wddx%{?_isa}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+Obsoletes: %{?scl_prefix}%{phpname}-domxml, %{?scl_prefix}%{phpname}-dom
+Provides: %{?scl_prefix}%{phpname}-dom, %{?scl_prefix}%{phpname}-dom%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-xsl, %{?scl_prefix}%{phpname}-xsl%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-domxml, %{?scl_prefix}%{phpname}-domxml%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-wddx, %{?scl_prefix}%{phpname}-wddx%{?_isa}
 BuildRequires: libxslt-devel >= 1.0.18-1, libxml2-devel >= 2.4.14-1
+%if 0%{?!scl:1}
 Obsoletes: php53-xml
+%endif
 
 %description xml
-The %{phpname}-xml package contains dynamic shared objects which add support
+The %{?scl_prefix}%{phpname}-xml package contains dynamic shared objects which add support
 to PHP for manipulating XML documents using the DOM tree,
 and performing XSL transformations on XML documents.
 
 %package xmlrpc
 Summary: A module for PHP applications which use the XML-RPC protocol
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+%if 0%{?!scl:1}
 Obsoletes: php53-xmlrpc
+%endif
 
 %description xmlrpc
-The %{phpname}-xmlrpc package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-xmlrpc package contains a dynamic shared object that will add
 support for the XML-RPC protocol to PHP.
 
 %package mbstring
 Summary: A module for PHP applications which need multi-byte string handling
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+%if 0%{?!scl:1}
 Obsoletes: php53-mbstring
+%endif
 
 %description mbstring
-The %{phpname}-mbstring package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-mbstring package contains a dynamic shared object that will add
 support for multi-byte string handling to PHP.
 
 %package gd
 Summary: A module for PHP applications for using the gd graphics library
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 # Required to build the bundled GD library
 BuildRequires: libjpeg-devel, libpng-devel, freetype-devel
 %if 0%{?rhel}%{?fedora} > 4
@@ -590,62 +655,68 @@
 BuildRequires: xorg-x11-devel
 %endif
 #php53 overlap
+%if 0%{?!scl:1}
 Obsoletes: php53-gd
+%endif
 
 %description gd
-The %{phpname}-gd package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-gd package contains a dynamic shared object that will add
 support for using the gd graphics library to PHP.
 
 %package bcmath
 Summary: A module for PHP applications for using the bcmath library
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
+%if 0%{?!scl:1}
 Obsoletes: php53-bcmath
+%endif
 
 %description bcmath
-The %{phpname}-bcmath package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-bcmath package contains a dynamic shared object that will add
 support for using the bcmath library to PHP.
 
 %package dba
 Summary: A database abstraction layer module for PHP applications
 Group: Development/Languages
-Requires: %{phpname}-pdo%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-pdo%{?_isa} = %{version}-%{release}
 # php53 overlap
+%if 0%{?!scl:1}
 Obsoletes: php53-dba
+%endif
 
 %description dba
-The %{phpname}-dba package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-dba package contains a dynamic shared object that will add
 support for using the DBA database abstraction layer to PHP.
 
 %package mcrypt
 Summary: Standard PHP module provides mcrypt library support
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 BuildRequires: libmcrypt-devel
 
 %description mcrypt
-The %{phpname}-mcrypt package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-mcrypt package contains a dynamic shared object that will add
 support for using the mcrypt library to PHP.
 
 %package tidy
 Summary: Standard PHP module provides tidy library support
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 BuildRequires: libtidy-devel
 
 %description tidy
-The %{phpname}-tidy package contains a dynamic shared object that will add
-support for using the tidy library to PHP.
+The %{?scl_prefix}%{phpname}-tidy package contains a dynamic shared object that will add
+support for using the tidy library to P%{?scl_prefix}%{phpname}
 
 %package mssql
 Summary: MSSQL database module for PHP
 Group: Development/Languages
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}, %{phpname}-pdo%{?_isa}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}, %{?scl_prefix}%{phpname}-pdo%{?_isa}
 BuildRequires: freetds-devel
-Provides: %{phpname}-pdo_dblib, %{phpname}-pdo_dblib%{?_isa}
+Provides: %{?scl_prefix}%{phpname}-pdo_dblib, %{?scl_prefix}%{phpname}-pdo_dblib%{?_isa}
 
 %description mssql
-The %{phpname}-mssql package contains a dynamic shared object that will
+The %{?scl_prefix}%{phpname}-mssql package contains a dynamic shared object that will
 add MSSQL database support to PHP.  It uses the TDS (Tabular
 DataStream) protocol through the freetds library, hence any
 database server which supports TDS can be accessed.
@@ -653,56 +724,60 @@
 %package embedded
 Summary: PHP library for embedding in applications
 Group: System Environment/Libraries
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 # doing a real -devel package for just the .so symlink is a bit overkill
-Provides: %{phpname}-embedded-devel = %{version}-%{release}
-Provides: %{phpname}-embedded-devel%{?_isa} = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-embedded-devel = %{version}-%{release}
+Provides: %{?scl_prefix}%{phpname}-embedded-devel%{?_isa} = %{version}-%{release}
 
 %description embedded
-The %{phpname}-embedded package contains a library which can be embedded
+The %{?scl_prefix}%{phpname}-embedded package contains a library which can be embedded
 into applications to provide PHP scripting language support.
 
 %package pspell
 Summary: A module for PHP applications for using pspell interfaces
 Group: System Environment/Libraries
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 BuildRequires: aspell-devel >= 0.50.0
+%if 0%{?!scl:1}
 Obsoletes: php53-pspell
+%endif
 
 %description pspell
-The %{phpname}-pspell package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-pspell package contains a dynamic shared object that will add
 support for using the pspell library to PHP.
 
 %package recode
 Summary: A module for PHP applications for using the recode library
 Group: System Environment/Libraries
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 BuildRequires: recode-devel
 
 %description recode
-The %{phpname}-recode package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-recode package contains a dynamic shared object that will add
 support for using the recode library to PHP.
 
 %package intl
 Summary: Internationalization extension for PHP applications
 Group: System Environment/Libraries
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 BuildRequires: libicu-devel >= 3.6
+%if 0%{?!scl:1}
 Obsoletes: php53-intl
+%endif
 
 %description intl
-The %{phpname}-intl package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-intl package contains a dynamic shared object that will add
 support for using the ICU library to PHP.
 
 %if %{with_enchant}
 %package enchant
 Summary: Human Language and Character Encoding Support
 Group: System Environment/Libraries
-Requires: %{phpname}-common%{?_isa} = %{version}-%{release}
+Requires: %{?scl_prefix}%{phpname}-common%{?_isa} = %{version}-%{release}
 BuildRequires: enchant-devel >= 1.2.4
 
 %description enchant
-The %{phpname}-intl package contains a dynamic shared object that will add
+The %{?scl_prefix}%{phpname}-intl package contains a dynamic shared object that will add
 support for using the enchant library to PHP.
 %endif
 
@@ -886,18 +961,18 @@
 	--without-pear \
 	--with-bz2 \
 	--with-exec-dir=%{_bindir} \
-	--with-freetype-dir=%{_prefix} \
-	--with-png-dir=%{_prefix} \
-	--with-xpm-dir=%{_prefix} \
+ --with-freetype-dir=%{_root_prefix} \
+ --with-png-dir=%{_root_prefix} \
+ --with-xpm-dir=%{_root_prefix} \
 	--enable-gd-native-ttf \
 %if 0%{?rhel}%{?fedora} > 4
-	--with-t1lib=%{_prefix} \
+ --with-t1lib=%{_root_prefix} \
 %endif
 	--without-gdbm \
 	--with-gettext \
 	--with-gmp \
 	--with-iconv \
-	--with-jpeg-dir=%{_prefix} \
+ --with-jpeg-dir=%{_root_prefix} \
 	--with-openssl \
         --with-pcre-regex \
 	--with-zlib \
@@ -910,7 +985,7 @@
 	--enable-ucd-snmp-hack \
 	--enable-shmop \
 	--enable-calendar \
-        --with-libxml-dir=%{_prefix} \
+        --with-libxml-dir=%{_root_prefix} \
 	--enable-xml \
 %if %{?fedora}%{?rhel:99} >= 10
         --with-system-tzdata \
@@ -941,7 +1016,7 @@
       --enable-mbregex \
       --with-gd=shared \
       --enable-bcmath=shared \
-      --enable-dba=shared --with-db4=%{_prefix} \
+      --enable-dba=shared --with-db4=%{_root_prefix} \
       --with-xmlrpc=shared \
       --with-ldap=shared --with-ldap-sasl \
       --enable-mysqlnd=shared \
@@ -958,24 +1033,24 @@
       --enable-dom=shared \
       --with-pgsql=shared \
       --enable-wddx=shared \
-      --with-snmp=shared,%{_prefix} \
+      --with-snmp=shared,%{_root_prefix} \
       --enable-soap=shared \
-      --with-xsl=shared,%{_prefix} \
+      --with-xsl=shared,%{_root_prefix} \
       --enable-xmlreader=shared --enable-xmlwriter=shared \
-      --with-curl=shared,%{_prefix} \
+      --with-curl=shared,%{_root_prefix} \
       --enable-fastcgi \
       --enable-pdo=shared \
-      --with-pdo-odbc=shared,unixODBC,%{_prefix} \
+      --with-pdo-odbc=shared,unixODBC,%{_root_prefix} \
       --with-pdo-mysql=shared,mysqlnd \
-      --with-pdo-pgsql=shared,%{_prefix} \
-      --with-pdo-sqlite=shared,%{_prefix} \
-      --with-pdo-dblib=shared,%{_prefix} \
+      --with-pdo-pgsql=shared,%{_root_prefix} \
+      --with-pdo-sqlite=shared,%{_root_prefix} \
+      --with-pdo-dblib=shared,%{_root_prefix} \
 %if 0%{?fedora} >= 9 || 0%{?rhel} >= 6
-      --with-sqlite3=shared,%{_prefix} \
+      --with-sqlite3=shared,%{_root_prefix} \
 %else
       --without-sqlite3 \
 %endif
-      --with-sqlite=shared,%{_prefix} \
+      --with-sqlite=shared,%{_root_prefix} \
       --enable-json=shared \
 %if %{with_zip}
       --enable-zip=shared \
@@ -984,19 +1059,19 @@
       --with-libedit \
       --with-pspell=shared \
       --enable-phar=shared \
-      --with-mcrypt=shared,%{_prefix} \
-      --with-tidy=shared,%{_prefix} \
-      --with-mssql=shared,%{_prefix} \
+      --with-mcrypt=shared,%{_root_prefix} \
+      --with-tidy=shared,%{_root_prefix} \
+      --with-mssql=shared,%{_root_prefix} \
       --enable-sysvmsg=shared --enable-sysvshm=shared --enable-sysvsem=shared \
       --enable-posix=shared \
-      --with-unixODBC=shared,%{_prefix} \
+      --with-unixODBC=shared,%{_root_prefix} \
       --enable-fileinfo=shared \
       --enable-intl=shared \
-      --with-icu-dir=%{_prefix} \
+      --with-icu-dir=%{_root_prefix} \
 %if %{with_enchant}
-      --with-enchant=shared,%{_prefix} \
+      --with-enchant=shared,%{_root_prefix} \
 %endif
-      --with-recode=shared,%{_prefix}
+      --with-recode=shared,%{_root_prefix}
 popd
 
 without_shared="--without-gd \
@@ -1010,13 +1085,13 @@
 
 # Build Apache module, and the CLI SAPI, /usr/bin/php
 pushd build-apache
-build --with-apxs2=%{_sbindir}/apxs \
+build --with-apxs2=%{_root_sbindir}/apxs \
       --libdir=%{_libdir}/%{phpname} \
       --enable-pdo=shared \
-      --with-mysql=shared,%{_prefix} \
+      --with-mysql=shared,%{_root_prefix} \
       --with-mysqli=shared,%{mysql_config} \
       --with-pdo-mysql=shared,%{mysql_config} \
-      --with-pdo-sqlite=shared,%{_prefix} \
+      --with-pdo-sqlite=shared,%{_root_prefix} \
       ${without_shared}
 popd
 
@@ -1046,7 +1121,7 @@
 cp ../ext/sqlite/libsqlite/src/encode.c ext/sqlite/libsqlite/src/
 
 EXTENSION_DIR=%{_libdir}/%{phpname}-zts/modules
-build --with-apxs2=%{_sbindir}/apxs \
+build --with-apxs2=%{_root_sbindir}/apxs \
       --bindir=%{_origbindir}/%{phpname}-zts \
       --includedir=%{_origincludedir}/%{phpname}-zts \
       --libdir=%{_libdir}/%{phpname}-zts \
@@ -1059,7 +1134,7 @@
       --enable-mbregex \
       --with-gd=shared \
       --enable-bcmath=shared \
-      --enable-dba=shared --with-db4=%{_prefix} \
+      --enable-dba=shared --with-db4=%{_root_prefix} \
       --with-xmlrpc=shared \
       --with-ldap=shared --with-ldap-sasl \
       --enable-mysqlnd=shared \
@@ -1077,24 +1152,24 @@
       --enable-dom=shared \
       --with-pgsql=shared \
       --enable-wddx=shared \
-      --with-snmp=shared,%{_prefix} \
+      --with-snmp=shared,%{_root_prefix} \
       --enable-soap=shared \
-      --with-xsl=shared,%{_prefix} \
+      --with-xsl=shared,%{_root_prefix} \
       --enable-xmlreader=shared --enable-xmlwriter=shared \
-      --with-curl=shared,%{_prefix} \
+      --with-curl=shared,%{_root_prefix} \
       --enable-fastcgi \
       --enable-pdo=shared \
-      --with-pdo-odbc=shared,unixODBC,%{_prefix} \
+      --with-pdo-odbc=shared,unixODBC,%{_root_prefix} \
       --with-pdo-mysql=shared,mysqlnd \
-      --with-pdo-pgsql=shared,%{_prefix} \
-      --with-pdo-sqlite=shared,%{_prefix} \
-      --with-pdo-dblib=shared,%{_prefix} \
+      --with-pdo-pgsql=shared,%{_root_prefix} \
+      --with-pdo-sqlite=shared,%{_root_prefix} \
+      --with-pdo-dblib=shared,%{_root_prefix} \
 %if 0%{?fedora} >= 9 || 0%{?rhel} >= 6
-      --with-sqlite3=shared,%{_prefix} \
+      --with-sqlite3=shared,%{_root_prefix} \
 %else
       --without-sqlite3 \
 %endif
-      --with-sqlite=shared,%{_prefix} \
+      --with-sqlite=shared,%{_root_prefix} \
       --enable-json=shared \
 %if %{with_zip}
       --enable-zip=shared \
@@ -1103,19 +1178,19 @@
       --with-libedit \
       --with-pspell=shared \
       --enable-phar=shared \
-      --with-mcrypt=shared,%{_prefix} \
-      --with-tidy=shared,%{_prefix} \
-      --with-mssql=shared,%{_prefix} \
+      --with-mcrypt=shared,%{_root_prefix} \
+      --with-tidy=shared,%{_root_prefix} \
+      --with-mssql=shared,%{_root_prefix} \
       --enable-sysvmsg=shared --enable-sysvshm=shared --enable-sysvsem=shared \
       --enable-posix=shared \
-      --with-unixODBC=shared,%{_prefix} \
+      --with-unixODBC=shared,%{_root_prefix} \
       --enable-fileinfo=shared \
       --enable-intl=shared \
-      --with-icu-dir=%{_prefix} \
+      --with-icu-dir=%{_root_prefix} \
 %if %{with_enchant}
-      --with-enchant=shared,%{_prefix} \
+      --with-enchant=shared,%{_root_prefix} \
 %endif
-      --with-recode=shared,%{_prefix}
+      --with-recode=shared,%{_root_prefix}
 popd
 
 ### NOTE!!! EXTENSION_DIR was changed for the -zts build, so it must remain
@@ -1186,7 +1261,7 @@
 # Install the default configuration file and icons
 install -m 755 -d $RPM_BUILD_ROOT%{_sysconfdir}/
 #install -m 644 %{SOURCE2} $RPM_BUILD_ROOT%{_sysconfdir}/php.ini
-%{__sed} -e '/session.save_path/s/php/%{phpname}/' %{SOURCE2} >$RPM_BUILD_ROOT%{_sysconfdir}/php.ini
+%{__sed} -e 's|/var/lib/php/session|%{_localstatedir}/lib/%{phpname}/session|' %{SOURCE2} >$RPM_BUILD_ROOT%{_sysconfdir}/php.ini
 install -m 755 -d $RPM_BUILD_ROOT%{contentdir}/icons
 install -m 644 php.gif $RPM_BUILD_ROOT%{contentdir}/icons/%{phpname}.gif
 
@@ -1194,27 +1269,40 @@
 install -m 755 -d $RPM_BUILD_ROOT%{_datadir}/%{phpname}
 
 # install the DSO
-install -m 755 -d $RPM_BUILD_ROOT%{_libdir}/httpd/modules
+install -m 755 -d $RPM_BUILD_ROOT%{_httpd_moddir}
 %if %{phpname} == php
-install -m 755 build-apache/libs/libphp5.so $RPM_BUILD_ROOT%{_libdir}/httpd/modules
+install -m 755 build-apache/libs/libphp5.so $RPM_BUILD_ROOT%{_httpd_moddir}
 %else
-install -m 755 build-apache/libs/libphp5.so $RPM_BUILD_ROOT%{_libdir}/httpd/modules/lib%{phpname}.so
+install -m 755 build-apache/libs/libphp5.so $RPM_BUILD_ROOT%{_httpd_moddir}/lib%{phpname}.so
 %endif
 
 # install the ZTS DSO
 %if %{phpname} == php
-install -m 755 build-zts/libs/libphp5.so $RPM_BUILD_ROOT%{_libdir}/httpd/modules/libphp5-zts.so
+install -m 755 build-zts/libs/libphp5.so $RPM_BUILD_ROOT%{_httpd_moddir}/libphp5-zts.so
 %else
-install -m 755 build-zts/libs/libphp5.so $RPM_BUILD_ROOT%{_libdir}/httpd/modules/lib%{phpname}-zts.so
+install -m 755 build-zts/libs/libphp5.so $RPM_BUILD_ROOT%{_httpd_moddir}/lib%{phpname}-zts.so
 %endif
 
 # Apache config fragment
-install -m 755 -d $RPM_BUILD_ROOT/%{_origsysconfdir}/httpd/conf.d
+install -m 755 -d $RPM_BUILD_ROOT/%{_httpd_confdir}
 %if %{phpname} == php
-install -m 644 %{SOURCE1} $RPM_BUILD_ROOT/%{_origsysconfdir}/httpd/conf.d
+install -m 644 %{SOURCE1} $RPM_BUILD_ROOT/%{_httpd_confdir}/%{?scl_prefix}php.conf
 %else
 %{__sed} -e s'/libphp5/lib%{phpname}/' %{SOURCE1} \
-  >$RPM_BUILD_ROOT/%{_origsysconfdir}/httpd/conf.d/%{phpname}.conf
+  >$RPM_BUILD_ROOT/%{_httpd_confdir}/%{?scl_prefix}%{phpname}.conf
+%endif
+
+# Symlink SCL DSOs into real httpd moddir, mod_php config into real httpd config directory
+%if %{?scl:1}0
+install -m 755 -d $RPM_BUILD_ROOT%{_root_httpd_moddir}
+install -m 755 -d $RPM_BUILD_ROOT%{_httpd_confdir}
+%if %{phpname} == php
+ln -s %{_httpd_moddir}/libphp5.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/libphp5.so
+ln -s %{_httpd_moddir}/libphp5-zts.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/libphp5-zts.so
+%else
+ln -s %{_httpd_moddir}/libphp5.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/lib%{phpname}.so
+ln -s %{_httpd_moddir}/libphp5-zts.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/lib%{phpname}-zts.so
+%endif
 %endif
 
 install -m 755 -d $RPM_BUILD_ROOT%{_sysconfdir}/php.d
@@ -1229,25 +1317,47 @@
 install -m 755 -d $RPM_BUILD_ROOT%{_localstatedir}/run/php-fpm
 # Config
 install -m 755 -d $RPM_BUILD_ROOT%{_origsysconfdir}/php-fpm.d
-install -m 644 %{SOURCE4} $RPM_BUILD_ROOT%{_sysconfdir}/php-fpm.conf
+install -m 644 %{SOURCE4} $RPM_BUILD_ROOT%{_sysconfdir}/%{phpname}-fpm.conf
+sed -e 's:/var:%{_localstatedir}:' \
+    -e 's:/etc:%{_sysconfdir}:' \
+    -i $RPM_BUILD_ROOT%{_sysconfdir}/%{phpname}-fpm.conf
 install -m 644 %{SOURCE5} $RPM_BUILD_ROOT%{_origsysconfdir}/php-fpm.d/www.conf
+sed -e 's:/var:%{_localstatedir}:' \
+    -i $RPM_BUILD_ROOT%{_origsysconfdir}/php-fpm.d/www.conf
 mv $RPM_BUILD_ROOT%{_sysconfdir}/php-fpm.conf.default .
 # Service
-install -m 755 -d $RPM_BUILD_ROOT%{_originitdir}
-install -m 755 %{SOURCE6} $RPM_BUILD_ROOT%{_originitdir}/php-fpm
+install -m 755 -d $RPM_BUILD_ROOT%{_root_initddir}
+install -m 755 %{SOURCE6} $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
+sed -e '/daemon/s:php-fpm:/usr/sbin/php-fpm:' \
+    -i $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
+sed -e '/php-fpm.pid/s:/var:%{_localstatedir}:' \
+    -e '/subsys/s/php-fpm/%{?scl_prefix}%{phpname}-fpm/' \
+    -e 's:/etc/sysconfig/php-fpm:%{_sysconfdir}/sysconfig/%{phpname}-fpm:' \
+    -e 's:/etc/php-fpm.conf:%{_sysconfdir}/%{phpname}-fpm.conf:' \
+    -e 's:/usr/sbin:%{_sbindir}:' \
+    -i $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
 # LogRotate
-install -m 755 -d $RPM_BUILD_ROOT%{_origsysconfdir}/logrotate.d
-install -m 644 %{SOURCE7} $RPM_BUILD_ROOT%{_origsysconfdir}/logrotate.d/php-fpm
+install -m 755 -d $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d
+install -m 644 %{SOURCE7} $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d/%{?scl_prefix}%{phpname}-fpm
+sed -e 's:/var:%{_localstatedir}:' \
+    -i $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d/%{?scl_prefix}%{phpname}-fpm
 %if 0%{?fedora} >= 15
 # tmpfiles.d
 install -m 755 -d $RPM_BUILD_ROOT%{_sysconfdir}/tmpfiles.d
-install -m 644 php-fpm.tmpfiles $RPM_BUILD_ROOT%{_sysconfdir}/tmpfiles.d/php-fpm.conf
+install -m 644 php-fpm.tmpfiles $RPM_BUILD_ROOT%{_sysconfdir}/tmpfiles.d/%{?scl_prefix}%{phpname}-fpm.conf
 %endif
 %endif
 
 # Fix the link
 (cd $RPM_BUILD_ROOT%{_bindir}; ln -sfn phar.phar phar)
 
+# make the cli commands available in standard root for SCL build
+%if 0%{?scl:1}
+install -m 755 -d $RPM_BUILD_ROOT%{_root_bindir}
+ln -s %{_bindir}/php       $RPM_BUILD_ROOT%{_root_bindir}/%{?scl_prefix}php
+ln -s %{_bindir}/phar.phar $RPM_BUILD_ROOT%{_root_bindir}/%{?scl_prefix}phar
+%endif
+
 # Generate files lists and stub .ini files for each subpackage
 for mod in pgsql mysql mysqli odbc ldap snmp xmlrpc imap \
     mysqlnd mysqlnd_mysql mysqlnd_mysqli pdo_mysqlnd \
@@ -1330,14 +1440,20 @@
 %endif
 
 # Install the macros file:
-install -d $RPM_BUILD_ROOT%{_origsysconfdir}/rpm
 sed -e "s/@PHP_APIVER@/%{apiver}%{isasuffix}/" \
     -e "s/@PHP_ZENDVER@/%{zendver}%{isasuffix}/" \
     -e "s/@PHP_PDOVER@/%{pdover}%{isasuffix}/" \
     -e "s/@PHPNAME@/%{phpname}/" \
     < %{SOURCE3} > macros.php
+%if 0%{?scl:1}
+install -d $RPM_BUILD_ROOT%{_root_sysconfdir}/rpm
+install -m 644 -c macros.php \
+           $RPM_BUILD_ROOT%{_root_sysconfdir}/rpm/macros.%{?scl_prefix}%{phpname}
+%else
+install -d $RPM_BUILD_ROOT%{_origsysconfdir}/rpm
 install -m 644 -c macros.php \
-           $RPM_BUILD_ROOT%{_origsysconfdir}/rpm/macros.%{phpname}
+           $RPM_BUILD_ROOT%{_origsysconfdir}/rpm/macros.%{?scl_prefix}%{phpname}
+%endif
 
 # Remove unpackaged files
 rm -rf $RPM_BUILD_ROOT%{_libdir}/%{phpname}/modules/*.a \
@@ -1356,12 +1472,12 @@
 
 %if %{with_fpm}
 %post fpm
-/sbin/chkconfig --add php-fpm
+/sbin/chkconfig --add %{?scl_prefix}%{phpname}-fpm
 
 %preun fpm
 if [ "$1" = 0 ] ; then
-    /sbin/service php-fpm stop >/dev/null 2>&1
-    /sbin/chkconfig --del php-fpm
+    /sbin/service %{?scl_prefix}%{phpname}-fpm stop >/dev/null 2>&1
+    /sbin/chkconfig --del %{?scl_prefix}%{phpname}-fpm
 fi
 %endif
 
@@ -1371,14 +1487,19 @@
 %files
 %defattr(-,root,root)
 %if %{phpname} == php
-%{_libdir}/httpd/modules/libphp5.so
-%{_libdir}/httpd/modules/libphp5-zts.so
+%{?scl: %dir %{_httpd_moddir}}
+%{_httpd_moddir}/libphp5.so
+%{?scl: %{_root_httpd_moddir}/libphp5.so}
+%{_httpd_moddir}/libphp5-zts.so
+%{?scl: %{_root_httpd_moddir}/libphp5-zts.so}
 %else
-%{_libdir}/httpd/modules/lib%{phpname}.so
-%{_libdir}/httpd/modules/lib%{phpname}-zts.so
+%{_httpd_moddir}/lib%{phpname}.so
+%{?scl: %{_root_httpd_moddir}/lib%{phpname}.so}
+%{_httpd_moddir}/lib%{phpname}-zts.so
+%{?scl: %{_root_httpd_moddir}/lib%{phpname}-zts.so}
 %endif
 %attr(0770,root,apache) %dir %{_localstatedir}/lib/%{phpname}/session
-%config(noreplace) %{_origsysconfdir}/httpd/conf.d/%{phpname}.conf
+%config(noreplace) %{_httpd_confdir}/%{?scl_prefix}%{phpname}.conf
 %{contentdir}/icons/%{phpname}.gif
 
 %files common -f files.common
@@ -1412,22 +1533,24 @@
 %exclude %{_mandir}/man1/phpize.1*
 %endif
 %doc sapi/cgi/README* sapi/cli/README
+%{?scl: %{_root_bindir}/%{?scl_prefix}php}
+%{?scl: %{_root_bindir}/%{?scl_prefix}phar}
 
 %if %{with_fpm}
 %files fpm
 %defattr(-,root,root)
 %doc php-fpm.conf.default
-%config(noreplace) %{_sysconfdir}/php-fpm.conf
+%config(noreplace) %{_sysconfdir}/%{phpname}-fpm.conf
 %config(noreplace) %{_origsysconfdir}/php-fpm.d/www.conf
-%config(noreplace) %{_origsysconfdir}/logrotate.d/php-fpm
+%config(noreplace) %{_root_sysconfdir}/logrotate.d/%{?scl_prefix}%{phpname}-fpm
 %if 0%{?fedora} >= 15
-%config(noreplace) %{_sysconfdir}/tmpfiles.d/php-fpm.conf
+%config(noreplace) %{_sysconfdir}/tmpfiles.d/%{?scl_prefix}%{phpname}-fpm.conf
 %endif
 %{_sbindir}/php-fpm
-%{_originitdir}/php-fpm
-%dir %{_origsysconfdir}/php-fpm.d
+%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
 # log owned by apache for log
 %attr(770,apache,apache) %dir %{_localstatedir}/log/php-fpm
+%attr(0770,root,apache) %dir %{_localstatedir}/lib/%{phpname}/session
 %dir %{_localstatedir}/run/php-fpm
 %{_mandir}/man8/php-fpm.8*
 %{_datadir}/fpm/status.html
@@ -1448,7 +1571,11 @@
 %else
 %exclude %{_mandir}/man1/php-config.1*
 %endif
-%config %{_origsysconfdir}/rpm/macros.%{phpname}
+%if 0%{?scl:1}
+%config %{_root_sysconfdir}/rpm/macros.%{?scl_prefix}%{phpname}
+%else
+%config %{_origsysconfdir}/rpm/macros.%{?scl_prefix}%{phpname}
+%endif
 
 %files embedded
 %defattr(-,root,root,-)
