
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>alanthing</title>
  <meta name="author" content="Alan Ivey">

  
  <meta name="description" content="If you have a Yubikey with U2F support for Linux, you can use its U2F functionality for a 2nd factor or single factor for logins, sudo passwords, and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alanthing.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="alanthing" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34327970-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">alanthing</a></h1>
  
    <h2>Linux and other things</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alanthing.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/03/yubikey-login-fedora-u2f-authselect/">Yubikey Login to Fedora With U2F via Authselect</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-02-03T16:54:00-05:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2019</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you have a <a href="https://support.yubico.com/support/solutions/articles/15000011356-ubuntu-linux-login-guide-u2f#Applicable_Productsb6c8j5">Yubikey with U2F support for Linux</a>, you can use its U2F functionality for a 2nd factor or single factor for logins, sudo passwords, and more. This is accomplished by the <a href="https://developers.yubico.com/pam-u2f/">pam-u2f</a> module, and the instructions commonly returned in searches aren&rsquo;t for the faint of heart, especially when get into editing the files in <em>/etc/pam.d/</em>. Recent versions of <a href="https://fedoraproject.org/wiki/Changes/Authselect">Fedora ship with <code>authselect</code></a> which can make this process a lot easier. U2F support isn&rsquo;t baked in,s but it&rsquo;s easy enough to find on GitHub. Grab your Yubikey<u>s</u> <em>(you do have a primary and a backup, right?)</em> and follow along.</p>

<p>The main packages required are <code>authselect</code>, <code>pam-u2f</code>, and <code>pamu2fcfg</code>. The following will cover the bases in case you have a minimal install:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dnf install authselect bash gawk pam pam-u2f pamu2fcfg sssd systemd-udev
</span></code></pre></td></tr></table></div></figure>


<p>Create the <em>u2f_keys</em> file and include values from as many U2F devices as applicable (<a href="https://wiki.gentoo.org/wiki/Pam_u2f#Registration">additional background here</a>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># pam-u2f looks in this directory</span>
</span><span class='line'>mkdir -pv ~/.config/Yubico/
</span><span class='line'>
</span><span class='line'>pamu2fcfg --username<span class="o">=</span><span class="s2">&quot;$USER&quot;</span> | tee ~/.config/Yubico/u2f_keys ; <span class="nb">echo</span>
</span><span class='line'><span class="c"># touch device</span>
</span><span class='line'>
</span><span class='line'>pamu2fcfg --nouser | tee -a ~/.config/Yubico/u2f_keys ; <span class="nb">echo</span>
</span><span class='line'><span class="c"># touch 2nd device</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Repeat the previous command as necessary</span>
</span></code></pre></td></tr></table></div></figure>


<p>Grab a udev rules file to allow access for non-root users (<a href="https://support.yubico.com/support/solutions/articles/15000006449-using-your-u2f-yubikey-with-linux">additional background here</a>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl <span class="se">\</span>
</span><span class='line'>  --output <span class="s1">&#39;/etc/udev/rules.d/70-u2f.rules&#39;</span> <span class="se">\</span>
</span><span class='line'>  <span class="s1">&#39;https://raw.githubusercontent.com/Yubico/libu2f-host/master/70-u2f.rules&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Take effect without reboot:</span>
</span><span class='line'>udevadm trigger
</span></code></pre></td></tr></table></div></figure>


<p>With <code>pam-u2f</code> installed and the keys added in <em>u2f_keys</em>, the final step is adding configurations to files in <em>/etc/pam.d/</em>; thankfully <a href="https://github.com/pbrezina/authselect">authselect</a> makes this less intimidating. The version that ships with Fedora 29 (as of this writing) does not include the U2F option, so we&rsquo;ll create a custom profile based on <em>sssd</em> and grab the files from GitHub. Uncomment the <code>diff</code> command to see how minimal the changes are that we are getting:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Create a profile based on the built-in &quot;sssd&quot; and use symlinks for the files we won&#39;t</span>
</span><span class='line'><span class="c"># be changing</span>
</span><span class='line'>authselect <span class="se">\</span>
</span><span class='line'>  create-profile <span class="se">\</span>
</span><span class='line'>  <span class="s1">&#39;sssd-u2f&#39;</span> <span class="se">\</span>
</span><span class='line'>  --base-on<span class="o">=</span>sssd <span class="se">\</span>
</span><span class='line'>  --symlink-nsswitch <span class="se">\</span>
</span><span class='line'>  --symlink-dconf <span class="se">\</span>
</span><span class='line'>  --symlink<span class="o">=</span>fingerprint-auth <span class="se">\</span>
</span><span class='line'>  --symlink<span class="o">=</span>postlogin <span class="se">\</span>
</span><span class='line'>  --symlink<span class="o">=</span>smartcard-auth
</span><span class='line'>
</span><span class='line'><span class="c"># Grab 4 updated files from GitHub. Uncomment `diff` to see the changes from the &quot;sssd&quot;</span>
</span><span class='line'><span class="c"># profile</span>
</span><span class='line'><span class="k">for </span>FILE in README REQUIREMENTS password-auth system-auth; <span class="k">do</span>
</span><span class='line'><span class="k">  </span>curl <span class="se">\</span>
</span><span class='line'>    --silent <span class="se">\</span>
</span><span class='line'>    --output <span class="s2">&quot;/etc/authselect/custom/sssd-u2f/$FILE&quot;</span> <span class="se">\</span>
</span><span class='line'>    <span class="s2">&quot;https://raw.githubusercontent.com/pbrezina/authselect/297f48d/profiles/sssd/$FILE&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># diff \</span>
</span><span class='line'>  <span class="c">#   --ignore-all-space \</span>
</span><span class='line'>  <span class="c">#   --unified \</span>
</span><span class='line'>  <span class="c">#   &quot;/usr/share/authselect/default/sssd/$FILE&quot; \</span>
</span><span class='line'>  <span class="c">#   &quot;/etc/authselect/custom/sssd-u2f/$FILE&quot;</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Capture the options your current authselect profile might be using. My system had</span>
</span><span class='line'><span class="c"># &quot;with-fingerprint&quot; and &quot;with-silent-lastlog&quot; after a standard Fedora 29 install</span>
</span><span class='line'>mapfile -t AUTHSELECT_CURRENT_OPTIONS &lt; &lt;<span class="o">(</span> authselect current | awk <span class="s1">&#39;/^- with-/ {gsub(&quot;^- &quot;, &quot;&quot;); print $0}&#39;</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># If you want, show the captured options, which might be blank</span>
</span><span class='line'><span class="c">#printf &#39;%s\n&#39; &quot;${AUTHSELECT_CURRENT_OPTIONS[@]}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Select the custom &quot;sssd-u2f&quot; profile and add the &quot;with-pam-u2f&quot; option</span>
</span><span class='line'>authselect <span class="se">\</span>
</span><span class='line'>  <span class="k">select</span> <span class="se">\</span>
</span><span class='line'>  <span class="s1">&#39;custom/sssd-u2f&#39;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">$(</span> <span class="nb">printf</span> <span class="s1">&#39;%s &#39;</span> <span class="s2">&quot;${AUTHSELECT_CURRENT_OPTIONS[@]}&quot;</span> <span class="k">)</span> <span class="se">\</span>
</span><span class='line'>  <span class="s1">&#39;with-pam-u2f&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>On my system, I was able to use my Yubikey&rsquo;s U2F mode to login after a reboot with Gnome, and for issuing <code>sudo</code>. To make the U2F required as part of a two-factor login or similar, you&rsquo;ll need to dig into the <em>/etc/pam.d/</em> files. Rather than edit directly, edit the files in <em>/etc/authselect/custom/sssd-u2f/</em> and apply with <code>authselect</code>.</p>

<p>For some further reading, the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8-beta/html/installing_identity_management_and_access_control/using-authselect">RHEL 8 Beta page on authselect</a> has a ton of great information. I&rsquo;m glad to see <code>authselect</code> will make it from Fedora to RHEL!</p>

<p><em>(I haven&rsquo;t used Fedora 29 as a desktop for long, so please let me know <a href="https://twitter.com/alanthing">@alanthing</a> if you have any feedback!)</em></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/20/certbot-on-centos-6/">Certbot on CentOS 6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-20T20:32:00-04:00" pubdate data-updated="true">Sep 20<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>CentOS 6 is getting updates through <a href="https://wiki.centos.org/FAQ/General#head-fe8a0be91ee3e7dea812e8694491e1dde5b75e6d">November 30, 2020</a>, but it&rsquo;s getting more and more difficult to find newer packages for the operating system. If you want to use <a href="https://certbot.eff.org">Certbot</a> for obtaining and renewing <a href="https://letsencrypt.org">Let&rsquo;s Encrypt</a> TLS certificates, you can use <a href="https://certbot.eff.org/#centos6-other">certbot-auto</a> and let it handle the work for you, but I wanted to try only <a href="https://pypi.python.org/pypi/certbot/">the PyPi package</a> via pip.</p>

<p><em>Note:</em> I&rsquo;m using Docker to test these commands via: <code>docker run --rm -it centos:6 bash</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># No Python wheels available, so we need gcc and some devel packages
</span><span class='line'>$ yum install gcc libffi-devel openssl-devel python-devel python-pip
</span><span class='line'>
</span><span class='line'># Let's try and install certbot
</span><span class='line'>$ pip install --upgrade certbot
</span><span class='line'>...snip...
</span><span class='line'>Successfully installed ConfigArgParse-0.12.0 PyOpenSSL-17.3.0 acme-0.18.2 certbot-0.18.2 cffi-1.11.0 configobj-5.0.6 cryptography-2.0.3 funcsigs-1.0.2 mock-2.0.0 pbr-3.1.1 pyrfc3339-1.0 requests-2.18.4 zope.component-4.4.0 zope.event-4.3.0</span></code></pre></td></tr></table></div></figure>


<p>Seemed to work, right? Nope ðŸ˜ :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ certbot --help
</span><span class='line'>Traceback (most recent call last):
</span><span class='line'>  File "/usr/bin/certbot", line 7, in &lt;module&gt;
</span><span class='line'>    from certbot.main import main
</span><span class='line'>  File "/usr/lib/python2.6/site-packages/certbot/main.py", line 7, in &lt;module&gt;
</span><span class='line'>    import zope.component
</span><span class='line'>  File "/usr/lib/python2.6/site-packages/zope/component/__init__.py", line 28, in &lt;module&gt;
</span><span class='line'>    from zope.component.globalregistry import getGlobalSiteManager
</span><span class='line'>  File "/usr/lib/python2.6/site-packages/zope/component/globalregistry.py", line 18, in &lt;module&gt;
</span><span class='line'>    from zope.interface.registry import Components
</span><span class='line'>  File "/usr/lib64/python2.6/site-packages/zope/interface/registry.py", line 167
</span><span class='line'>    filtered_state = {k: v for k, v in reduction[2].items()
</span><span class='line'>                             ^
</span><span class='line'>SyntaxError: invalid syntax</span></code></pre></td></tr></table></div></figure>


<p><a href="https://stackoverflow.com/q/345356/534275">Of course this doesn&rsquo;t work</a>, it&rsquo;s Python <strong>2.6</strong>!</p>

<p><a href="https://wiki.centos.org/AdditionalResources/Repositories/SCL">Software Collections</a>, to the rescue! Let&rsquo;s use the Python 2.7 SCL and try again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Install the SCL Yum repo files
</span><span class='line'>$ yum install centos-release-scl
</span><span class='line'>
</span><span class='line'># Grab Python 2.7, pip, and related depedencies
</span><span class='line'>$ yum install python27-python-pip
</span><span class='line'>
</span><span class='line'># Install into the SCL root with pip. Wheels are available, so no compiler or devel packages necessary!
</span><span class='line'>$ scl enable python27 'pip install certbot'
</span><span class='line'>...snip...
</span><span class='line'>Successfully installed ConfigArgParse-0.12.0 PyOpenSSL-17.3.0 acme-0.18.2 asn1crypto-0.22.0 certbot-0.18.2 certifi-2017.7.27.1 cffi-1.11.0 chardet-3.0.4 configobj-5.0.6 cryptography-2.0.3 enum34-1.1.6 funcsigs-1.0.2 future-0.16.0 idna-2.6 ipaddress-1.0.18 mock-2.0.0 parsedatetime-2.4 pbr-3.1.1 pycparser-2.18 pyrfc3339-1.0 pytz-2017.2 requests-2.18.4 setuptools-36.5.0 six-1.11.0 urllib3-1.22 zope.component-4.4.0 zope.event-4.3.0 zope.interface-4.4.2</span></code></pre></td></tr></table></div></figure>


<p>Success! Right?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ certbot --help
</span><span class='line'>bash: certbot: command not found</span></code></pre></td></tr></table></div></figure>


<p>Hrm, what happened?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ find /opt/rh/python27/ -name certbot -executable
</span><span class='line'>/opt/rh/python27/root/usr/bin/certbot
</span><span class='line'>/opt/rh/python27/root/usr/lib/python2.7/site-packages/certbot</span></code></pre></td></tr></table></div></figure>


<p>Right, it&rsquo;s in the SCL. You have some options. You could <a href="https://access.redhat.com/solutions/527703">enable the SCL in userspace</a> through commands like <code>source scl_source enable python27</code> or <code>scl enable python27 bash</code>. Or, because I want to use <code>certbot</code> interactively and in crons without thinking about the SCL, we can use a &ldquo;shim&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /usr/local/bin/certbot &lt;&lt;'EOF'
</span><span class='line'>#!/bin/bash
</span><span class='line'>source scl_source enable python27
</span><span class='line'>certbot "$@"
</span><span class='line'>EOF
</span><span class='line'>$ chmod -c 755 /usr/local/bin/certbot</span></code></pre></td></tr></table></div></figure>


<p>Assuming <code>/usr/local/bin/</code> is in your <code>$PATH</code>, we can test this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ certbot register --agree-tos -m 'le@example.com' -n
</span><span class='line'>Saving debug log to /var/log/letsencrypt/letsencrypt.log
</span><span class='line'>
</span><span class='line'>IMPORTANT NOTES:
</span><span class='line'> - Your account credentials have been saved in your Certbot
</span><span class='line'>   configuration directory at /etc/letsencrypt. You should make a
</span><span class='line'>   secure backup of this folder now. This configuration directory will
</span><span class='line'>   also contain certificates and private keys obtained by Certbot so
</span><span class='line'>   making regular backups of this folder is ideal.
</span><span class='line'>
</span><span class='line'>$ find /etc/letsencrypt \! -type d
</span><span class='line'>/etc/letsencrypt/accounts/acme-v01.api.letsencrypt.org/directory/a1b2c3d4e5f6a7b8a1b2c3d4e5f6a7b8/meta.json
</span><span class='line'>/etc/letsencrypt/accounts/acme-v01.api.letsencrypt.org/directory/a1bx2c3d4e5f6a7b8a1b2c3d4e5f6a7b8/regr.json
</span><span class='line'>/etc/letsencrypt/accounts/acme-v01.api.letsencrypt.org/directory/a1b2c3d4e5f6a7b8a1b2c3d4e5f6a7b8/private_key.json</span></code></pre></td></tr></table></div></figure>


<p>Now you have <code>certbot</code> on CentOS 6 from PyPi and without <code>certbot-auto</code> (Nothing wrong with <code>certbot-auto</code>, I just prefer to have more control over the installation process). Let me know how it goes for you!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/06/21/python-3-and-uwsgi-on-centos-7/">Python 3 and uWSGI on CentOS 7</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-06-21T07:04:00-04:00" pubdate data-updated="true">Jun 21<span>st</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Wherever I can, I avoid compiling applications from source or packaging up my own versions of things that exist in popular repositories. I recently needed to run a Python 3 application via uWSGI on CentOS 7 and was frustrated at how many search results were recommending building uWSGI from source when it&rsquo;s <a href="https://dl.fedoraproject.org/pub/epel/7/x86_64/u/">available in EPEL</a>. I&rsquo;ve only deployed a handful of Python applications, and was not interested in keeping up with source-compiled dependencies to support this small project over time. We&rsquo;ll discuss a couple of different ways to run these programs together with minimal customization.</p>

<h1>Python 3.4</h1>

<p>In CentOS 7, you can run Python 3.4 alongside Python 2.7 as it is available in <a href="https://dl.fedoraproject.org/pub/epel/7/x86_64/p/">EPEL</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rpm -q epel-release <span class="o">||</span> yum -q -y install epel-release
</span><span class='line'>
</span><span class='line'>yum -y install python34
</span></code></pre></td></tr></table></div></figure>


<h2>pip</h2>

<p>If you want to install <a href="https://pip.pypa.io">pip</a>, simply <code>yum install python34-pip</code> and it will install at <code>/usr/bin/pip3</code> and <code>/usr/bin/pip3.4</code>, leaving <code>/usr/bin/pip</code> alone as that is part of the <code>python2-pip</code> package. This was only available recently (late 2016); previously you had to manually install and deal with <code>/usr/bin/pip</code> being overwritten.</p>

<h2>Virtual Environments</h2>

<p>Since 3.3, Python supports creating virtual environments without an external module like <code>virtualenv</code>. <code>pyvenv</code> was the &ldquo;recommended tool&rdquo; for this initially, though it <a href="https://docs.python.org/dev/whatsnew/3.6.html#id8">is deprecated in Python 3.6</a>. As such, to lean into the preferred Python nomenclature, you can use the <a href="https://docs.python.org/3/library/venv.html">venv module</a> directly to create Python 3.4 virtual environments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python3.4 -m venv /path/to/venv34dirname
</span><span class='line'>
</span><span class='line'><span class="nb">source</span> /path/to/venv34dirname/bin/activate
</span></code></pre></td></tr></table></div></figure>


<p>If you like using <a href="https://virtualenv.pypa.io">virtualenv</a>, you&rsquo;ll be disappointed to see that there is no <code>python34-virtualenv</code> package available in EPEL. While you could <code>pip3 install virtualenv</code>, that would install at <code>/usr/bin/virtualenv</code>, potentially overwriting the same file provided by the <code>python-virtualenv</code> package. But, if you do, consider the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Install virtualenv with the pip provided the &#39;python34&#39; package:</span>
</span><span class='line'>pip3 install virtualenv
</span><span class='line'>
</span><span class='line'><span class="c"># Then, a virtualenv based on /usr/bin/python3.4:</span>
</span><span class='line'>virtualenv /path/to/venv34dirname
</span><span class='line'>
</span><span class='line'><span class="c"># Now, to create based on /usr/bin/python2.7, using a newer version of virtualenv than is provided by the &#39;python-virtualenv&#39; package:</span>
</span><span class='line'>virtualenv --python<span class="o">=</span>/usr/bin/python2.7 /path/to/venv27dirname
</span><span class='line'>
</span><span class='line'><span class="c"># Or, recommended, use the alternate path from the &#39;python-virtualenv&#39; package:</span>
</span><span class='line'>virtualenv-2.7 /path/to/venv27dirname
</span></code></pre></td></tr></table></div></figure>


<p>Unless you have a compelling reason for <code>virtualenv</code> on your servers, use the built-in <code>venv</code> module. I don&rsquo;t like to overwrite files provided by packages, and we should use recommended upstream tools where possible.</p>

<h2>uWSGI</h2>

<p>Since uWSGI is provided by EPEL, there is no need to install it with <code>pip</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install uwsgi uwsgi-plugin-python3
</span></code></pre></td></tr></table></div></figure>


<p>This will install the Python 3.4 uWSGI plugin to <code>/usr/lib64/uwsgi/python3_plugin.so</code>. Be sure to include the directive <code>plugin = python3</code> in your uWSGI definition and proceed as normal (beyond the scope of this post).</p>

<h1>Python 3.5 Software Collection</h1>

<p>I love <a href="http://softwarecollections.org">Software Collections</a>. With Python 2.7 being the default version of Python with CentOS 7, I find it much better to keep another version in a completely separate directory structure than integrating with <code>/usr</code> and such. We&rsquo;ll use a rebuild of the Red Hat SCL for Python 3.5, and everything will be installed to <code>/opt/rh/rh-python35</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install centos-release-scl
</span><span class='line'>
</span><span class='line'>yum -y install rh-python35-python
</span></code></pre></td></tr></table></div></figure>


<h2>Using</h2>

<p>You&rsquo;ll quickly notice that the newly-installed Python 3.5 binary is not in your <code>$PATH</code>; it&rsquo;s in <code>/opt/rh/rh-python35/root/bin</code>. You have a few options:</p>

<p>Launch a new instance of bash:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>scl <span class="nb">enable </span>rh-python35 bash
</span></code></pre></td></tr></table></div></figure>


<p>Alternatively, you can modify your existing session by running one of the following manually, or add to <code>~/.bashrc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Preferred method:</span>
</span><span class='line'><span class="nb">source </span>scl_source <span class="nb">enable </span>rh-python35
</span><span class='line'>
</span><span class='line'><span class="c"># Source the file directly:</span>
</span><span class='line'><span class="c">#source /opt/rh/rh-python35/enable</span>
</span></code></pre></td></tr></table></div></figure>


<h2>pip</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install rh-python35-python-pip
</span></code></pre></td></tr></table></div></figure>


<p>After installing, you can use <code>pip</code>, <code>pip3</code>, or <code>pip3.5</code></p>

<h2>Virtual Environments</h2>

<p>You can use the built-in method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python3.5 -m venv /path/to/venv35dirname
</span></code></pre></td></tr></table></div></figure>


<p>Or, you can use <code>virtualenv</code> (though, see the 3.4 section for the rationale I recommend against this):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install rh-python35-python-virtualenv
</span><span class='line'>
</span><span class='line'>virtualenv-3.5 /path/to/venv35dirname
</span></code></pre></td></tr></table></div></figure>


<h2>uWSGI</h2>

<p>While there is a <code>uwsgi-plugin-python3</code> RPM, it&rsquo;s for the aforementioned <code>python34</code> package. This is where you will have to compile something manually; so carefully consider the pros and cons of using a Software Collection. <em>(Later, I may add to this post where you can use a yum post-install or post-upgrade action to ensure the compiled plugin is kept up to date.)</em></p>

<p>This is a helpful exercise to learn how you can integrate packages that install to default paths and a Software Collection which is kept away from default paths.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install uwsgi uwsgi-plugin-common
</span><span class='line'>
</span><span class='line'><span class="nv">UWSGI_VERSION</span><span class="o">=</span><span class="s2">&quot;$( rpm -q uwsgi --queryformat &#39;%{VERSION}&#39; )&quot;</span>
</span><span class='line'><span class="nv">UWSGI_PLUGINS_DIR</span><span class="o">=</span><span class="s2">&quot;$( dirname &quot;</span><span class="k">$(</span> rpm -q uwsgi-plugin-common -l | grep <span class="s1">&#39;_plugin\.so&#39;</span> | tail -1 <span class="k">)</span><span class="s2">&quot; )&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">source </span>scl_source <span class="nb">enable </span>rh-python35
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$X_SCLS</span> <span class="o">==</span> *rh-python35* <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">UWSGI_PLUGINS_DIR</span><span class="o">=</span><span class="s2">&quot;/opt/rh/rh-python35/root${UWSGI_PLUGINS_DIR:?}&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> ! -f <span class="s2">&quot;${UWSGI_PLUGINS_DIR:?}/python35_plugin.so&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span>yum -y install gcc libcap-devel libuuid-devel make openssl-devel rh-python35-python-devel
</span><span class='line'>
</span><span class='line'>  mkdir -pv /opt/rh/rh-python35/root/src
</span><span class='line'>  <span class="nb">cd</span> /opt/rh/rh-python35/root/src
</span><span class='line'>
</span><span class='line'>  curl -LO <span class="s2">&quot;https://projects.unbit.it/downloads/uwsgi-${UWSGI_VERSION:?}.tar.gz&quot;</span>
</span><span class='line'>  tar zxvf <span class="s2">&quot;uwsgi-${UWSGI_VERSION:?}.tar.gz&quot;</span>
</span><span class='line'>  <span class="nb">cd</span> <span class="s2">&quot;uwsgi-${UWSGI_VERSION:?}/&quot;</span>
</span><span class='line'>
</span><span class='line'>  make <span class="nv">PROFILE</span><span class="o">=</span>nolang
</span><span class='line'>  <span class="nv">PYTHON</span><span class="o">=</span>python3.5 /usr/sbin/uwsgi --build-plugin <span class="s2">&quot;plugins/python python35&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">[[</span> ! -d <span class="s2">&quot;${UWSGI_PLUGINS_DIR:?}/&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> mkdir -pv <span class="s2">&quot;${UWSGI_PLUGINS_DIR:?}/&quot;</span>
</span><span class='line'>  mv -v python35_plugin.so <span class="s2">&quot;${UWSGI_PLUGINS_DIR:?}/&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>(Reference: <a href="http://uwsgi-docs.readthedocs.io/en/latest/WSGIquickstart.html">http://uwsgi-docs.readthedocs.io/en/latest/WSGIquickstart.html</a>)</em></p>

<p>After completing, your resulting uWSGI file will need to contain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="na">plugins-dir</span> <span class="o">=</span> <span class="s">/opt/rh/rh-python35/root/usr/lib64/uwsgi</span>
</span><span class='line'><span class="na">plugin</span> <span class="o">=</span> <span class="s">python35</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Which should you use?</h1>

<p>If you need Python 3 but want to reduce the amount of customization that you need to do, I recommend installing <code>python34</code> from EPEL. You can use it with uWSGI with no compiling from source.</p>

<p>If Python 3.4 is too old and/or you need 3.5+ functionality, the Software Collection can be an alternative to compiling Python from source and knowing that you&rsquo;re getting quality packages designed by Red Hat and rebuilt by CentOS.</p>

<p>If you need Python 3.6, or a newer release of 3.4 or 3.5 not provided quickly enough by the package maintainers, and you don&rsquo;t want to deal with all of the pain of <code>./configure &amp;&amp; make &amp;&amp; sudo make install</code>, I would suggest looking at <a href="https://github.com/pyenv/pyenv">pyenv</a> to meet your needs.</p>

<p>Please let me know if I missed something or should add anything. I&rsquo;m cumulatively green with running Python in production but wanted to share my learnings as I was frustrated by the lack of good information for my needs. Feedback is welcome.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/05/15/robots-dot-txt-disallow-all-with-nginx/">Robots.txt Disallow All With Nginx</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-05-15T16:16:00-04:00" pubdate data-updated="true">May 15<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you&rsquo;re managing an environment similar to a production and want to keep bots from indexing traffic, it&rsquo;s customary to add a <em>robots.txt</em> file at the root of your website to <a href="http://www.robotstxt.org/faq/prevent.html">disallow all</a>. Instead of creating a two-line plain text file, you can do this with only nginx:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">location</span> <span class="p">=</span> <span class="s">/robots.txt</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">add_header</span>  <span class="s">Content-Type</span>  <span class="s">text/plain</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">return</span> <span class="mi">200</span> <span class="s">&quot;User-agent:</span> <span class="s">*\nDisallow:</span> <span class="s">/\n&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add this into your configuration management as determined by environment, or add it by hand, and no longer worry if Google might start broadcasting your dev site to the world.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/05/03/auto-restart-tomcat-with-systemd/">Auto-restart Tomcat With Systemd</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-05-03T08:14:00-04:00" pubdate data-updated="true">May 3<span>rd</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&rsquo;s commonplace that if you&rsquo;ve run services on Linux and wanted something to auto-restart if it crashed, then you&rsquo;ve looked at <a href="https://mmonit.com/monit/">monit</a>. You may not know, however, that <a href="https://www.freedesktop.org/wiki/Software/systemd/">systemd</a> can provide the ability to restart a failed process without adding another daemon. In this example, we&rsquo;ll keep Tomcat running if it stops for any reason, unless we <code>systemctl stop tomcat</code>, by using a systemd override:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -pv /etc/systemd/system/tomcat.service.d/
</span><span class='line'>
</span><span class='line'>cat &gt; /etc/systemd/system/tomcat.service.d/restart.conf <span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span class='line'><span class="s">[Service]</span>
</span><span class='line'><span class="s">Restart=always</span>
</span><span class='line'><span class="s">RestartSec=30</span>
</span><span class='line'><span class="s">TimeoutStartSec=240</span>
</span><span class='line'><span class="s">TimeoutStopSec=240</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'>systemctl daemon-reload
</span></code></pre></td></tr></table></div></figure>


<p>You don&rsquo;t need to restart Tomcat; systemd will begin to honor the <code>Restart</code> setting immediately. You can view all of these values before and after to verify the changes were honored:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl show tomcat | grep -E <span class="s1">&#39;^(Restart(|USec)|Timeout(Start|Stop)USec)=&#39;</span>
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>always
</span><span class='line'><span class="nv">RestartUSec</span><span class="o">=</span>30s
</span><span class='line'><span class="nv">TimeoutStartUSec</span><span class="o">=</span>4min
</span><span class='line'><span class="nv">TimeoutStopUSec</span><span class="o">=</span>4min
</span></code></pre></td></tr></table></div></figure>


<p>I recommend reading the <a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">documentation</a> about each of the options, but a quick explanation:</p>

<ul>
<li><code>Restart=always</code>: Unless running <code>systemctl stop</code>, systemd will always attempt to start the process if it dies for any reason. That means if you were to <code>pkill -f tomcat</code> or any other kill command, regardless of the SIG code, it will be restarted. This would mean you should always be using <code>systemctl</code> to stop. If you&rsquo;d like the ability to stop the process another way and only want systemd to restart if the application crashed or exited with a non-zero exit code, you can use <code>Restart=on-failure</code> or another value. Check the docs for your use-case.</li>
<li><code>RestartSec=30</code>: First, the documentation above lists <code>RestartSec</code> despite <code>systemctl show</code> returning <code>RestartUSec</code>; I try and stick with the docs where I can so you can follow along with the official guidance rather than something I have stumbled upon that may not work in the future. This value is how long to sleep before restarting the service. The default is only <code>100ms</code>, so I like to set it higher to allow for a busy operation to continue before systemd gets too aggressive with restarting.</li>
<li><code>TimeoutStartSec</code> and <code>TimeoutStopSec</code> instruct systemd how long to wait for the stop and start commands before considering the operation failed and trying again. Change as needed, but I set it to 4 minutes to allow for our Tomcat applications to completely initialize.</li>
</ul>


<p>It&rsquo;s worth noting that you can run the interactive command <code>systemctl edit tomcat</code> and it will open <code>/etc/systemd/system/tomcat.service.d/override.conf</code> in your <code>$EDITOR</code> for adding in the contents above, eliminating the need to remember the directory structure and where to put override directives. I prefer adding files by hand as shown above for two reasons: 1) adding a file directly is obviously easier in a non-interactive server initialization script, and 2) you can have multiple files with the pattern <code>/etc/systemd/system/name.service.d/*.conf</code>. For organizing purposes, you could have a <code>restart.conf</code> where you specify your custom Restarting parameters, and another <code>environment.conf</code> file where you might add more environmental variables.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/22/os-x-1010-yosemite-local-development-environment-apache-php-and-mysql-homebrew/">OS X 10.10 Yosemite Local Development Environment: Apache, PHP, and MySQL With Homebrew</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-22T16:38:00-05:00" pubdate data-updated="true">Dec 22<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post originally featured on the <a href="http://echo.co/blog/os-x-1010-yosemite-local-development-environment-apache-php-and-mysql-homebrew">Echo &amp; Co. blog</a></em>.</p>

<p>OS X 10.10 Yosemite comes with Apache and PHP pre-installed, but it&rsquo;s not in a great configuration, requires root to make lots of changes, and can introduce issues with file ownership and permissions. We prefer to use Homebrew to avoid these problems and because it&rsquo;s easier to keep up to date with newer versions of each component and extend customization. We can also set things up to be fully automatic so you can create new websites locally without needing to edit any configuration files.</p>

<p>With the arrival of Yosemite, some of the changes previously used in <a href="/blog/os-x-109-local-development-environment-apache-php-and-mysql-homebrew">10.9 for setting up Apache, PHP, and MySQL with Homebrew</a> don&rsquo;t work quite the same. This guide will walk you through using <a href="http://brew.sh/">Homebrew</a> to install Apache, PHP, and MySQL for a &ldquo;MAMP&rdquo; development environment. We&rsquo;ll also use DNSMasq and Apache&rsquo;s VirtualDocumentRoot to set up &ldquo;auto-VirtualHosts&rdquo; so you don&rsquo;t need to edit configuration files when starting new projects. Finally, we&rsquo;ll add a firewall rule to allow the default http port 80 to be used without running Apache as root.</p>

<p>The following steps are intended for use on a Yosemite system without any previous attempts to use Homebrew for Apache, PHP, or MySQL. If you have attempted to install a similar stack and run into conflicts, or you&rsquo;ve upgraded your operating system from 10.9 and things broke, the final section has some troubleshooting pointers. If that fails, leave a comment and I&rsquo;ll try my best to help you out.</p>

<p>At the conclusion of this guide, you&rsquo;ll be able to create a directory like <em>~/Sites/project</em> and access it immediately at <em><a href="http://project.dev">http://project.dev</a></em> without editing your <em>/etc/hosts</em> file or editing any Apache configuration. We&rsquo;ll configure PHP and MySQL to allow for enough flexibility for development.</p>

<p>Because some of the commands span several lines, each command will be in a separate code block. This means you should copy and paste each code block in its entirety as a single command.</p>

<p>Before diving in, yes, this is a lot of steps. You can do it faster and pay money for something like MAMP Pro, but this is more fun, and you may learn something along the way! And, while you can simplify things with <a href="http://www.vagrantup.com/">Vagrant</a> or other virtual machine format, some people prefer to run things on &ldquo;bare metal&rdquo; and not have the overhead of a virtual machine.</p>

<h1>Homebrew Setup</h1>

<p>If you&rsquo;ve not already installed Homebrew, you can follow the instructions at <a href="http://brew.sh/">http://brew.sh</a>. I used to include the command in previous walkthrough blogs, but it could change after posting, so definitely check their website to install it properly.</p>

<p>If you do not have <code>git</code> available on your system, either from Homebrew, Xcode, or another source, you can install it with Homebrew now (if you already have it installed, feel free to skip this step to keep the version of <code>git</code> you already have):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v git
</span></code></pre></td></tr></table></div></figure>


<h1>PATH Variable</h1>

<p>In previous guides on 10.9 and earlier, I added a change to <strong>$PATH</strong> in <em>~/.bash_profile</em> to ensure that Homebrew-installed applications would run by default over similar ones that were already installed on OS X. Thankfully, Yosemite&rsquo;s <strong>$PATH</strong> order is different than earlier OS versions and now includes the default Homebrew location of <em>/usr/local/bin</em> in front. If you installed Homebrew to a custom location, or are not seeing <em>/usr/local/bin</em> at the beginning of your shell&rsquo;s <strong>$PATH</strong>, check out the file <em>/etc/paths</em> or the directory <em>/etc/paths.d/</em>.</p>

<h1>MySQL</h1>

<p>Install MySQL with Homebrew:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v mysql
</span></code></pre></td></tr></table></div></figure>


<p>Copy the default <em>my-default.cnf</em> file to the MySQL Homebrew Cellar directory where it will be loaded on application start:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp -v <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/support-files/my-default.cnf <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/my.cnf
</span></code></pre></td></tr></table></div></figure>


<p>This will configure MySQL to allow for the maximum packet size, only appropriate for a local or development server. Also, we&rsquo;ll keep each InnoDB table in separate files to keep <em>ibdataN</em>-type file sizes low and make file-based backups, like Time Machine, easier to manage multiple small files instead of a few large InnoDB data files. This is the first of many multi-line single commands. The following is a single, multi-line command; copy and paste the entire block at once:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/my.cnf <span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Echo &amp; Co. changes</span>
</span><span class='line'><span class="s">max_allowed_packet = 1073741824</span>
</span><span class='line'><span class="s">innodb_file_per_table = 1</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Uncomment the sample option for <strong>innodb_buffer_pool_size</strong> to improve performance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s/^#[[:space:]]*\(innodb_buffer_pool_size\)/\1/&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/my.cnf
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to start MySQL using OS X&rsquo;s launchd. This used to be an involved process with <code>launchctl</code> commands, but now we can leverage the excellent <strong><a href="https://github.com/Homebrew/homebrew-services">brew services</a></strong> command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew tap homebrew/services
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew services start mysql
</span></code></pre></td></tr></table></div></figure>


<p>By default, MySQL&rsquo;s root user has an empty password from any connection. You are advised to run <code>mysql_secure_installation</code> and at least set a password for the root user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/bin/mysql_secure_installation
</span></code></pre></td></tr></table></div></figure>


<h1>Apache</h1>

<p>Start by stopping the built-in Apache, if it&rsquo;s running, and prevent it from starting on boot. This is one of very few times you&rsquo;ll need to use <code>sudo</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo launchctl unload /System/Library/LaunchDaemons/org.apache.httpd.plist 2&gt;/dev/null
</span></code></pre></td></tr></table></div></figure>


<p>The formula for building Apache is not in the default Homebrew repository that you get by installing Homebrew. While we can use the format of <code>brew install external-repo/formula</code>, if an external formula relies on another external formula, you have to use the <code>brew tap</code> command first. I know, it&rsquo;s weird. So, we need to tap homebrew-dupes because &ldquo;homebrew-apache/httpd22&rdquo; relies on &ldquo;homebrew-dupes/zlib&rdquo;. Whew:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew tap homebrew/dupes
</span></code></pre></td></tr></table></div></figure>


<p>A slight deviation from my prior walkthroughs: we&rsquo;ll install Apache 2.2 with the event MPM and set up PHP-FPM instead of mod_php. If those terms mean anything to you and you&rsquo;re curious as to why I decided to go this route; it&rsquo;s because: 1) switching PHP versions is far easier with PHP-FPM and the default 9000 port instead of also editing the Apache configuration to switch the mod_php module location, and 2) if we&rsquo;re therefore not using mod_php, we don&rsquo;t have to use the prefork MPM and can get better performance with event or worker. As to why I&rsquo;m using 2.2 instead of 2.4, popular FOSS projects like Drupal and WordPress still ship with 2.2-style .htaccess files. Using 2.4 sometimes means you have to set up &ldquo;compat&rdquo; modules, and that&rsquo;s above the requirement for a local environment, in my opinion.</p>

<p>Onward! Let&rsquo;s install Apache 2.2 with the event MPM, and we&rsquo;ll use Homebrew&rsquo;s OpenSSL library since it&rsquo;s more up-to-date than OS X&rsquo;s:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v homebrew/apache/httpd22 --with-brewed-openssl --with-mpm-event
</span></code></pre></td></tr></table></div></figure>


<p>In order to get Apache and PHP to communicate via PHP-FPM, we&rsquo;ll install the mod_fastcgi module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v homebrew/apache/mod_fastcgi --with-brewed-httpd22
</span></code></pre></td></tr></table></div></figure>


<p>To prevent any potential problems with previous mod_fastcgi setups, let&rsquo;s remove all references to the mod_fastcgi module (we&rsquo;ll re-add the new version later):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;/fastcgi_module/d&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/apache2/2.2/httpd.conf
</span></code></pre></td></tr></table></div></figure>


<p>Add the logic for Apache to send PHP to PHP-FPM with mod_fastcgi, and reference that we&rsquo;ll want to use the file <em>~/Sites/httpd-vhosts.conf</em> to configure our VirtualHosts. The parenthesis are used to <a href="http://stackoverflow.com/a/10856211/534275">run the command in a subprocess</a>, so that the <code>export</code>ed variables don&rsquo;t persist in your terminal session afterwards. Also, you&rsquo;ll see <code>export USERHOME</code> a few times in this guide; I look up the full path for your user home directory from the operating system wherever a full path is needed in a configuration file and &ldquo;<em>~</em>&rdquo; or a literal &ldquo;<em>$HOME</em>&rdquo; would not work.</p>

<p>This is all one command, so copy and paste the entire code block at once:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span><span class="nb">export </span><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;\: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> ; <span class="nb">export </span><span class="nv">MODFASTCGIPREFIX</span><span class="o">=</span><span class="k">$(</span>brew --prefix mod_fastcgi<span class="k">)</span> ; cat &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/apache2/2.2/httpd.conf <span class="s">&lt;&lt;EOF</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Echo &amp; Co. changes</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Load PHP-FPM via mod_fastcgi</span>
</span><span class='line'><span class="s">LoadModule fastcgi_module    ${MODFASTCGIPREFIX}/libexec/mod_fastcgi.so</span>
</span><span class='line'>
</span><span class='line'><span class="s">&lt;IfModule fastcgi_module&gt;</span>
</span><span class='line'><span class="s">  FastCgiConfig -maxClassProcesses 1 -idle-timeout 1500</span>
</span><span class='line'>
</span><span class='line'><span class="s">  # Prevent accessing FastCGI alias paths directly</span>
</span><span class='line'><span class="s">  &lt;LocationMatch &quot;^/fastcgi&quot;&gt;</span>
</span><span class='line'><span class="s">    &lt;IfModule mod_authz_core.c&gt;</span>
</span><span class='line'><span class="s">      Require env REDIRECT_STATUS</span>
</span><span class='line'><span class="s">    &lt;/IfModule&gt;</span>
</span><span class='line'><span class="s">    &lt;IfModule !mod_authz_core.c&gt;</span>
</span><span class='line'><span class="s">      Order Deny,Allow</span>
</span><span class='line'><span class="s">      Deny from All</span>
</span><span class='line'><span class="s">      Allow from env=REDIRECT_STATUS</span>
</span><span class='line'><span class="s">    &lt;/IfModule&gt;</span>
</span><span class='line'><span class="s">  &lt;/LocationMatch&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s">  FastCgiExternalServer /php-fpm -host 127.0.0.1:9000 -pass-header Authorization -idle-timeout 1500</span>
</span><span class='line'><span class="s">  ScriptAlias /fastcgiphp /php-fpm</span>
</span><span class='line'><span class="s">  Action php-fastcgi /fastcgiphp</span>
</span><span class='line'><span class="s">  </span>
</span><span class='line'><span class="s">  # Send PHP extensions to PHP-FPM</span>
</span><span class='line'><span class="s">  AddHandler php-fastcgi .php</span>
</span><span class='line'><span class="s">  </span>
</span><span class='line'><span class="s">  # PHP options</span>
</span><span class='line'><span class="s">  AddType text/html .php</span>
</span><span class='line'><span class="s">  AddType application/x-httpd-php .php</span>
</span><span class='line'><span class="s">  DirectoryIndex index.php index.html</span>
</span><span class='line'><span class="s">&lt;/IfModule&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Include our VirtualHosts</span>
</span><span class='line'><span class="s">Include ${USERHOME}/Sites/httpd-vhosts.conf</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll be using the file <em>~/Sites/httpd-vhosts.conf</em> to configure our VirtualHosts, but the <em>~/Sites</em> folder doesn&rsquo;t exist by default in newer versions of OS X. We&rsquo;ll also create folders for logs and SSL files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -pv ~/Sites/<span class="o">{</span>logs,ssl<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s populate the <em>~/Sites/httpd-vhosts.conf</em> file. The biggest difference from my previous guides are that you&rsquo;ll see the port numbers are 8080/8443 instead of 80/443. OS X 10.9 and earlier had the <code>ipfw</code> firewall which allowed for port redirecting, so we would send port 80 traffic &ldquo;directly&rdquo; to our Apache. But <code>ipfw</code> is now removed and replaced by <code>pf</code> which &ldquo;forwards&rdquo; traffic to another port. We&rsquo;ll get to that later, but know that &ldquo;8080&rdquo; and &ldquo;8443&rdquo; are not typos but are acceptable because of later port forwarding. Also, I&rsquo;ve now added a basic SSL configuration (though you&rsquo;ll need to acknowledge warnings in your browser about self-signed certificates):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch ~/Sites/httpd-vhosts.conf
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="nb">export </span><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;\: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> ; cat &gt; ~/Sites/httpd-vhosts.conf <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># Listening ports.</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s">#Listen 8080  # defined in main httpd.conf</span>
</span><span class='line'><span class="s">Listen 8443</span>
</span><span class='line'>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># Use name-based virtual hosting.</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s">NameVirtualHost *:8080</span>
</span><span class='line'><span class="s">NameVirtualHost *:8443</span>
</span><span class='line'>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># Set up permissions for VirtualHosts in ~/Sites</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s">&lt;Directory &quot;${USERHOME}/Sites&quot;&gt;</span>
</span><span class='line'><span class="s">    Options Indexes FollowSymLinks MultiViews</span>
</span><span class='line'><span class="s">    AllowOverride All</span>
</span><span class='line'><span class="s">    &lt;IfModule mod_authz_core.c&gt;</span>
</span><span class='line'><span class="s">        Require all granted</span>
</span><span class='line'><span class="s">    &lt;/IfModule&gt;</span>
</span><span class='line'><span class="s">    &lt;IfModule !mod_authz_core.c&gt;</span>
</span><span class='line'><span class="s">        Order allow,deny</span>
</span><span class='line'><span class="s">        Allow from all</span>
</span><span class='line'><span class="s">    &lt;/IfModule&gt;</span>
</span><span class='line'><span class="s">&lt;/Directory&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># For http://localhost in the users&#39; Sites folder</span>
</span><span class='line'><span class="s">&lt;VirtualHost _default_:8080&gt;</span>
</span><span class='line'><span class="s">    ServerName localhost</span>
</span><span class='line'><span class="s">    DocumentRoot &quot;${USERHOME}/Sites&quot;</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'><span class="s">&lt;VirtualHost _default_:8443&gt;</span>
</span><span class='line'><span class="s">    ServerName localhost</span>
</span><span class='line'><span class="s">    Include &quot;${USERHOME}/Sites/ssl/ssl-shared-cert.inc&quot;</span>
</span><span class='line'><span class="s">    DocumentRoot &quot;${USERHOME}/Sites&quot;</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># VirtualHosts</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'>
</span><span class='line'><span class="s">## Manual VirtualHost template for HTTP and HTTPS</span>
</span><span class='line'><span class="s">#&lt;VirtualHost *:8080&gt;</span>
</span><span class='line'><span class="s">#  ServerName project.dev</span>
</span><span class='line'><span class="s">#  CustomLog &quot;${USERHOME}/Sites/logs/project.dev-access_log&quot; combined</span>
</span><span class='line'><span class="s">#  ErrorLog &quot;${USERHOME}/Sites/logs/project.dev-error_log&quot;</span>
</span><span class='line'><span class="s">#  DocumentRoot &quot;${USERHOME}/Sites/project.dev&quot;</span>
</span><span class='line'><span class="s">#&lt;/VirtualHost&gt;</span>
</span><span class='line'><span class="s">#&lt;VirtualHost *:8443&gt;</span>
</span><span class='line'><span class="s">#  ServerName project.dev</span>
</span><span class='line'><span class="s">#  Include &quot;${USERHOME}/Sites/ssl/ssl-shared-cert.inc&quot;</span>
</span><span class='line'><span class="s">#  CustomLog &quot;${USERHOME}/Sites/logs/project.dev-access_log&quot; combined</span>
</span><span class='line'><span class="s">#  ErrorLog &quot;${USERHOME}/Sites/logs/project.dev-error_log&quot;</span>
</span><span class='line'><span class="s">#  DocumentRoot &quot;${USERHOME}/Sites/project.dev&quot;</span>
</span><span class='line'><span class="s">#&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># Automatic VirtualHosts</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># A directory at ${USERHOME}/Sites/webroot can be accessed at http://webroot.dev</span>
</span><span class='line'><span class="s"># In Drupal, uncomment the line with: RewriteBase /</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'>
</span><span class='line'><span class="s"># This log format will display the per-virtual-host as the first field followed by a typical log line</span>
</span><span class='line'><span class="s">LogFormat &quot;%V %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combinedmassvhost</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Auto-VirtualHosts with .dev</span>
</span><span class='line'><span class="s">&lt;VirtualHost *:8080&gt;</span>
</span><span class='line'><span class="s">  ServerName dev</span>
</span><span class='line'><span class="s">  ServerAlias *.dev</span>
</span><span class='line'>
</span><span class='line'><span class="s">  CustomLog &quot;${USERHOME}/Sites/logs/dev-access_log&quot; combinedmassvhost</span>
</span><span class='line'><span class="s">  ErrorLog &quot;${USERHOME}/Sites/logs/dev-error_log&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">  VirtualDocumentRoot ${USERHOME}/Sites/%-2+</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'><span class="s">&lt;VirtualHost *:8443&gt;</span>
</span><span class='line'><span class="s">  ServerName dev</span>
</span><span class='line'><span class="s">  ServerAlias *.dev</span>
</span><span class='line'><span class="s">  Include &quot;${USERHOME}/Sites/ssl/ssl-shared-cert.inc&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">  CustomLog &quot;${USERHOME}/Sites/logs/dev-access_log&quot; combinedmassvhost</span>
</span><span class='line'><span class="s">  ErrorLog &quot;${USERHOME}/Sites/logs/dev-error_log&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">  VirtualDocumentRoot ${USERHOME}/Sites/%-2+</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may have noticed that <em>~/Sites/ssl/ssl-shared-cert.inc</em> is included multiple times; create that file and the SSL files it needs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span><span class="nb">export </span><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;\: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> ; cat &gt; ~/Sites/ssl/ssl-shared-cert.inc <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">SSLEngine On</span>
</span><span class='line'><span class="s">SSLProtocol all -SSLv2 -SSLv3</span>
</span><span class='line'><span class="s">SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW</span>
</span><span class='line'><span class="s">SSLCertificateFile &quot;${USERHOME}/Sites/ssl/selfsigned.crt&quot;</span>
</span><span class='line'><span class="s">SSLCertificateKeyFile &quot;${USERHOME}/Sites/ssl/private.key&quot;</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openssl req <span class="se">\</span>
</span><span class='line'>  -new <span class="se">\</span>
</span><span class='line'>  -newkey rsa:2048 <span class="se">\</span>
</span><span class='line'>  -days 3650 <span class="se">\</span>
</span><span class='line'>  -nodes <span class="se">\</span>
</span><span class='line'>  -x509 <span class="se">\</span>
</span><span class='line'>  -subj <span class="s2">&quot;/C=US/ST=State/L=City/O=Organization/OU=$(whoami)/CN=*.dev&quot;</span> <span class="se">\</span>
</span><span class='line'>  -keyout ~/Sites/ssl/private.key <span class="se">\</span>
</span><span class='line'>  -out ~/Sites/ssl/selfsigned.crt
</span></code></pre></td></tr></table></div></figure>


<h2>Start Apache</h2>

<p>Start Homebrew&rsquo;s Apache and set to start on login:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew services start httpd22
</span></code></pre></td></tr></table></div></figure>


<h2>Run with port 80</h2>

<p>You may notice that <em>httpd.conf</em> is running Apache on ports <strong>8080</strong> and <strong>8443</strong>. Manually adding &ldquo;:8080&rdquo; each time you&rsquo;re referencing your dev sites is no fun, but running Apache on port 80 requires root. The next two commands will create and load a firewall rule to forward port 80 requests to 8080, and port 443 requests to 8443. The end result is that we don&rsquo;t need to add the port number when visiting a project dev site, like &ldquo;<a href="http://projectname.dev/">http://projectname.dev/</a>&rdquo; instead of &ldquo;<a href="http://projectname.dev:8080/">http://projectname.dev:8080/</a>&rdquo;.</p>

<p>The following command will create the file <em>/Library/LaunchDaemons/co.echo.httpdfwd.plist</em> as root, and owned by root, since it needs elevated privileges:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo bash -c <span class="s1">&#39;export TAB=$&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;\t&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">cat &gt; /Library/LaunchDaemons/co.echo.httpdfwd.plist &lt;&lt;EOF</span>
</span><span class='line'><span class="s1">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="s1">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
</span><span class='line'><span class="s1">&lt;plist version=&quot;1.0&quot;&gt;</span>
</span><span class='line'><span class="s1">&lt;dict&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;Label&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;string&gt;co.echo.httpdfwd&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;ProgramArguments&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;array&gt;</span>
</span><span class='line'><span class="s1">${TAB}${TAB}&lt;string&gt;sh&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}${TAB}&lt;string&gt;-c&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}${TAB}&lt;string&gt;echo &quot;rdr pass proto tcp from any to any port {80,8080} -&gt; 127.0.0.1 port 8080&quot; | pfctl -a &quot;com.apple/260.HttpFwdFirewall&quot; -Ef - &amp;amp;&amp;amp; echo &quot;rdr pass proto tcp from any to any port {443,8443} -&gt; 127.0.0.1 port 8443&quot; | pfctl -a &quot;com.apple/261.HttpFwdFirewall&quot; -Ef - &amp;amp;&amp;amp; sysctl -w net.inet.ip.forwarding=1&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;/array&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;RunAtLoad&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;true/&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;UserName&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;string&gt;root&lt;/string&gt;</span>
</span><span class='line'><span class="s1">&lt;/dict&gt;</span>
</span><span class='line'><span class="s1">&lt;/plist&gt;</span>
</span><span class='line'><span class="s1">EOF&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This file will be loaded on login and set up the 80->8080 and 443->8443 port forwards, but we can load it manually now so we don&rsquo;t need to log out and back in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo launchctl load -Fw /Library/LaunchDaemons/co.echo.httpdfwd.plist
</span></code></pre></td></tr></table></div></figure>


<h1>PHP</h1>

<p>The following is for the latest release of PHP, version 5.6. If you&rsquo;d like to use 5.3, 5.4 or 5.5, simply change the &ldquo;5.6&rdquo; and &ldquo;php56&rdquo; values below appropriately.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v homebrew/php/php56
</span></code></pre></td></tr></table></div></figure>


<p>Set timezone and change other PHP settings (<code>sudo</code> is needed here to get the current timezone on OS X) to be more developer-friendly, and add a PHP error log (without this, you may get Internal Server Errors if PHP has errors to write and no logs to write to):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span><span class="nb">export </span><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;\: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> ; sed -i <span class="s1">&#39;-default&#39;</span> -e <span class="s1">&#39;s|^;\(date\.timezone[[:space:]]*=\).*|\1 \&quot;&#39;</span><span class="k">$(</span>sudo systemsetup -gettimezone|awk -F<span class="s2">&quot;\: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span><span class="s1">&#39;\&quot;|; s|^\(memory_limit[[:space:]]*=\).*|\1 512M|; s|^\(post_max_size[[:space:]]*=\).*|\1 200M|; s|^\(upload_max_filesize[[:space:]]*=\).*|\1 100M|; s|^\(default_socket_timeout[[:space:]]*=\).*|\1 600|; s|^\(max_execution_time[[:space:]]*=\).*|\1 300|; s|^\(max_input_time[[:space:]]*=\).*|\1 600|; $a\&#39;$&#39;</span><span class="se">\n</span><span class="s1">&#39;&#39;</span><span class="se">\&#39;</span><span class="s1">$&#39;\n&#39;&#39;; PHP Error log\&#39;$&#39;</span><span class="se">\n</span><span class="s1">&#39;&#39;</span><span class="nv">error_log</span> <span class="o">=</span> <span class="s1">&#39;$USERHOME&#39;</span>/Sites/logs/php-error_log<span class="s1">&#39;$&#39;</span><span class="se">\n</span><span class="err">&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.6/php.ini<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fix a <code>pear</code> and <code>pecl</code> <a href="https://github.com/Homebrew/homebrew-php/issues/1039#issuecomment-41307694">permissions problem</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chmod -R ug+w <span class="k">$(</span>brew --prefix php56<span class="k">)</span>/lib/php
</span></code></pre></td></tr></table></div></figure>


<p>The optional Opcache extension will speed up your PHP environment dramatically, so let&rsquo;s install it. Then, we&rsquo;ll bump up the opcache memory limit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v php56-opcache
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/bin/sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s|^\(\;\)\{0,1\}[[:space:]]*\(opcache\.enable[[:space:]]*=[[:space:]]*\)0|\21|; s|^;\(opcache\.memory_consumption[[:space:]]*=[[:space:]]*\)[0-9]*|\1256|;&quot;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.6/php.ini
</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&rsquo;s start PHP-FPM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew services start php56
</span></code></pre></td></tr></table></div></figure>


<p><strong>Optional:</strong> At this point, if you want to switch between PHP versions, you&rsquo;d want to: <code>brew services stop php56 &amp;&amp; brew unlink php56 &amp;&amp; brew link php54 &amp;&amp; brew services start php54</code>. No need to touch the Apache configuration at all!</p>

<h1>DNSMasq</h1>

<p>A difference now between what <a href="http://echo.co/blog/never-touch-your-local-etchosts-file-os-x-again">I&rsquo;ve shown before</a>, is that we don&rsquo;t have to run on port 53 or run <code>dnsmasq</code> as root. The end result here is that any DNS request ending in <em>.dev</em> reply with the IP address <em>127.0.0.1</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v dnsmasq
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;address=/.dev/127.0.0.1&#39;</span> &gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/dnsmasq.conf
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;listen-address=127.0.0.1&#39;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/dnsmasq.conf
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;port=35353&#39;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/dnsmasq.conf
</span></code></pre></td></tr></table></div></figure>


<p>Similar to how we run Apache and PHP-FPM, we&rsquo;ll start DNSMasq:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew services start dnsmasq
</span></code></pre></td></tr></table></div></figure>


<p>With DNSMasq running, configure OS X to use your local host for DNS queries ending in <em>.dev</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo mkdir -v /etc/resolver
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo bash -c <span class="s1">&#39;echo &quot;nameserver 127.0.0.1&quot; &gt; /etc/resolver/dev&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo bash -c <span class="s1">&#39;echo &quot;port 35353&quot; &gt;&gt; /etc/resolver/dev&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To test, the command <code>ping -c 3 fakedomainthatisntreal.dev</code> should return results from 127.0.0.1. If it doesn&rsquo;t work right away, try turning WiFi off and on (or unplug/plug your ethernet cable), or reboot your system.</p>

<h1>Great! So, what did I do?</h1>

<p>We set up Apache to run on boot on ports 8080 and 8443 with auto-VirtualHosts for directories in the <em>~/Sites</em> folder and PHP-FPM via mod_fastcgi. The OS X firewall will forward all port 80 traffic to port 8080 and port 443 to port 8443, so we don&rsquo;t have specify the port number when visiting web pages in local web browsers or run Apache as root. MySQL is installed and set to run on boot as well. DNSMasq and some OS X configuration is used to direct any hostname ending in <em>.dev</em> to the local system to work in conjunction with Apache&rsquo;s auto-VirtualHosts.</p>

<h2>What do I do now?</h2>

<p>You shouldn&rsquo;t need to edit the Apache configuration or edit /etc/hosts for new local development sites. Simply create a directory in <em>~/Sites</em> and then reference &ldquo;<a href="http://">http://</a>&rdquo; + that foldername + &ldquo;.dev/&rdquo; in your browser to access it.</p>

<p>For example, download Drupal 7 to the directory <em>~/Sites/firstproject</em>, and it can then be accessed at <em><a href="http://firstproject.dev/*">http://firstproject.dev/*</a> without any additional configuration. A caveat &ndash; you will need to uncomment the line in Drupal&rsquo;s </em>.htaccess* containing <strong>&ldquo;RewriteBase /&rdquo;</strong> to work with the auto-VirtualHosts configuration.</p>

<h2>What if this &ldquo;auto-VirtualHost&rdquo; doesn&rsquo;t work for <em>[other project]</em>?</h2>

<p>If you need to create a manual VirtualHost in Apache because the auto-VirtualHost does not work for your configuration, you will need to declare it before the auto-VirtualHosts if you&rsquo;re also going to use .dev as the TLD. Otherwise the auto-VirtualHost block will be accessed first. I have a commented-out sample for a manual VirtualHost entry in &ldquo;<em>~/Sites/httpd-vhosts.conf</em>&rdquo; you may use.</p>

<h1>Troubleshooting</h1>

<p>The commands above can be run on a fresh Yosemite system without issue as I&rsquo;ve tested with fresh installs in VMware. Nearly every problem I&rsquo;ve heard about has been related to upgrading from 10.9 or earlier, or switching to this style of setup from another or similar setup. The easiest thing to do would be to <code>brew uninstall</code> each component referenced above, delete all related config files in <em>$(brew &mdash;prefix)/etc</em> and any Homebrew files in <em>~/Library/LaunchAgents</em>, and start over. If that&rsquo;s a bit heavy-handed, check each of the configuration files edited in this guide and look for duplicate entries or typos.</p>

<p>You can also check log files for error output:</p>

<ul>
<li>Apache: <em>$(brew &mdash;prefix)/var/log/apache2/error_log</em>, or run <code>httpd -DFOREGROUND</code> and look for output</li>
<li>PHP-FPM: <em>$(brew &mdash;prefix)/var/log/php-fpm.log</em></li>
<li>MySQL: <em>$(brew &mdash;prefix)/var/mysql/$(hostname).err</em></li>
<li>DNSMasq: no log file, run <code>dnsmasq --keep-in-foreground</code> and look for output</li>
</ul>


<p>Leave a comment if you have any questions or problems!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/09/os-x-109-local-development-environment-apache-php-and-mysql-homebrew/">OS X 10.9 Local Development Environment: Apache, PHP, and MySQL With Homebrew</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-09T09:55:00-04:00" pubdate data-updated="true">Jun 9<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post originally featured on the <a href="http://echo.co/blog/os-x-109-local-development-environment-apache-php-and-mysql-homebrew">Echo &amp; Co. blog</a></em>.</p>

<p>There&rsquo;s nothing quite like setting up everything on your Mac for Drupal (or other PHP) development in a way that things just work and don&rsquo;t need constant fiddling. This guide will walk you through using <a href="http://brew.sh/">Homebrew</a> to install Apache, PHP, and MySQL for a &ldquo;MAMP&rdquo; development environment. We&rsquo;ll also use DNSMasq and Apache&rsquo;s VirtualDocumentRoot to set up &ldquo;auto-VirtualHosts,&rdquo; and add a firewall rule to allow the default http port 80 to be used without running Apache as root.</p>

<p>At the conclusion of this guide, you&rsquo;ll be able to create a directory like <em>~/Sites/project</em> and access it at <em><a href="http://project.dev">http://project.dev</a></em> without editing your <em>/etc/hosts</em> file or editing any Apache configuration. You&rsquo;ll also be able to use <a href="http://xip.io/">xip.io</a> with auto-VirtualHosts for accessing your sites on other devices in your local network.</p>

<p>We also configure PHP and MySQL to allow for enough flexibility for complex operations generally only reserved for development and not production.</p>

<p>The OS X operating system comes with Apache and PHP pre-installed, and I&rsquo;ve <a href="http://echo.co/blog/os-x-107-lion-development-native-apache-php-homebrew-mysql-or-mariadb">previously</a> <a href="http://echo.co/blog/os-x-107-lion-development-native-mamp-mysql-installer">recommended</a> utilizing them to some degree for getting a local PHP development environment on your Mac. Since then, the community around Homebrew has improved dramatically and I now recommend that our developers at Echo &amp; Co. use Homebrew exclusively for all components.</p>

<h1>Homebrew Setup</h1>

<p>If you&rsquo;ve not already install Homebrew, you can follow the instructions at <a href="http://brew.sh/">brew.sh</a>, or simply run the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ruby -e <span class="s2">&quot;$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)&quot;</span>
</span><span class='line'>brew doctor
</span><span class='line'>brew update
</span></code></pre></td></tr></table></div></figure>


<p>Also of note, if you do not have <code>git</code> available on your system, either from Homebrew, Xcode, or another source, you can install it with Homebrew now (if you already have it installed, feel free to skip this step to keep the version of <code>git</code> you already have):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v git
</span></code></pre></td></tr></table></div></figure>


<h1>PATH Variable</h1>

<p>Since OS X already comes with PHP and Apache, we&rsquo;ll want to make sure that our <code>brew</code>-installed versions appear in the shell path before the built-in ones. The following command adds logic to your <em>~/.bash_profile</em> to ensure the Homebrew directory is in the beginning of <strong>$PATH</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;export PATH=\$(echo \$PATH | sed &#39;s|/usr/local/bin||; s|/usr/local/sbin||; s|::|:|; s|^:||; s|\(.*\)|/usr/local/bin:/usr/local/sbin:\1|&#39;)&quot;</span> &gt;&gt; ~/.bash_profile <span class="o">&amp;&amp;</span> <span class="nb">source</span> ~/.bash_profile
</span></code></pre></td></tr></table></div></figure>


<h1>MySQL</h1>

<p>The following commands will download and install the latest version of MySQL and do some basic configuration to allow for large imports and a couple other miscellaneous configuration changes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v mysql
</span><span class='line'>
</span><span class='line'>cp -v <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/support-files/my-default.cnf <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/my.cnf
</span><span class='line'>
</span><span class='line'>cat &gt;&gt; <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/my.cnf <span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span class='line'><span class="s"># Echo &amp; Co. changes</span>
</span><span class='line'><span class="s">max_allowed_packet = 2G</span>
</span><span class='line'><span class="s">innodb_file_per_table = 1</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s/^# \(innodb_buffer_pool_size\)/\1/&#39;</span> <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/my.cnf
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to start MySQL using OS X&rsquo;s launchd, and we&rsquo;ll set it to start when you login.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span> ! -d ~/Library/LaunchAgents <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir -v ~/Library/LaunchAgents
</span><span class='line'>
</span><span class='line'><span class="o">[</span> -f <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/homebrew.mxcl.mysql.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> ln -sfv <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/homebrew.mxcl.mysql.plist ~/Library/LaunchAgents/
</span><span class='line'>
</span><span class='line'><span class="o">[</span> -e ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist
</span></code></pre></td></tr></table></div></figure>


<p>By default, MySQL&rsquo;s root user has an empty password from any connection. You are advised to run <code>mysql_secure_installation</code> and at least set a password for the root user.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/bin/mysql_secure_installation
</span></code></pre></td></tr></table></div></figure>


<h1>Apache</h1>

<p>Start by stopping the built-in Apache, if it&rsquo;s running, and prevent it from starting on boot. This is one of very few times you&rsquo;ll need to use <code>sudo</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo launchctl unload -w /System/Library/LaunchDaemons/org.apache.httpd.plist 2&gt;/dev/null
</span></code></pre></td></tr></table></div></figure>


<p>Apache is not in the default repository of Homebrew formulas, nor are some dependencies, so we use the <code>brew tap</code> command to add other formula repositories.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew tap homebrew/dupes
</span><span class='line'>brew tap homebrew/apache
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll install Apache 2.2 with Apr and OpenSSL from Homebrew as well instead of utilizing the built-in versions of those tools.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v httpd22 --with-brewed-openssl
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll be using the file <em>~/Sites/httpd-vhosts.conf</em> to configure our VirtualHosts, so we create necessary directories and then include the file in <em>httpd.conf</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span> ! -d ~/Sites <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir -pv ~/Sites
</span><span class='line'>
</span><span class='line'>touch ~/Sites/httpd-vhosts.conf
</span><span class='line'>
</span><span class='line'><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> cat &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/apache2/2.2/httpd.conf <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s"># Include our VirtualHosts</span>
</span><span class='line'><span class="s">Include ${USERHOME}/Sites/httpd-vhosts.conf</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll create a folder for our logs in <em>~/Sites</em> as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span> ! -d ~/Sites/logs <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir -pv ~/Sites/logs
</span></code></pre></td></tr></table></div></figure>


<p>Now to fill in the contents of <em>~/Sites/httpd-vhosts.conf</em> that we included in <em>httpd.conf</em> earlier. Note that <strong>this is one command to copy and paste!</strong> Start with <code>USERHOME</code> through the second <code>EOF</code> has a single copy and paste block for the terminal.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> cat &gt; ~/Sites/httpd-vhosts.conf <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># Use name-based virtual hosting.</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s">NameVirtualHost *:80</span>
</span><span class='line'>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># Set up permissions for VirtualHosts in ~/Sites</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s">&lt;Directory &quot;${USERHOME}/Sites&quot;&gt;</span>
</span><span class='line'><span class="s">    Options Indexes FollowSymLinks MultiViews</span>
</span><span class='line'><span class="s">    AllowOverride All</span>
</span><span class='line'><span class="s">    Order allow,deny</span>
</span><span class='line'><span class="s">    Allow from all</span>
</span><span class='line'><span class="s">&lt;/Directory&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># For http://localhost in the users&#39; Sites folder</span>
</span><span class='line'><span class="s">&lt;VirtualHost _default_:80&gt;</span>
</span><span class='line'><span class="s">    ServerName localhost</span>
</span><span class='line'><span class="s">    DocumentRoot &quot;${USERHOME}/Sites&quot;</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># VirtualHosts</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'>
</span><span class='line'><span class="s">## Manual VirtualHost template</span>
</span><span class='line'><span class="s">#&lt;VirtualHost *:80&gt;</span>
</span><span class='line'><span class="s">#  ServerName project.dev</span>
</span><span class='line'><span class="s">#  CustomLog &quot;${USERHOME}/Sites/logs/project.dev-access_log&quot; combined</span>
</span><span class='line'><span class="s">#  ErrorLog &quot;${USERHOME}/Sites/logs/project.dev-error_log&quot;</span>
</span><span class='line'><span class="s">#  DocumentRoot &quot;${USERHOME}/Sites/project.dev&quot;</span>
</span><span class='line'><span class="s">#&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># Automatic VirtualHosts</span>
</span><span class='line'><span class="s"># A directory at ${USERHOME}/Sites/webroot can be accessed at http://webroot.dev</span>
</span><span class='line'><span class="s"># In Drupal, uncomment the line with: RewriteBase /</span>
</span><span class='line'>
</span><span class='line'><span class="s"># This log format will display the per-virtual-host as the first field followed by a typical log line</span>
</span><span class='line'><span class="s">LogFormat &quot;%V %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combinedmassvhost</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Auto-VirtualHosts with .dev</span>
</span><span class='line'><span class="s">&lt;VirtualHost *:80&gt;</span>
</span><span class='line'><span class="s">  ServerName dev</span>
</span><span class='line'><span class="s">  ServerAlias *.dev</span>
</span><span class='line'>
</span><span class='line'><span class="s">  CustomLog &quot;${USERHOME}/Sites/logs/dev-access_log&quot; combinedmassvhost</span>
</span><span class='line'><span class="s">  ErrorLog &quot;${USERHOME}/Sites/logs/dev-error_log&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">  VirtualDocumentRoot ${USERHOME}/Sites/%-2+</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Auto-VirtualHosts with xip.io</span>
</span><span class='line'><span class="s">&lt;VirtualHost *:80&gt;</span>
</span><span class='line'><span class="s">  ServerName xip</span>
</span><span class='line'><span class="s">  ServerAlias *.xip.io</span>
</span><span class='line'>
</span><span class='line'><span class="s">  CustomLog &quot;${USERHOME}/Sites/logs/dev-access_log&quot; combinedmassvhost</span>
</span><span class='line'><span class="s">  ErrorLog &quot;${USERHOME}/Sites/logs/dev-error_log&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">  VirtualDocumentRoot ${USERHOME}/Sites/%-7+</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run with port 80</h2>

<p>You may notice that <em>httpd.conf</em> is running Apache on port <strong>8080</strong>, but the <VirtualHosts> above are using port <strong>80</strong>. The next two commands will create and load a firewall rule to forward 8080 requests to 80. The end result is that we can use port 80 in VirtualHosts without needing to run Apache as root.</p>

<p>The following <strong>single</strong> command will create the file <em>/Library/LaunchDaemons/co.echo.httpdfwd.plist</em> as root, and owned by root, since it needs elevated privileges.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo bash -c <span class="s1">&#39;export TAB=$&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;\t&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">cat &gt; /Library/LaunchDaemons/co.echo.httpdfwd.plist &lt;&lt;EOF</span>
</span><span class='line'><span class="s1">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="s1">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
</span><span class='line'><span class="s1">&lt;plist version=&quot;1.0&quot;&gt;</span>
</span><span class='line'><span class="s1">&lt;dict&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;Label&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;string&gt;co.echo.httpdfwd&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;ProgramArguments&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;array&gt;</span>
</span><span class='line'><span class="s1">${TAB}${TAB}&lt;string&gt;sh&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}${TAB}&lt;string&gt;-c&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}${TAB}&lt;string&gt;ipfw add fwd 127.0.0.1,8080 tcp from any to me dst-port 80 in &amp;amp;&amp;amp; sysctl -w net.inet.ip.forwarding=1&lt;/string&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;/array&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;RunAtLoad&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;true/&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;key&gt;UserName&lt;/key&gt;</span>
</span><span class='line'><span class="s1">${TAB}&lt;string&gt;root&lt;/string&gt;</span>
</span><span class='line'><span class="s1">&lt;/dict&gt;</span>
</span><span class='line'><span class="s1">&lt;/plist&gt;</span>
</span><span class='line'><span class="s1">EOF&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This file will be loaded on login and set up the 80->8080 port forward, but we can load it manually now so we don&rsquo;t need to log out and back in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo launchctl load -w /Library/LaunchDaemons/co.echo.httpdfwd.plist
</span></code></pre></td></tr></table></div></figure>


<h1>PHP</h1>

<p>The following is for the latest release of PHP, version 5.5. If you&rsquo;d like to use 5.3, 5.4 or 5.6, simply change the &ldquo;5.5&rdquo; and &ldquo;php55&rdquo; values below appropriately. <em>(Note: if you use 5.3, the OpCache extension instructions are different. They will be posted below after the instructions for newer versions.)</em></p>

<p>Start by adding the PHP tap for Homebrew. PHP 5.3 needs an additional tap, so skip the second command if you are using 5.4 or higher.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew tap homebrew/php
</span><span class='line'>
</span><span class='line'><span class="c"># Skip this if using PHP 5.4 or higher</span>
</span><span class='line'>brew tap homebrew/versions
</span></code></pre></td></tr></table></div></figure>


<p>Install PHP and mod_php. This command will also load the PHP module in the <em>httpd.conf</em> file for you.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v php55 --homebrew-apxs --with-apache
</span></code></pre></td></tr></table></div></figure>


<p>Add PHP configuration to Apache&rsquo;s <em>httpd.conf</em> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/apache2/2.2/httpd.conf <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s"># Send PHP extensions to mod_php</span>
</span><span class='line'><span class="s">AddHandler php5-script .php</span>
</span><span class='line'><span class="s">AddType text/html .php</span>
</span><span class='line'><span class="s">DirectoryIndex index.php index.html</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set timezone and change other PHP settings (this is a <strong>single</strong> command). <code>sudo</code> is needed here to get the current timezone on OS X (in previous versions of OS X it wasn&rsquo;t needed, I&rsquo;m not sure why it is now).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;-default&#39;</span> <span class="s2">&quot;s|^;\(date\.timezone[[:space:]]*=\).*|\1 \&quot;$(sudo systemsetup -gettimezone|awk -F&quot;</span>: <span class="s2">&quot; &#39;{print $2}&#39;)\&quot;|; s|^\(memory_limit[[:space:]]*=\).*|\1 256M|; s|^\(post_max_size[[:space:]]*=\).*|\1 200M|; s|^\(upload_max_filesize[[:space:]]*=\).*|\1 100M|; s|^\(default_socket_timeout[[:space:]]*=\).*|\1 600|; s|^\(max_execution_time[[:space:]]*=\).*|\1 300|; s|^\(max_input_time[[:space:]]*=\).*|\1 600|;&quot;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.5/php.ini
</span></code></pre></td></tr></table></div></figure>


<p>Add a PHP error log; without this, you may get Internal Server Errors if PHP has errors to write and no logs to write to (this is a <strong>single</strong> command; be sure to copy and paste the lines containing <code>USERHOME</code> through the last <code>EOF</code> as a <strong>single</strong> command).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> cat &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.5/php.ini <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">; PHP Error log</span>
</span><span class='line'><span class="s">error_log = ${USERHOME}/Sites/logs/php-error_log</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>This weird little &ldquo;hack&rdquo; is needed to fix <a href="https://github.com/Homebrew/homebrew-php/issues/1039#issuecomment-41307694">a permissions problem</a> with using <code>pear</code> or <code>pecl</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch <span class="k">$(</span>brew --prefix php55<span class="k">)</span>/lib/php/.lock <span class="o">&amp;&amp;</span> chmod 0644 <span class="k">$(</span>brew --prefix php55<span class="k">)</span>/lib/php/.lock
</span></code></pre></td></tr></table></div></figure>


<p>The OpCache extension will speed up your PHP environment dramatically, and it&rsquo;s easy to install for 5.4 and higher. <strong>If you are looking to install PHP 5.3, skip this block.</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v php55-opcache
</span></code></pre></td></tr></table></div></figure>


<p><strong>Skip this block unless you are using PHP 5.3</strong>. Because there is no <em>php53-opcache</em> Homebrew formula, we can install it with <code>pecl</code> and replicate the same configuration file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pecl install zendopcache-beta
</span><span class='line'>
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s|^\(zend_extension=\&quot;\)\(opcache\.so\&quot;\)|\1$(php -r &#39;print(ini_get(&quot;</span>extension_dir<span class="s2">&quot;).&quot;</span>/<span class="s2">&quot;);&#39;)\2|&quot;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/php.ini
</span><span class='line'>
</span><span class='line'><span class="o">[</span> ! -d <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/conf.d <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir -pv <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/conf.d
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;[opcache]&quot;</span> &gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/conf.d/ext-opcache.ini
</span><span class='line'>
</span><span class='line'>grep -E <span class="s1">&#39;^zend_extension.*opcache\.so&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/php.ini &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/conf.d/ext-opcache.ini
</span><span class='line'>
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;/^zend_extension.*opcache\.so/d&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/php.ini
</span><span class='line'>
</span><span class='line'><span class="c"># &quot;php54&quot; is not a typo here- I&#39;m using a sample config file from</span>
</span><span class='line'><span class="c"># another recipe for my config file in php53</span>
</span><span class='line'>grep -E <span class="s1">&#39;^[[:space:]]*opcache\.&#39;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">$(</span>brew --prefix<span class="k">)</span>/Library/Taps/homebrew/homebrew-php/Formula/php54-opcache.rb <span class="se">\</span>
</span><span class='line'>  | sed <span class="s1">&#39;s/^[[:space:]]*//g&#39;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.3/conf.d/ext-opcache.ini
</span></code></pre></td></tr></table></div></figure>


<p>And continue with steps for all PHP versions: give OpCache some more memory to keep more opcode caches.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s|^\(opcache\.memory_consumption=\)[0-9]*|\1256|;&quot;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php/5.5/conf.d/ext-opcache.ini
</span></code></pre></td></tr></table></div></figure>


<h1>Start Apache</h1>

<p>Start Homebrew&rsquo;s Apache and set to start on boot.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ln -sfv <span class="k">$(</span>brew --prefix httpd22<span class="k">)</span>/homebrew.mxcl.httpd22.plist ~/Library/LaunchAgents
</span><span class='line'>
</span><span class='line'>launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.httpd22.plist
</span></code></pre></td></tr></table></div></figure>


<h1>DNSMasq</h1>

<p><a href="/blog/never-touch-your-local-etchosts-file-os-x-again">I&rsquo;ve covered this before</a>, but we&rsquo;ll list the commands here again for completeness. This example will have any DNS request ending in <em>.dev</em> reply with the IP address <em>127.0.0.1</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install -v dnsmasq
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;address=/.dev/127.0.0.1&#39;</span> &gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/dnsmasq.conf
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;listen-address=127.0.0.1&#39;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/dnsmasq.conf
</span></code></pre></td></tr></table></div></figure>


<p>Because DNS services run on a lower port, we need to have this run out of <em>/Library/LaunchDaemons</em>, so we do need to use <code>sudo</code> for the initial setup.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo cp -v <span class="k">$(</span>brew --prefix dnsmasq<span class="k">)</span>/homebrew.mxcl.dnsmasq.plist /Library/LaunchDaemons
</span><span class='line'>
</span><span class='line'>sudo launchctl load -w /Library/LaunchDaemons/homebrew.mxcl.dnsmasq.plist
</span></code></pre></td></tr></table></div></figure>


<p>With DNSMasq running, configure OS X to use your local host for DNS queries ending in <em>.dev</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo mkdir -v /etc/resolver
</span><span class='line'>
</span><span class='line'>sudo bash -c <span class="s1">&#39;echo &quot;nameserver 127.0.0.1&quot; &gt; /etc/resolver/dev&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Great! So, what did I do?</h1>

<p>We set up Apache to run on boot on port 8080 with mod_php with auto-VirtualHosts for directories in the <em>~/Sites</em> folder. The OS X firewall will forward all port 80 traffic to port 8080, so we don&rsquo;t have specify the port number when visiting web pages in web browsers. MySQL is installed and set to run on boot as well. DNSMasq and some OS X configuration is used to direct any hostname ending in <em>.dev</em> to the local system to work in conjunction with Apache&rsquo;s auto-VirtualHosts.</p>

<h2>What do I do now?</h2>

<p>You shouldn&rsquo;t need to edit the Apache configuration or edit /etc/hosts for new local development sites. Simply create a directory in <em>~/Sites</em> and then reference that foldername + .dev in your browser to access it.</p>

<p>For example, use <code>drush</code> to download Drupal 7 to the directory <em>~/Sites/firstproject</em>, and it can then be accessed at <em><a href="http://firstproject.dev/">http://firstproject.dev/</a></em> without any additional configuration. A caveat &ndash; you will need to uncomment the line in Drupal&rsquo;s .htaccess containing <strong>&ldquo;RewriteBase /&rdquo;</strong> to work with the auto-VirtualHosts configuration.</p>

<h2>What about this xip.io thing?</h2>

<p>If your Mac&rsquo;s LAN IP address is <em>192.168.0.10</em>, you can access sites from any other device on your local network using <em><a href="http://firstproject.192.168.0.10.xip.io/">http://firstproject.192.168.0.10.xip.io/</a></em>. You can test a websites on your Mac with your phone/tablet/etc. Pretty great, right?</p>

<h2>What if this &ldquo;auto-VirtualHost&rdquo; doesn&rsquo;t work for me?</h2>

<p>If you need to create a manual VirtualHost in Apache because the auto-VirtualHost does not work for your configuration, you may need to declare it before the auto-VirtualHosts if you&rsquo;re also going to use .dev as the TLD. Otherwise the auto-VirtualHost block will be accessed first.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/18/whats-the-deal-with-pressflow-7/">What&#8217;s the Deal With Pressflow 7?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-18T09:39:00-04:00" pubdate data-updated="true">Oct 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post originally featured on the <a href="http://echo.co/blog/whats-the-deal-with-pressflow-7">Echo &amp; Co. blog</a></em>.</p>

<p>Anyone who used Drupal 6 at scale knew that <a href="http://fourkitchens.com/pressflow-makes-drupal-scale">Pressflow 6</a> was pretty great. It forked Drupal and added several performance enhancements, including the ability to use external caches. Since <a href="https://pressflow.atlassian.net/wiki/display/PF/Comparison+-+Pressflow+versus+Drupal">Drupal 7 incorporated lots of the Pressflow 6 features</a>, what&rsquo;s the deal with Pressflow 7?</p>

<p>After Drupal 7 launched, <a href="http://developmentseed.org/blog/2010/jan/07/pressflow-7-continuing-push-performance-and-scalability-drupal/">it seemed like Pressflow 7 would continue the momentum from Pressflow 6 and greatly enhance Drupal 7</a>. But, here we are in 2013, and you don&rsquo;t hear about Pressflow 7 very often, and searching for differences does not yield much more than some diffs between baseline Drupal core 7 and <a href="https://github.com/pressflow/7">the Pressflow 7 repository on GitHub</a>. Since there are clearly some differences, let&rsquo;s dive in and see what they are exactly.</p>

<ul>
<li><em>Pressflow Smart Start</em> will forward you to the install page if the database is set up in settings.php but the database is empty, disabled by default.

<ul>
<li>Files: <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/includes/bootstrap.inc#L2428-L2437">includes/bootstrap.inc</a> and <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/sites/default/default.settings.php#L555-L562">sites/default/default.settings.php</a></li>
<li>Commit: <a href="https://github.com/pressflow/7/commit/fa91b2fc80741cb8c42c2db618f0ef0ad890f4cc">https://github.com/pressflow/7/commit/fa91b2fc80741cb8c42c2db618f0ef0ad890f4cc</a></li>
</ul>
</li>
<li>Allow for environmental PRESSFLOW_SETTINGS to override settings.php; settings must be entered as a JSON array.

<ul>
<li>File: <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/includes/bootstrap.inc#L716-L730">includes/bootstrap.inc</a></li>
<li>Commits: <a href="https://github.com/pressflow/7/commit/673fb0bdab618f8989365012149c76b8397f95d6">https://github.com/pressflow/7/commit/673fb0bdab618f8989365012149c76b8397f95d6</a> (Pull request: <a href="https://github.com/pressflow/7/pull/7">https://github.com/pressflow/7/pull/7</a>), and <a href="https://github.com/pressflow/7/commit/953e6608b34975eaa0c8abed8a90f80d22f1b967">https://github.com/pressflow/7/commit/953e6608b34975eaa0c8abed8a90f80d22f1b967</a></li>
</ul>
</li>
<li>APC CSS and JS check; to prevent Drupal from constantly checking the file system for core-aggregated CSS and JS files, use APC as a key:value store instead. This is very helpful improving performance for networked file systems by reducing the frequency Drupal hits the file system.

<ul>
<li>File: <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/includes/common.inc#L4896-L4908">includes/common.inc</a> (also see lines <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/includes/common.inc#L3558">3558</a> and <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/includes/common.inc#L4949">4949</a>)</li>
<li>Commit: <a href="https://github.com/pressflow/7/commit/e2f9d2b10b4f0c5f61f120be145621913c6794a4">https://github.com/pressflow/7/commit/e2f9d2b10b4f0c5f61f120be145621913c6794a4</a> (Pull request: <a href="https://github.com/pressflow/7/pull/16/files,">https://github.com/pressflow/7/pull/16/files,</a> original pull request: <a href="https://github.com/pantheon-systems/drops-7/pull/4">https://github.com/pantheon-systems/drops-7/pull/4</a>)</li>
</ul>
</li>
<li>Allow modules to act on the js_cache before writing to disk, and add a note to the aggregated JavaScript that it was built with PressFlow. This won&rsquo;t yield an immediate impact on anything, but adds additional functionality to modules.

<ul>
<li>Files: <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/includes/common.inc#L4958-L4959">includes/common.inc</a> and <a href="https://github.com/pressflow/7/blob/d1e3c87ab8edc207b1adbf88c6484218bcc0fa70/modules/system/system.api.php#L750-L768">modules/system/system.api.php</a></li>
<li>Commit: <a href="https://github.com/pressflow/7/commit/53098cf059236110716ca97c18565a178c458b43">https://github.com/pressflow/7/commit/53098cf059236110716ca97c18565a178c458b43</a></li>
</ul>
</li>
<li>Allow sub-second delays for lock_wait(). The calculation Drupal currently does will allow a value of 0 for the lock wait time, effectively skipping it. When PHP converts to an integer, a float will always round down. For example, as Drupal performs the operation: <code>php -r "echo (int) 0.25 * 20;"</code> would return <code>0</code>. The Pressflow change corrects the order of operations and returns the correct value, for example: <code>php -r "echo (int) (0.25 * 20);"</code> would return <code>5</code>, allowing for sub-second delays to be used as an input to the function.

<ul>
<li>File: <a href="https://github.com/pressflow/7/blob/2cd4323946987608a660694df2c02f3cb4cce6c3/includes/lock.inc#L217">includes/lock.inc</a></li>
<li>Commit: <a href="https://github.com/pressflow/7/commit/2cd4323946987608a660694df2c02f3cb4cce6c3">https://github.com/pressflow/7/commit/2cd4323946987608a660694df2c02f3cb4cce6c3</a></li>
</ul>
</li>
</ul>


<p>A full diff as of October 2013 can be found at <a href="https://gist.github.com/alanthing/6064500">https://gist.github.com/alanthing/6064500</a> for further reading. Original post at <a href="http://drupal.stackexchange.com/a/80138/10865">drupal.stackexchange.com</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/11/creating-php-packages-software-collection/">Creating PHP Packages as a Software Collection</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-11T22:33:00-04:00" pubdate data-updated="true">Jul 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Maintaining multiple versions of software can be tricky. Most of the explanations I have come across suggest using the version provided by your Linux distribution and installing others from source using a custom path, like <code>./configure --prefix=/opt/php-5.3.26; make; make install</code>, but it&rsquo;s not pleasant to update, manage small sub-packages, or make init.d scripts. The ideal option is to use packages that install to another location alongside the defaults, but hacking up spec files to override the default RPM macros like <code>%configure</code> (for CentOS and RHEL anyway) is not fun. This is where <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/">Red Hat Software Collections</a> come in to play. While Red Hat recently announced the <a href="http://www.redhat.com/about/news/archive/2013/6/red-hat-software-collections-1.0-beta-now-available">Red Hat Software Collections 1.0 Beta</a> for alternate versions of PHP, Perl, MySQL, and more, let&rsquo;s step through how to create your own Software Collection, or SCL. I&rsquo;ll show how to create PHP 5.3.26 to be installed in /opt/rh/ by converting existing SPEC files, and I&rsquo;ll also include diff files for how I built PHP 5.2.17 as an SCL.</p>

<p>If you&rsquo;re just here to get RPMs and don&rsquo;t much care for how they were made, or if you&rsquo;d like to get the source RPMs and learn for yourself, you can visit our repository and get whatever you&rsquo;d like, including Yum repos:</p>

<ul>
<li><a href="http://yum.echoditto.com/php53/">http://yum.echoditto.com/php53/</a></li>
<li><a href="http://yum.echoditto.com/php52/">http://yum.echoditto.com/php52/</a></li>
</ul>


<p>Before I get too deep into the instructions, I&rsquo;d like to share the resources I used:</p>

<ul>
<li><a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/sect-Converting_a_Conventional_Spec_File.html">Red Hat&rsquo;s documentation on converting SPEC files to SCLs</a></li>
<li><a href="http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/">PHP 5.4 SCL SRPMs</a> from <a href="http://blog.famillecollet.com/post/2012/11/20/PHP-5.4-as-Software-Collection">Remi Collet</a></li>
<li><a href="http://www2.atomicorp.com/channels/source/php/">PHP 5.3 SRPMs from AtomiCorp</a>, because I wanted <a href="http://php.net/manual/en/book.mysqlnd.php">mysqlnd</a> and didn&rsquo;t want to hack up the Red Hat SPEC to add it</li>
<li><a href="http://centos.alt.ru/pub/repository/centos/5/SRPMS/">PHP 5.2 SRPMs from alt.ru</a>, which contains many backported patches and PHP-FPM</li>
</ul>


<p>An important point to be learned is: <strong>Software Collections are essentially easy-to-use RPM macros</strong> that make installing packages into non-standard directories a piece of cake. As I explain various steps, I&rsquo;ll attempt to explain how the Software Collections function and how I&rsquo;ve seen others set them up so we&rsquo;re following best practices in ours.</p>

<h2>Explaining the Software Collection base</h2>

<p>Every Software Collection needs a base package that sets up the directory structure for the packages. When you use Red Hat&rsquo;s method of building SCLs, specifically via the <em>scl-utils-build</em> package, the base package will create <strong>/opt/rh/%{scl_prefix}/root</strong> with subdirectories like bin/, usr/, etc/, as so on.</p>

<p>For the SCL named <em>php53</em>, here is the base directory structure:</p>

<pre>
/opt/rh/php53/root/bin
/opt/rh/php53/root/boot
/opt/rh/php53/root/dev
/opt/rh/php53/root/etc
/opt/rh/php53/root/home
/opt/rh/php53/root/lib
/opt/rh/php53/root/lib64
/opt/rh/php53/root/media
/opt/rh/php53/root/mnt
/opt/rh/php53/root/opt
/opt/rh/php53/root/proc
/opt/rh/php53/root/root
/opt/rh/php53/root/sbin
/opt/rh/php53/root/selinux
/opt/rh/php53/root/srv
/opt/rh/php53/root/sys
/opt/rh/php53/root/tmp
/opt/rh/php53/root/usr
/opt/rh/php53/root/var
</pre>


<p>Most of the SCLs I have seen contain an <code>enable</code> script at <strong>/opt/rh/%{scl_prefix}/enable</strong> that will add the binaries, man pages, and library paths to the session. In this case, running <code>source /opt/rh/php53/enable</code> will run the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/opt/rh/php52/root/usr/bin:/opt/rh/php52/root/usr/sbin:<span class="nv">$PATH</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/opt/rh/php52/root/usr/lib64:<span class="nv">$LD_LIBRARY_PATH</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MANPATH</span><span class="o">=</span>/opt/rh/php52/root/usr/share/man:<span class="nv">$MANPATH</span>
</span></code></pre></td></tr></table></div></figure>


<p>The base package will also create a <em>%{scl_prefix}-build</em> subpackage that creates RPM macros that will come in handy as the SPEC file is edited.</p>

<h2>Building the Software Collection base</h2>

<ul>
<li><p>Start with <a href="http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm">http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm</a> because it&rsquo;s ready for CentOS 5 and 6</p></li>
<li><p>Rename or copy php54.spec to php53.spec</p></li>
<li><p>Set the global variable <code>scl</code> to be <strong>php53</strong>:</p>

<pre><code>%global scl php53
</code></pre></li>
<li><p>If you haven&rsquo;t already, install <em>rpm-build</em> and <em>mock</em>, and you&rsquo;ll also need <em>scl-utils-build</em> for later:</p>

<pre><code>yum -y install rpm-build mock scl-utils-build
</code></pre></li>
<li><p>CentOS 5 needs additional rpmbuild options when using a CentOS 6 build host because <a href="https://fedoraproject.org/wiki/Features/StrongerHashes">CentOS 6 uses stronger hashes</a> by default</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" -bs --nodeps php53.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild -bs --nodeps php53.spec
</code></pre></li>
</ul>
</li>
<li><p>Build with mock (repeat el6 instructions for el5):</p>

<pre><code>mock -v -r epel-6-x86_64 php53-1-2.el5.src.rpm
</code></pre></li>
<li><p>Copy resulting files to local folder and create a local Yum repo to be used later (repeat el6 instructions for el5):</p>

<pre><code>mkdir -vp ~/rpmbuild/RPMS/repo/el6/{x86_64,SRPMS}
cp -va /var/lib/mock/epel-6-x86_64/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h2>Mock</h2>

<p>We used <code>mock</code> to build the SCL base package, and to make our lives significantly easier, we&rsquo;ll continue to use it with some modifications specific to our SCL.</p>

<p>For all remaining steps, unless there are specific notes for CentOS 5 and 6, repeat the 6/el6 instructions for 5/el5.</p>

<ul>
<li><p>Change to the mock configuration directory:</p>

<pre><code>cd /etc/mock
</code></pre></li>
<li><p>Copy the default EPEL files to new ones specific to our SCL:</p>

<pre><code>cp -a epel-6-x86_64.cfg epel-6-x86_64-scl-php53.cfg
</code></pre></li>
<li><p>Edit <em>epel-6-x86_64-scl-php53.cfg</em> and:</p>

<ul>
<li><p>Add <strong>-scl-php53</strong> to the existing value of <em>config_opts[&lsquo;root&rsquo;]</em>:</p>

<pre><code>config_opts['root'] = 'epel-6-x86_64-scl-php53'
</code></pre></li>
<li><p>CentOS 5 and 6 have different options for <em>config_opts[&lsquo;chroot_setup_cmd&rsquo;]</em>:</p>

<ul>
<li><p>CentOS 5: Add <strong>scl-utils-build php53-build</strong> the following to the existing value:</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install buildsys-build scl-utils-build php53-build'
</code></pre></li>
<li><p>CentOS 6: Change from &lsquo;groupinstall buildsys-build&rsquo; to <strong>install @buildsys-build scl-utils-build php53-build</strong> (the @ will grab the group and then still allow for non-group packages to be added):</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install @buildsys-build scl-utils-build php53-build'
</code></pre></li>
</ul>
</li>
</ul>
</li>
<li><p>Add the local repo where you left the files from the section above as a new repo; I added mine above <em>[base]</em>. <strong>Change /home/alan to the appropriate path for your system!</strong></p>

<pre><code>[localrepo-6-x86_64]
name=localrepo-6-x86_64
enabled=1
baseurl=file:///home/alan/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h2>PHP</h2>

<ul>
<li><p>Use latest php-5.3.x SRPM from <a href="http://www2.atomicorp.com/channels/source/php/">http://www2.atomicorp.com/channels/source/php/</a></p></li>
<li><p>Install the SRPM</p>

<pre><code>rpm -ivh php-5.3.26-19.art.src.rpm
</code></pre></li>
<li><p>Go to the SPECS folder, typically at <em>~/rpmbuild/SPECS</em>, and copy <em>php-art.spec</em> to <em>php.spec</em></p>

<pre><code>cp -v php-art.spec php.spec
</code></pre></li>
<li><p>Several changes are needed to add the SCL macros to the SPEC file; see the <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/sect-Converting_a_Conventional_Spec_File.html">Red Hat documentation</a>. Download my patch file for a full list of changes needed to convert AtomiCorp&rsquo;s PHP SPEC to one that can be used with and without SCL options: <a href="/files/php_scl.diff">php_scl.diff</a></p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php_scl.diff
</code></pre>

<p>Let&rsquo;s step through the changes:</p>

<ul>
<li><p>  The first section allows for variables beginning with <code>_root_</code> to be available if it&rsquo;s not being built with a SCL. As I said earlier, I heavily borrowed from Remi&rsquo;s PHP 5.4 SCL SRPM. The <code>_root_</code> macros are provided by the <em>scl-utils-build</em> package, but this block allows them to work if an SCL is not being used.</p>

<pre><code>+%if 0%{?scl:1}
+%scl_package php
+%else
+%global pkg_name          %{name}
+%global _root_sysconfdir  %{_sysconfdir}
+%global _root_bindir      %{_bindir}
+%global _root_sbindir     %{_sbindir}
+%global _root_includedir  %{_includedir}
+%global _root_libdir      %{_libdir}
+%global _root_prefix      %{_prefix}
+%if 0%{?rhel} &lt; 6
+%global _root_initddir    /etc
+%else
+%global _root_initddir    %{_initddir}
+%endif
+%endif
</code></pre></li>
<li><p>  These values allow you to use the SCL mod_php with the built-in version of Apache</p>

<pre><code>+%global _httpd_confdir     %{_root_sysconfdir}/httpd/conf.d
+%global _httpd_moddir      %{_libdir}/httpd/modules
+%global _root_httpd_moddir %{_root_libdir}/httpd/modules
</code></pre></li>
<li><p>  There are other changes scattered throughout the file to force using locations outside of the SCL, like:</p>

<pre><code>-%global httpd_mmn %(cat %{_includedir}/httpd/.mmn || echo missing-httpd-devel)
+%global httpd_mmn %(cat %{_root_includedir}/httpd/.mmn || echo missing-httpd-devel)
</code></pre></li>
<li><p>  In all of the <em>Name:</em> lines, add the macro <strong>%{?scl_prefix}</strong>, which will only be used when building an SCL. For example, if you use the SCL rpmbuild options, the common package here would be called <em>php53-php-common</em>, but without it would still be called <em>php-common</em>. This applies for the main <em>Name</em> and sub-packages. It&rsquo;s also used for <em>Obsoletes</em>, <em>Conflicts</em>, <em>Provides</em>, and <em>Requires</em>.</p>

<pre><code>-Name: %{phpname}
+Name: %{?scl_prefix}%{phpname}

-Obsoletes: php-mhash
-Conflicts: php-zend-optimizer
+Obsoletes: %{?scl_prefix}php-mhash
+Conflicts: %{?scl_prefix}php-zend-optimizer
</code></pre></li>
<li><p>  The main package would provide <em>mod_php</em> for the built-in Apache, so this addition prevents a collision of having both <code>php</code> and <code>php53-php</code> installed:</p>

<pre><code>+%if 0%{?scl:1}
+Conflicts: php53, php
+%else
 # php53
 Obsoletes: php53
+%endif
</code></pre></li>
<li><p>  As per the Red Hat documentation, a main package (not php, but php-common, since php-common is needed by every php package) must require the base package</p>

<pre><code>%{?scl:Requires:%scl_runtime}
</code></pre></li>
<li><p>  The AtomiCorp SPEC is carefully designed to prevent conflicts with the CentOS 5 packages called <em>php53</em> that are not part of an SCL. I added a change to only keep the <em>Obsoletes</em> if it&rsquo;s not an SCL</p>

<pre><code>+%if 0%{?!scl:1}
 Obsoletes: php53-imap
+%endif
</code></pre></li>
<li><p>  I made a few improvements that aren&rsquo;t related to SCL. I won&rsquo;t list them all here, but one that I noticed was that libevent is no longer needed after PHP 5.3.4, as my comment suggests explaining why I comment it out:</p>

<pre><code>+# libevent needed *until* 5.3.4, see http://bugzilla.redhat.com/show_bug.cgi?id=835671
+#BuildRequires: libevent-devel &gt;= 1.4.11
</code></pre></li>
<li><p>  A lot of the compile options will use the built-in libraries, like:</p>

<pre><code>- --with-freetype-dir=%{_prefix} \
- --with-png-dir=%{_prefix} \
- --with-xpm-dir=%{_prefix} \
+ --with-freetype-dir=%{_root_prefix} \
+ --with-png-dir=%{_root_prefix} \
+ --with-xpm-dir=%{_root_prefix} \
</code></pre></li>
<li><p>  In a few places I use <code>sed</code> to fix config files, here&rsquo;s one where I ensure the SCL root is used for the <em>session.save_path</em> by changing <em>/var/lib</em> to <em>%{_localstatedir}/lib</em></p>

<pre><code>-%{__sed} -e '/session.save_path/s/php/%{phpname}/' %{SOURCE2} &gt;$RPM_BUILD_ROOT%{_sysconfdir}/php.ini
+%{__sed} -e 's|/var/lib/php/session|%{_localstatedir}/lib/%{phpname}/session|' %{SOURCE2} &gt;$RPM_BUILD_ROOT%{_sysconfdir}/php.ini
</code></pre></li>
<li><p>  Instead of installing the Apache module files in the system default directories, I decided to keep them in the SCL root and create symbolic links, though I do put the mod_php Apache configuration file in /etc/httpd/conf.d</p>

<pre><code>-  &gt;$RPM_BUILD_ROOT/%{_origsysconfdir}/httpd/conf.d/%{phpname}.conf
+  &gt;$RPM_BUILD_ROOT/%{_httpd_confdir}/%{?scl_prefix}%{phpname}.conf
+%endif
+
+# Symlink SCL DSOs into real httpd moddir, mod_php config into real httpd config directory
+%if %{?scl:1}0
+install -m 755 -d $RPM_BUILD_ROOT%{_root_httpd_moddir}
+install -m 755 -d $RPM_BUILD_ROOT%{_httpd_confdir}
+%if %{phpname} == php
+ln -s %{_httpd_moddir}/libphp5.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/libphp5.so
+ln -s %{_httpd_moddir}/libphp5-zts.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/libphp5-zts.so
+%else
+ln -s %{_httpd_moddir}/libphp5.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/lib%{phpname}.so
+ln -s %{_httpd_moddir}/libphp5-zts.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/lib%{phpname}-zts.so
+%endif
 %endif
</code></pre></li>
<li><p>  A common practice I observed in other SCL files was putting the init.d script in <em>/etc/init.d</em> instead of the SCL root with prepending the SCL name. For example, if you build with SCL options, the PHP-FPM script would be at <em>/etc/init.d/php53-php-fpm</em>, or without it would be <em>/etc/init.d/php-fpm</em>, either one using the correct paths:</p>

<pre><code>-install -m 755 -d $RPM_BUILD_ROOT%{_originitdir}
-install -m 755 %{SOURCE6} $RPM_BUILD_ROOT%{_originitdir}/php-fpm
+install -m 755 -d $RPM_BUILD_ROOT%{_root_initddir}
+install -m 755 %{SOURCE6} $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
+sed -e '/daemon/s:php-fpm:/usr/sbin/php-fpm:' \
+    -i $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
+sed -e '/php-fpm.pid/s:/var:%{_localstatedir}:' \
+    -e '/subsys/s/php-fpm/%{?scl_prefix}%{phpname}-fpm/' \
+    -e 's:/etc/sysconfig/php-fpm:%{_sysconfdir}/sysconfig/%{phpname}-fpm:' \
+    -e 's:/etc/php-fpm.conf:%{_sysconfdir}/%{phpname}-fpm.conf:' \
+    -e 's:/usr/sbin:%{_sbindir}:' \
+    -i $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
</code></pre></li>
<li><p>  Same concept for logrotate configs:</p>

<pre><code> # LogRotate
-install -m 755 -d $RPM_BUILD_ROOT%{_origsysconfdir}/logrotate.d
-install -m 644 %{SOURCE7} $RPM_BUILD_ROOT%{_origsysconfdir}/logrotate.d/php-fpm
+install -m 755 -d $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d
+install -m 644 %{SOURCE7} $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d/%{?scl_prefix}%{phpname}-fpm
+sed -e 's:/var:%{_localstatedir}:' \
+    -i $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d/%{?scl_prefix}%{phpname}-fpm
</code></pre></li>
<li><p>  While you can <code>source</code> the <em>enable</em> script to get the SCL binaries in your $PATH, we can also create symlinks with the SCL prefix in system folders. This is ideal if you would only need occasional access to the SCL binary, then you could use <code>php53-php</code> instead of <code>/opt/rh/php53/root/usr/bin/php</code>:</p>

<pre><code>+# make the cli commands available in standard root for SCL build
+%if 0%{?scl:1}
+install -m 755 -d $RPM_BUILD_ROOT%{_root_bindir}
+ln -s %{_bindir}/php       $RPM_BUILD_ROOT%{_root_bindir}/%{?scl_prefix}php
+ln -s %{_bindir}/phar.phar $RPM_BUILD_ROOT%{_root_bindir}/%{?scl_prefix}phar
+%endif
</code></pre></li>
<li><p>  You have previously seen <code>if 0%{?scl:1}</code> as a way to define an if block if an SCL is being built. For single lines, you can use  <code>%{?scl: --item--}</code>, like conditionally adding directories:</p>

<pre><code>-%{_libdir}/httpd/modules/libphp5.so
-%{_libdir}/httpd/modules/libphp5-zts.so
+%{?scl: %dir %{_httpd_moddir}}
+%{_httpd_moddir}/libphp5.so
+%{?scl: %{_root_httpd_moddir}/libphp5.so}
+%{_httpd_moddir}/libphp5-zts.so
+%{?scl: %{_root_httpd_moddir}/libphp5-zts.so}
</code></pre></li>
<li><p>  <strong>TL;DR:</strong> Read through the diff file, but you&rsquo;re making the SPEC file to be compatible with and without SCL build options. This is great because you don&rsquo;t have to maintain a second SPEC file for building SCL packages. There are several conditions that if you are using an SCL, you can have files/scripts outside of the SCL root, like init.d scripts, logrotate configs, symlinks to binaries, etc.</p></li>
</ul>
</li>
<li><p>Apply the diff file as a patch to the AtomiCorp SPEC file. I&rsquo;m ignoring whitespace because the text editor I used (Sublime Text) removed some spaces for me.</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM. The <strong>&mdash;define &ldquo;scl php53&rdquo;</strong> option enables the Software Collection (without it, you&rsquo;d be building PHP packages that install into system default paths), <strong>-bs</strong> will only build a source package, and <strong>&mdash;nodeps</strong> will not check for <em>Requires</em> or <em>BuildRequires</em> on the build system (we&rsquo;ll use <code>mock</code> to build the binary RPMs and it will install required packages into the chroot):</p>

<ul>
<li><p>CentOS 5: Use MD5 for checksums:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> with the new chroot configurations we created in <em>/etc/mock</em> earlier:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-5.3.26-19.el6.src.rpm
</code></pre></li>
<li><p>After several minutes, you should have ready-to-install binary packages in <em>/var/lib/mock/epel-6-x86_64-scl-php53/result/</em>. We&rsquo;ll need some of them to build other packages, like PEAR, APC, Memcache, etc, so we&rsquo;ll add them to our local Yum repo we set up earlier (and this location will serve as where we collect all of our completed RPMs):</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre>

<p>At this point, you should have several packages in <em>~/rpmbuild/RPMS/repo/el6/x86_64</em>. You&rsquo;ll generally want to copy completed .rpm files out of /var/lib/mock as soon as they&rsquo;re finished being built so they aren&rsquo;t destroyed the next time to run <code>mock</code> with the same chroot (option <em>-r</em>).</p></li>
</ul>


<h2>PEAR</h2>

<ul>
<li><p>Get latest php-pear from Red Hat at <a href="http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/">http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/</a> and install:</p>

<pre><code>rpm -ivh php-pear-1.9.4-4.el6.src.rpm
</code></pre></li>
<li><p>Grab <a href="/files/php-pear_scl.diff">php-pear_scl.diff</a> to use with <code>patch</code> to convert the SPEC file for use with SCL:</p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php-pear_scl.diff
</code></pre>

<ul>
<li><p>I won&rsquo;t rehash with the same amount of detail as we covered for <em>php.spec</em>, but as a quick summary, this patch file will:</p></li>
<li><p>Define the SCL package name:</p>

<pre><code>+%{?scl:%scl_package php-pear}
+%{!?scl:%global pkg_name %{name}}
</code></pre></li>
<li><p>Add <code>%{scl_prefix}</code> to <em>Name</em>, <em>Requires</em>, <em>BuildRequires</em>, <em>Obsoletes</em>, <em>Conflicts</em>, and <em>Provides</em>. Here&rsquo;s one example:</p>

<pre><code>-Name: php-pear
+Name: %{?scl_prefix}php-pear
</code></pre></li>
<li><p>Add <code>%{?scl:Requires: %scl_runtime}</code> so the SCL Base Package is a requirement:</p>

<pre><code>+%{?scl:Requires: %scl_runtime}
</code></pre></li>
<li><p>Some macros need to use the system default paths. Remember, <code>%{_root_*}</code>-style macros are provided by the <em>scl-utils-build</em> package:</p>

<pre><code>-export PHP_PEAR_SIG_BIN=%{_bindir}/gpg
+export PHP_PEAR_SIG_BIN=%{_root_bindir}/gpg
</code></pre></li>
<li><p>The executable scripts for PEAR need to use the actual rpm macro instead of static paths like &ldquo;/usr&rdquo;:</p>

<pre><code>+for exe in pear pecl peardev; do
+    sed -e 's:/usr:%{_prefix}:' \
+        -i $RPM_BUILD_ROOT%{_bindir}/$exe
+done
</code></pre></li>
<li><p>Make symbolic links in the system default directories for the SCL executables:</p>

<pre><code>+# make the cli commands available in standard root for SCL build
+%if 0%{?scl:1}
+install -m 755 -d $RPM_BUILD_ROOT%{_root_bindir}
+ln -s %{_bindir}/pear      $RPM_BUILD_ROOT%{_root_bindir}/%{scl_prefix}pear
+ln -s %{_bindir}/pecl      $RPM_BUILD_ROOT%{_root_bindir}/%{scl_prefix}pecl
+%endif
</code></pre></li>
</ul>
</li>
<li><p>Apply the diff file as a patch to the Red Hat SPEC file:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php-pear_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php-pear.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php-pear.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> build the packages in our SCL chroot:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-pear-1.9.4-4.el6.src.rpm
</code></pre></li>
<li><p>Copy the files to the local Yum repo folder where we&rsquo;re keeping all of our completed RPMs:</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</code></pre></li>
<li><p>Since APC and Memcache will need <em>php53-php-pear</em> as a build dependency, we&rsquo;ll need to update the Yum repo files:</p>

<pre><code>createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h2>APC</h2>

<p>For the remaining packages, I will skip explaining the differences in the SPEC files and simply list the commands. If you look at the diff patch for <em>php-pecl-apc.spec</em>, you&rsquo;ll notice that it&rsquo;s very similar to the changes made for PEAR.</p>

<ul>
<li><p>Get latest php-pecl-apc from Red Hat at <a href="http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/">http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/</a> and install:</p>

<pre><code>rpm -ivh php-pecl-apc-3.1.9-2.el6.src.rpm
</code></pre></li>
<li><p>Grab <a href="/files/php-pecl-apc_scl.diff">php-pecl-apc_scl.diff</a> to use with <code>patch</code> to convert the SPEC file for use with SCL:</p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php-pecl-apc_scl.diff
</code></pre>

<ul>
<li><p>Actually, I will point out an important change in this spec file: adding the directory path in front of <code>php</code> and <code>php-config</code> to ensure we&rsquo;re using the SCL binary and not the system default <code>php</code>:</p>

<pre><code>-%global php_zendabiver %((echo 0; php -i 2&gt;/dev/null | sed -n 's/^PHP Extension =&gt; //p') | tail -1)
-%global php_version %((echo 0; php-config --version 2&gt;/dev/null) | tail -1)
+%global php_zendabiver %((echo 0; %{_bindir}/php -i 2&gt;/dev/null | sed -n 's/^PHP Extension =&gt; //p') | tail -1)
+%global php_version %((echo 0; %{_bindir}/php-config --version 2&gt;/dev/null) | tail -1)
</code></pre></li>
</ul>
</li>
<li><p>Apply the diff file as a patch to the Red Hat SPEC file:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php-pecl-apc_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php-pecl-apc.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php-pecl-apc.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> build the packages in our SCL chroot:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-pecl-apc-3.1.9-2.el6.src.rpm
</code></pre></li>
<li><p>Copy the files to the local Yum repo folder where we&rsquo;re keeping all of our completed RPMs:</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</code></pre></li>
<li><p>No other packages require the completed RPMs to build, so we skip the <code>createrepo</code> command here and move onto the next page.</p></li>
</ul>


<h2>Memcache</h2>

<p>We&rsquo;re going to upgrade php-pecl-memcache from 3.0.5 to 3.0.8. Both are considered &ldquo;beta&rdquo; on <a href="http://pecl.php.net/package/memcache">pecl.php.net</a> so it&rsquo;s not like we&rsquo;re losing stability, but we are gaining features.</p>

<ul>
<li><p>Get latest php-pecl-memcache from Red Hat at <a href="http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/">http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/</a> and install:</p>

<pre><code>rpm -ivh php-pecl-memcache-3.0.5-4.el6.src.rpm
</code></pre></li>
<li><p>Grab <a href="/files/php-pecl-memcache_scl.diff">php-pecl-memcache_scl.diff</a> to use with <code>patch</code> to convert the SPEC file for use with SCL:</p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php-pecl-memcache_scl.diff
</code></pre></li>
<li><p>Download the <a href="http://pecl.php.net/get/memcache-3.0.8.tgz">memcache 3.0.8 source</a> from the PECL website into the ~/rpmbuild/SOURCES directory</p>

<pre><code>curl --output ~/rpmbuild/SOURCES/memcache-3.0.8.tgz --location http://pecl.php.net/get/memcache-3.0.8.tgz
</code></pre></li>
<li><p>Apply the diff file as a patch to the Red Hat SPEC file, which will upgrade 3.0.5 to 3.0.8 and remove the need for 3 patches:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php-pecl-memcache_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php-pecl-memcache.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php-pecl-memcache.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> build the packages in our SCL chroot:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-pecl-memcache-3.0.8-1.el6.src.rpm
</code></pre></li>
<li><p>Copy the files to the local Yum repo folder where we&rsquo;re keeping all of our completed RPMs:</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</code></pre></li>
</ul>


<h2>PHP 5.3 SCL Completed</h2>

<p>You should now have several binary RPMs in <em>~/rpmbuild/RPMS/repo/el6/x86_64</em> ready to be installed as a Software Collection. If you want to distribute your SRPMs, you&rsquo;ll probably want to use the ones generated by <code>mock</code> that are in <em>~/rpmbuild/RPMS/repo/el6/SRPMS</em>.</p>

<h2>PHP 5.2</h2>

<p>PHP 5.2 is quite old, but if 5.3 or higher broke compatibility with old websites, you can install PHP 5.2 as a Software Collection and use PHP-FPM to use only the older version for a specific website. As previously mentioned, I&rsquo;m using a SRPM that has backported patches (presumably from <a href="https://code.google.com/p/php52-backports/">https://code.google.com/p/php52-backports/</a>), so it&rsquo;s certainly more up-to-date than <a href="http://php.net/releases/index.php">the last 5.2 release from php.net</a> (Released: 06 January 2011).</p>

<p>I won&rsquo;t go into detail of the diff patches since they are largely similar to the changes made on the PHP 5.3 SPECs.</p>

<h3>Software Collection base</h3>

<ul>
<li><p>As with php53, start with <a href="http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm">http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm</a></p></li>
<li><p>Rename or copy php54.spec to php52.spec</p></li>
<li><p>Set the global variable <code>scl</code> to be <strong>php52</strong>:</p>

<pre><code>%global scl php52
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" -bs --nodeps php52.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild -bs --nodeps php52.spec
</code></pre></li>
</ul>
</li>
<li><p>Build with mock (repeat el6 instructions for el5):</p>

<pre><code>mock -v -r epel-6-x86_64 php52-1-2.el5.src.rpm
</code></pre></li>
<li><p>Copy resulting files to local folder and create a local Yum repo to be used later (repeat el6 instructions for el5):</p>

<pre><code>mkdir -vp ~/rpmbuild/RPMS/repo/el6/{x86_64,SRPMS}
cp -va /var/lib/mock/epel-6-x86_64/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h3>Mock</h3>

<p>These steps are nearly identical are for php53, but using php52 instead. As mentioned previously, if you need to repeat something for CentOS 5, use the CentOS 6 and change 6 to 5, el5 to el6, etc.</p>

<ul>
<li><p>Change to the mock configuration directory:</p>

<pre><code>cd /etc/mock
</code></pre></li>
<li><p>Copy the default EPEL files to new ones specific to our SCL:</p>

<pre><code>cp -a epel-6-x86_64.cfg epel-6-x86_64-scl-php52.cfg
</code></pre></li>
<li><p>Edit <em>epel-6-x86_64-scl-php52.cfg</em> and:</p>

<ul>
<li><p>Add <strong>-scl-php53</strong> to the existing value of <em>config_opts[&lsquo;root&rsquo;]</em>:</p>

<pre><code>config_opts['root'] = 'epel-6-x86_64-scl-php52'
</code></pre></li>
<li><p>CentOS 5 and 6 have different options for <em>config_opts[&lsquo;chroot_setup_cmd&rsquo;]</em>:</p>

<ul>
<li><p>CentOS 5: Add <strong>scl-utils-build php52-build</strong> the following to the existing value:</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install buildsys-build scl-utils-build php52-build'
</code></pre></li>
<li><p>CentOS 6: Change from &lsquo;groupinstall buildsys-build&rsquo; to <strong>install @buildsys-build scl-utils-build php52-build</strong>:</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install @buildsys-build scl-utils-build php52-build'
</code></pre></li>
</ul>
</li>
</ul>
</li>
<li><p>Add the local repo where you left the files from the section above as a new repo; I add mine above <em>[base]</em>. <strong>Change /home/alan to the appropriate path for your system!</strong></p>

<pre><code>[localrepo-6-x86_64]
name=localrepo-6-x86_64
enabled=1
baseurl=file:///home/alan/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h3>PHP</h3>

<ul>
<li><p>Use latest php-5.2.x SRPM from <a href="http://centos.alt.ru/pub/repository/centos/5/SRPMS/">http://centos.alt.ru/pub/repository/centos/5/SRPMS/</a></p></li>
<li><p>Install the SRPM</p>

<pre><code>rpm -ivh php-5.2.17-29.el5.src.rpm
</code></pre></li>
<li><p>Several changes are needed to add the SCL macros to the SPEC file; see the <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/sect-Converting_a_Conventional_Spec_File.html">Red Hat documentation</a>. Download my patch file for a full list of changes needed to convert the alt.ru PHP SPEC to one that can be used with and without SCL options: <a href="/files/php52_scl.diff">php52_scl.diff</a></p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php52_scl.diff
</code></pre></li>
<li><p>Apply the diff file as a patch to the alt.ru SPEC file:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php52_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php52" -bs --nodeps php.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php52" -bs --nodeps php.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> with the new chroot configurations we created in <em>/etc/mock</em> earlier:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php52 php52-php-5.2.17-29.el6.src.rpm
</code></pre></li>
<li><p>After <code>mock</code> is completed, copy the files to the local repo folder. Like before, we&rsquo;ll need some of these packages to build other packages:</p>

<pre><code>mkdir -vp ~/rpmbuild/RPMS/repo/el6/{SRPMS,x86_64}
cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h3>PEAR, APC, and Memcache</h3>

<p>You can repeat the same steps for php-pear, php-pecl-apc, and php-pecl-memcache as above for PHP 5.3. The only difference would be to change the SCL name during the <code>rpmbuild</code> and <code>mock</code> steps. Here are all of the steps without explanation:</p>

<h4>PEAR</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>curl --remote-name --location http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/php-pear-1.9.4-4.el6.src.rpm
</span><span class='line'>rpm -ivh php-pear-1.9.4-4.el6.src.rpm
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>curl --remote-name --location http://alanthing.com/files/php-pear_scl.diff
</span><span class='line'>patch -p0 --ignore-whitespace &lt; php-pear_scl.diff
</span><span class='line'>rpmbuild --define <span class="s2">&quot;scl php52&quot;</span> -bs --nodeps php-pear.spec
</span><span class='line'>mock -v -r epel-6-x86_64-scl-php52 php52-php-pear-1.9.4-4.el6.src.rpm
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.<span class="o">{</span>noarch,x86_64<span class="o">}</span>.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</span><span class='line'>createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</span></code></pre></td></tr></table></div></figure>


<h4>APC</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>curl --remote-name --location http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/php-pecl-apc-3.1.9-2.el6.src.rpm
</span><span class='line'>rpm -ivh php-pecl-apc-3.1.9-2.el6.src.rpm
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>curl --remote-name --location http://alanthing.com/files/php-pecl-apc_scl.diff
</span><span class='line'>patch -p0 --ignore-whitespace &lt; php-pecl-apc_scl.diff
</span><span class='line'>rpmbuild --define <span class="s2">&quot;scl php52&quot;</span> -bs --nodeps php-pecl-apc.spec
</span><span class='line'>mock -v -r epel-6-x86_64-scl-php52 php52-php-pecl-apc-3.1.9-2.el6.src.rpm
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.<span class="o">{</span>noarch,x86_64<span class="o">}</span>.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</span></code></pre></td></tr></table></div></figure>


<h4>Memcache</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>curl --remote-name --location http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/php-pecl-memcache-3.0.5-4.el6.src.rpm
</span><span class='line'>rpm -ivh php-pecl-memcache-3.0.5-4.el6.src.rpm
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>curl --remote-name --location http://alanthing.com/files/php-pecl-memcache_scl.diff
</span><span class='line'>curl --output ~/rpmbuild/SOURCES/memcache-3.0.8.tgz --location http://pecl.php.net/get/memcache-3.0.8.tgz
</span><span class='line'>patch -p0 --ignore-whitespace &lt; php-pecl-memcache_scl.diff
</span><span class='line'>rpmbuild --define <span class="s2">&quot;scl php52&quot;</span> -bs --nodeps php-pecl-memcache.spec
</span><span class='line'>mock -v -r epel-6-x86_64-scl-php52 php52-php-pecl-memcache-3.0.8-1.el6.src.rpm
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.<span class="o">{</span>noarch,x86_64<span class="o">}</span>.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>It does seem like a little bit of work to convert a SPEC file for SCL compatibility, but once the work is done, incremental updates are easy, and you can use the same SPEC to build a non-SCL package as well. I wouldn&rsquo;t be surprised if Red Hat begins to create SCL-compatible SPEC files for major applications in RHEL 7 and beyond because of the flexibility it offers, just see their <a href="http://www.redhat.com/about/news/archive/2013/6/red-hat-software-collections-1.0-beta-now-available">Red Hat Software Collections 1.0 Beta</a>. Unfortunately, it&rsquo;s difficult to fully grasp how to build one, so hopefully this guide has been helpful.</p>

<p>Personally, after having some trouble quickly switching from MySQL to MariaDB or Percona, I&rsquo;ll probably look to rebuild those as Software Collections instead of replacing the default packages, but that&rsquo;s another blog post!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/09/speed-up-php-on-nfs-with-turbo-realpath/">Speed Up PHP on NFS With Turbo_realpath</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-09T11:50:00-04:00" pubdate data-updated="true">May 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post originally featured on the <a href="http://echo.co/blog/speed-php-nfs-turborealpath">Echo &amp; Co. blog</a></em>.</p>

<p>If you run a website based on PHP, and have your source files on a network file system like NFS, OCFS2, or GlusterFS, and combine it with PHP&rsquo;s <a href="http://www.php.net/manual/en/ini.core.php#ini.open-basedir">open_basedir</a> protection, you&rsquo;ll quickly notice that the performance will degrade substantially. Normally, PHP can cache various path locations it learns after processing <a href="http://us2.php.net/manual/en/function.include-once.php">include_once</a> and <a href="http://us2.php.net/manual/en/function.require-once.php">require_once</a> calls via the <a href="http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-size">realpath_cache</a>. There&rsquo;s a <a href="https://bugs.php.net/bug.php?id=52312">bug in PHP</a> that effectively disables the realpath_cache entirely when combined with open_basedir. Popular PHP applications with Drupal and WordPress make heavy use of these functions to include other files, so you would very quickly notice the drop in performance in this scenario. If you want to isolate your websites from each other (or from the rest of the operating system), how can you retain any shred of performance?</p>

<p>This is where <a href="http://php.webtutor.pl/">Artur Graniszewski</a>&rsquo;s <a href="http://php.webtutor.pl/en/2011/07/12/running-php-on-nfs-version-1-2-of-turbo_realpath-extension/">turbo_realpath</a> extension really comes in handy. I won&rsquo;t retype his installation instructions, so follow the previous link to get it installed manually.</p>

<p>If you&rsquo;re running CentOS 5 or CentOS 6, check out <a href="http://yum.echoditto.com/">yum.echoditto.com</a> and you&rsquo;ll find source and compiled RPMs that will install alongside the RedHat/CentOS-supplied PHP packages. The RPM will create a basic configuration file at <code>/etc/php.d/turbo_realpath.ini</code>. Essentially, it enables the PHP module but defaults all settings off, so you will need to read the comments (taken from <a href="http://php.webtutor.pl/en/2011/07/12/running-php-on-nfs-version-1-2-of-turbo_realpath-extension/">Artur&rsquo;s most recent post on turbo_realpath</a>) to determine how you want to use it.</p>

<h1>Configuration</h1>

<p>We frequently use turbo_realpath on a per-VirtualHost basis with Apache 2.2 and mod_php. If you use PHP-FPM, you can apply similar settings in your FPM pool configuration files. If you install our RPM and don&rsquo;t edit <code>/etc/php.d/turbo_realpath.ini</code>, add something similar to the following to each VirtualHost:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nt">&lt;IfModule</span> <span class="s">php5_module</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">php_admin_value</span> realpath_cache_basedir <span class="s2">&quot;/var/www/vhosts/domain.com:/usr/share/pear:/usr/share/php:/usr/lib64/php:/usr/lib/php:/tmp:/var/tmp&quot;</span>
</span><span class='line'><span class="nt">&lt;/IfModule&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is effectively the same using <code>open_basedir</code>; any directories referenced in <code>realpath_cache_basedir</code> will be the only ones the website is allowed to access, and they will be cached as determined by the <a href="http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-size">realpath_cache_size</a> and <a href="http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-ttl">realpath_cache_ttl</a>. If you look in <code>php.ini</code>, you may notice the default values for these are:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="c1">; Determines the size of the realpath cache to be used by PHP. This value should</span>
</span><span class='line'><span class="c1">; http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-size</span>
</span><span class='line'><span class="na">realpath_cache_size</span> <span class="o">=</span> <span class="s">16k</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; Duration of time, in seconds for which to cache realpath information for a given</span>
</span><span class='line'><span class="c1">; http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-ttl</span>
</span><span class='line'><span class="na">realpath_cache_ttl</span> <span class="o">=</span> <span class="s">120</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may want to increase these if you&rsquo;re finding your website is still not loading quickly. On our systems, we have bumped the <code>realpath_cache_size</code> and <code>realpath_cache_ttl</code> settings up to <code>1m</code> and <code>300</code>, respectively.</p>

<h1>Speed and Security!</h1>

<p>With turbo_realpath enabled, <code>realpath_cache_basedir</code> set to appropriate <code>open_basedir</code>-like values, and <code>realpath_cache_size</code> and <code>realpath_cache_ttl</code> increased from defaults, we&rsquo;re able to have isolated PHP sites and have better performance by caching the locations of included/required files effectively. Hopefully, our RPMs will help you on your system for a quick installation of the excellent turbo_realpath module!</p>

<h1>References</h1>

<ul>
<li><a href="http://php.webtutor.pl/en/2011/06/02/running-php-on-nfs-huge-performance-problems-and-one-simple-solution/">Running PHP on NFS: huge performance problems and one simple solution.</a></li>
<li><a href="http://php.webtutor.pl/en/2011/07/01/running-php-on-nfs-new-version-of-turbo_realpath-extension/">Running PHP on NFS: new version of turbo_realpath extension</a></li>
<li><a href="http://php.webtutor.pl/en/2011/07/12/running-php-on-nfs-version-1-2-of-turbo_realpath-extension/">Running PHP on NFS: version 1.2 of turbo_realpath extension</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/02/03/yubikey-login-fedora-u2f-authselect/">Yubikey Login to Fedora With U2F via Authselect</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/20/certbot-on-centos-6/">Certbot on CentOS 6</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/21/python-3-and-uwsgi-on-centos-7/">Python 3 and uWSGI on CentOS 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/15/robots-dot-txt-disallow-all-with-nginx/">Robots.txt Disallow All With Nginx</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/03/auto-restart-tomcat-with-systemd/">Auto-restart Tomcat With Systemd</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/alanthing">@alanthing</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'alanthing',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Alan Ivey -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'alanthing';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
