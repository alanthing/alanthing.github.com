
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>alanthing</title>
  <meta name="author" content="Alan Ivey">

  
  <meta name="description" content="Maintaining multiple versions of software can be tricky. Most of the explanations I have come across suggest using the version provided by your Linux &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alanthing.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="alanthing" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34327970-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">alanthing</a></h1>
  
    <h2>Linux and other things</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alanthing.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/11/creating-php-packages-software-collection/">Creating PHP Packages as a Software Collection</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-11T22:33:00-04:00" pubdate data-updated="true">Jul 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Maintaining multiple versions of software can be tricky. Most of the explanations I have come across suggest using the version provided by your Linux distribution and installing others from source using a custom path, like <code>./configure --prefix=/opt/php-5.3.26; make; make install</code>, but it&rsquo;s not pleasant to update, manage small sub-packages, or make init.d scripts. The ideal option is to use packages that install to another location alongside the defaults, but hacking up spec files to override the default RPM macros like <code>%configure</code> (for CentOS and RHEL anyway) is not fun. This is where <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/">Red Hat Software Collections</a> come in to play. While Red Hat recently announced the <a href="http://www.redhat.com/about/news/archive/2013/6/red-hat-software-collections-1.0-beta-now-available">Red Hat Software Collections 1.0 Beta</a> for alternate versions of PHP, Perl, MySQL, and more, let&rsquo;s step through how to create your own Software Collection, or SCL. I&rsquo;ll show how to create PHP 5.3.26 to be installed in /opt/rh/ by converting existing SPEC files, and I&rsquo;ll also include diff files for how I built PHP 5.2.17 as an SCL.</p>

<p>If you&rsquo;re just here to get RPMs and don&rsquo;t much care for how they were made, or if you&rsquo;d like to get the source RPMs and learn for yourself, you can visit our repository and get whatever you&rsquo;d like, including Yum repos:</p>

<ul>
<li><a href="http://yum.echoditto.com/php53/">http://yum.echoditto.com/php53/</a></li>
<li><a href="http://yum.echoditto.com/php52/">http://yum.echoditto.com/php52/</a></li>
</ul>


<p>Before I get too deep into the instructions, I&rsquo;d like to share the resources I used:</p>

<ul>
<li><a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/sect-Converting_a_Conventional_Spec_File.html">Red Hat&rsquo;s documentation on converting SPEC files to SCLs</a></li>
<li><a href="http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/">PHP 5.4 SCL SRPMs</a> from <a href="http://blog.famillecollet.com/post/2012/11/20/PHP-5.4-as-Software-Collection">Remi Collet</a></li>
<li><a href="http://www2.atomicorp.com/channels/source/php/">PHP 5.3 SRPMs from AtomiCorp</a>, because I wanted <a href="http://php.net/manual/en/book.mysqlnd.php">mysqlnd</a> and didn&rsquo;t want to hack up the Red Hat SPEC to add it</li>
<li><a href="http://centos.alt.ru/pub/repository/centos/5/SRPMS/">PHP 5.2 SRPMs from alt.ru</a>, which contains many backported patches and PHP-FPM</li>
</ul>


<p>An important point to be learned is: <strong>Software Collections are essentially easy-to-use RPM macros</strong> that make installing packages into non-standard directories a piece of cake. As I explain various steps, I&rsquo;ll attempt to explain how the Software Collections function and how I&rsquo;ve seen others set them up so we&rsquo;re following best practices in ours.</p>

<h2>Explaining the Software Collection base</h2>

<p>Every Software Collection needs a base package that sets up the directory structure for the packages. When you use Red Hat&rsquo;s method of building SCLs, specifically via the <em>scl-utils-build</em> package, the base package will create <strong>/opt/rh/%{scl_prefix}/root</strong> with subdirectories like bin/, usr/, etc/, as so on.</p>

<p>For the SCL named <em>php53</em>, here is the base directory structure:</p>

<pre>
/opt/rh/php53/root/bin
/opt/rh/php53/root/boot
/opt/rh/php53/root/dev
/opt/rh/php53/root/etc
/opt/rh/php53/root/home
/opt/rh/php53/root/lib
/opt/rh/php53/root/lib64
/opt/rh/php53/root/media
/opt/rh/php53/root/mnt
/opt/rh/php53/root/opt
/opt/rh/php53/root/proc
/opt/rh/php53/root/root
/opt/rh/php53/root/sbin
/opt/rh/php53/root/selinux
/opt/rh/php53/root/srv
/opt/rh/php53/root/sys
/opt/rh/php53/root/tmp
/opt/rh/php53/root/usr
/opt/rh/php53/root/var
</pre>


<p>Most of the SCLs I have seen contain an <code>enable</code> script at <strong>/opt/rh/%{scl_prefix}/enable</strong> that will add the binaries, man pages, and library paths to the session. In this case, running <code>source /opt/rh/php53/enable</code> will run the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/opt/rh/php52/root/usr/bin:/opt/rh/php52/root/usr/sbin:<span class="nv">$PATH</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/opt/rh/php52/root/usr/lib64:<span class="nv">$LD_LIBRARY_PATH</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MANPATH</span><span class="o">=</span>/opt/rh/php52/root/usr/share/man:<span class="nv">$MANPATH</span>
</span></code></pre></td></tr></table></div></figure>


<p>The base package will also create a <em>%{scl_prefix}-build</em> subpackage that creates RPM macros that will come in handy as the SPEC file is edited.</p>

<h2>Building the Software Collection base</h2>

<ul>
<li><p>Start with <a href="http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm">http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm</a> because it&rsquo;s ready for CentOS 5 and 6</p></li>
<li><p>Rename or copy php54.spec to php53.spec</p></li>
<li><p>Set the global variable <code>scl</code> to be <strong>php53</strong>:</p>

<pre><code>%global scl php53
</code></pre></li>
<li><p>If you haven&rsquo;t already, install <em>rpm-build</em> and <em>mock</em>, and you&rsquo;ll also need <em>scl-utils-build</em> for later:</p>

<pre><code>yum -y install rpm-build mock scl-utils-build
</code></pre></li>
<li><p>CentOS 5 needs additional rpmbuild options when using a CentOS 6 build host because <a href="https://fedoraproject.org/wiki/Features/StrongerHashes">CentOS 6 uses stronger hashes</a> by default</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" -bs --nodeps php53.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild -bs --nodeps php53.spec
</code></pre></li>
</ul>
</li>
<li><p>Build with mock (repeat el6 instructions for el5):</p>

<pre><code>mock -v -r epel-6-x86_64 php53-1-2.el5.src.rpm
</code></pre></li>
<li><p>Copy resulting files to local folder and create a local Yum repo to be used later (repeat el6 instructions for el5):</p>

<pre><code>mkdir -vp ~/rpmbuild/RPMS/repo/el6/{x86_64,SRPMS}
cp -va /var/lib/mock/epel-6-x86_64/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h2>Mock</h2>

<p>We used <code>mock</code> to build the SCL base package, and to make our lives significantly easier, we&rsquo;ll continue to use it with some modifications specific to our SCL.</p>

<p>For all remaining steps, unless there are specific notes for CentOS 5 and 6, repeat the 6/el6 instructions for 5/el5.</p>

<ul>
<li><p>Change to the mock configuration directory:</p>

<pre><code>cd /etc/mock
</code></pre></li>
<li><p>Copy the default EPEL files to new ones specific to our SCL:</p>

<pre><code>cp -a epel-6-x86_64.cfg epel-6-x86_64-scl-php53.cfg
</code></pre></li>
<li><p>Edit <em>epel-6-x86_64-scl-php53.cfg</em> and:</p>

<ul>
<li><p>Add <strong>-scl-php53</strong> to the existing value of <em>config_opts[&lsquo;root&rsquo;]</em>:</p>

<pre><code>config_opts['root'] = 'epel-6-x86_64-scl-php53'
</code></pre></li>
<li><p>CentOS 5 and 6 have different options for <em>config_opts[&lsquo;chroot_setup_cmd&rsquo;]</em>:</p>

<ul>
<li><p>CentOS 5: Add <strong>scl-utils-build php53-build</strong> the following to the existing value:</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install buildsys-build scl-utils-build php53-build'
</code></pre></li>
<li><p>CentOS 6: Change from &lsquo;groupinstall buildsys-build&rsquo; to <strong>install @buildsys-build scl-utils-build php53-build</strong> (the @ will grab the group and then still allow for non-group packages to be added):</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install @buildsys-build scl-utils-build php53-build'
</code></pre></li>
</ul>
</li>
</ul>
</li>
<li><p>Add the local repo where you left the files from the section above as a new repo; I added mine above <em>[base]</em>. <strong>Change /home/alan to the appropriate path for your system!</strong></p>

<pre><code>[localrepo-6-x86_64]
name=localrepo-6-x86_64
enabled=1
baseurl=file:///home/alan/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h2>PHP</h2>

<ul>
<li><p>Use latest php-5.3.x SRPM from <a href="http://www2.atomicorp.com/channels/source/php/">http://www2.atomicorp.com/channels/source/php/</a></p></li>
<li><p>Install the SRPM</p>

<pre><code>rpm -ivh php-5.3.26-19.art.src.rpm
</code></pre></li>
<li><p>Go to the SPECS folder, typically at <em>~/rpmbuild/SPECS</em>, and copy <em>php-art.spec</em> to <em>php.spec</em></p>

<pre><code>cp -v php-art.spec php.spec
</code></pre></li>
<li><p>Several changes are needed to add the SCL macros to the SPEC file; see the <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/sect-Converting_a_Conventional_Spec_File.html">Red Hat documentation</a>. Download my patch file for a full list of changes needed to convert AtomiCorp&rsquo;s PHP SPEC to one that can be used with and without SCL options: <a href="/files/php_scl.diff">php_scl.diff</a></p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php_scl.diff
</code></pre>

<p>Let&rsquo;s step through the changes:</p>

<ul>
<li><p>  The first section allows for variables beginning with <code>_root_</code> to be available if it&rsquo;s not being built with a SCL. As I said earlier, I heavily borrowed from Remi&rsquo;s PHP 5.4 SCL SRPM. The <code>_root_</code> macros are provided by the <em>scl-utils-build</em> package, but this block allows them to work if an SCL is not being used.</p>

<pre><code>+%if 0%{?scl:1}
+%scl_package php
+%else
+%global pkg_name          %{name}
+%global _root_sysconfdir  %{_sysconfdir}
+%global _root_bindir      %{_bindir}
+%global _root_sbindir     %{_sbindir}
+%global _root_includedir  %{_includedir}
+%global _root_libdir      %{_libdir}
+%global _root_prefix      %{_prefix}
+%if 0%{?rhel} &lt; 6
+%global _root_initddir    /etc
+%else
+%global _root_initddir    %{_initddir}
+%endif
+%endif
</code></pre></li>
<li><p>  These values allow you to use the SCL mod_php with the built-in version of Apache</p>

<pre><code>+%global _httpd_confdir     %{_root_sysconfdir}/httpd/conf.d
+%global _httpd_moddir      %{_libdir}/httpd/modules
+%global _root_httpd_moddir %{_root_libdir}/httpd/modules
</code></pre></li>
<li><p>  There are other changes scattered throughout the file to force using locations outside of the SCL, like:</p>

<pre><code>-%global httpd_mmn %(cat %{_includedir}/httpd/.mmn || echo missing-httpd-devel)
+%global httpd_mmn %(cat %{_root_includedir}/httpd/.mmn || echo missing-httpd-devel)
</code></pre></li>
<li><p>  In all of the <em>Name:</em> lines, add the macro <strong>%{?scl_prefix}</strong>, which will only be used when building an SCL. For example, if you use the SCL rpmbuild options, the common package here would be called <em>php53-php-common</em>, but without it would still be called <em>php-common</em>. This applies for the main <em>Name</em> and sub-packages. It&rsquo;s also used for <em>Obsoletes</em>, <em>Conflicts</em>, <em>Provides</em>, and <em>Requires</em>.</p>

<pre><code>-Name: %{phpname}
+Name: %{?scl_prefix}%{phpname}

-Obsoletes: php-mhash
-Conflicts: php-zend-optimizer
+Obsoletes: %{?scl_prefix}php-mhash
+Conflicts: %{?scl_prefix}php-zend-optimizer
</code></pre></li>
<li><p>  The main package would provide <em>mod_php</em> for the built-in Apache, so this addition prevents a collision of having both <code>php</code> and <code>php53-php</code> installed:</p>

<pre><code>+%if 0%{?scl:1}
+Conflicts: php53, php
+%else
 # php53
 Obsoletes: php53
+%endif
</code></pre></li>
<li><p>  As per the Red Hat documentation, a main package (not php, but php-common, since php-common is needed by every php package) must require the base package</p>

<pre><code>%{?scl:Requires:%scl_runtime}
</code></pre></li>
<li><p>  The AtomiCorp SPEC is carefully designed to prevent conflicts with the CentOS 5 packages called <em>php53</em> that are not part of an SCL. I added a change to only keep the <em>Obsoletes</em> if it&rsquo;s not an SCL</p>

<pre><code>+%if 0%{?!scl:1}
 Obsoletes: php53-imap
+%endif
</code></pre></li>
<li><p>  I made a few improvements that aren&rsquo;t related to SCL. I won&rsquo;t list them all here, but one that I noticed was that libevent is no longer needed after PHP 5.3.4, as my comment suggests explaining why I comment it out:</p>

<pre><code>+# libevent needed *until* 5.3.4, see http://bugzilla.redhat.com/show_bug.cgi?id=835671
+#BuildRequires: libevent-devel &gt;= 1.4.11
</code></pre></li>
<li><p>  A lot of the compile options will use the built-in libraries, like:</p>

<pre><code>- --with-freetype-dir=%{_prefix} \
- --with-png-dir=%{_prefix} \
- --with-xpm-dir=%{_prefix} \
+ --with-freetype-dir=%{_root_prefix} \
+ --with-png-dir=%{_root_prefix} \
+ --with-xpm-dir=%{_root_prefix} \
</code></pre></li>
<li><p>  In a few places I use <code>sed</code> to fix config files, here&rsquo;s one where I ensure the SCL root is used for the <em>session.save_path</em> by changing <em>/var/lib</em> to <em>%{_localstatedir}/lib</em></p>

<pre><code>-%{__sed} -e '/session.save_path/s/php/%{phpname}/' %{SOURCE2} &gt;$RPM_BUILD_ROOT%{_sysconfdir}/php.ini
+%{__sed} -e 's|/var/lib/php/session|%{_localstatedir}/lib/%{phpname}/session|' %{SOURCE2} &gt;$RPM_BUILD_ROOT%{_sysconfdir}/php.ini
</code></pre></li>
<li><p>  Instead of installing the Apache module files in the system default directories, I decided to keep them in the SCL root and create symbolic links, though I do put the mod_php Apache configuration file in /etc/httpd/conf.d</p>

<pre><code>-  &gt;$RPM_BUILD_ROOT/%{_origsysconfdir}/httpd/conf.d/%{phpname}.conf
+  &gt;$RPM_BUILD_ROOT/%{_httpd_confdir}/%{?scl_prefix}%{phpname}.conf
+%endif
+
+# Symlink SCL DSOs into real httpd moddir, mod_php config into real httpd config directory
+%if %{?scl:1}0
+install -m 755 -d $RPM_BUILD_ROOT%{_root_httpd_moddir}
+install -m 755 -d $RPM_BUILD_ROOT%{_httpd_confdir}
+%if %{phpname} == php
+ln -s %{_httpd_moddir}/libphp5.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/libphp5.so
+ln -s %{_httpd_moddir}/libphp5-zts.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/libphp5-zts.so
+%else
+ln -s %{_httpd_moddir}/libphp5.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/lib%{phpname}.so
+ln -s %{_httpd_moddir}/libphp5-zts.so $RPM_BUILD_ROOT%{_root_httpd_moddir}/lib%{phpname}-zts.so
+%endif
 %endif
</code></pre></li>
<li><p>  A common practice I observed in other SCL files was putting the init.d script in <em>/etc/init.d</em> instead of the SCL root with prepending the SCL name. For example, if you build with SCL options, the PHP-FPM script would be at <em>/etc/init.d/php53-php-fpm</em>, or without it would be <em>/etc/init.d/php-fpm</em>, either one using the correct paths:</p>

<pre><code>-install -m 755 -d $RPM_BUILD_ROOT%{_originitdir}
-install -m 755 %{SOURCE6} $RPM_BUILD_ROOT%{_originitdir}/php-fpm
+install -m 755 -d $RPM_BUILD_ROOT%{_root_initddir}
+install -m 755 %{SOURCE6} $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
+sed -e '/daemon/s:php-fpm:/usr/sbin/php-fpm:' \
+    -i $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
+sed -e '/php-fpm.pid/s:/var:%{_localstatedir}:' \
+    -e '/subsys/s/php-fpm/%{?scl_prefix}%{phpname}-fpm/' \
+    -e 's:/etc/sysconfig/php-fpm:%{_sysconfdir}/sysconfig/%{phpname}-fpm:' \
+    -e 's:/etc/php-fpm.conf:%{_sysconfdir}/%{phpname}-fpm.conf:' \
+    -e 's:/usr/sbin:%{_sbindir}:' \
+    -i $RPM_BUILD_ROOT%{_root_initddir}/%{?scl_prefix}%{phpname}-fpm
</code></pre></li>
<li><p>  Same concept for logrotate configs:</p>

<pre><code> # LogRotate
-install -m 755 -d $RPM_BUILD_ROOT%{_origsysconfdir}/logrotate.d
-install -m 644 %{SOURCE7} $RPM_BUILD_ROOT%{_origsysconfdir}/logrotate.d/php-fpm
+install -m 755 -d $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d
+install -m 644 %{SOURCE7} $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d/%{?scl_prefix}%{phpname}-fpm
+sed -e 's:/var:%{_localstatedir}:' \
+    -i $RPM_BUILD_ROOT%{_root_sysconfdir}/logrotate.d/%{?scl_prefix}%{phpname}-fpm
</code></pre></li>
<li><p>  While you can <code>source</code> the <em>enable</em> script to get the SCL binaries in your $PATH, we can also create symlinks with the SCL prefix in system folders. This is ideal if you would only need occasional access to the SCL binary, then you could use <code>php53-php</code> instead of <code>/opt/rh/php53/root/usr/bin/php</code>:</p>

<pre><code>+# make the cli commands available in standard root for SCL build
+%if 0%{?scl:1}
+install -m 755 -d $RPM_BUILD_ROOT%{_root_bindir}
+ln -s %{_bindir}/php       $RPM_BUILD_ROOT%{_root_bindir}/%{?scl_prefix}php
+ln -s %{_bindir}/phar.phar $RPM_BUILD_ROOT%{_root_bindir}/%{?scl_prefix}phar
+%endif
</code></pre></li>
<li><p>  You have previously seen <code>if 0%{?scl:1}</code> as a way to define an if block if an SCL is being built. For single lines, you can use  <code>%{?scl: --item--}</code>, like conditionally adding directories:</p>

<pre><code>-%{_libdir}/httpd/modules/libphp5.so
-%{_libdir}/httpd/modules/libphp5-zts.so
+%{?scl: %dir %{_httpd_moddir}}
+%{_httpd_moddir}/libphp5.so
+%{?scl: %{_root_httpd_moddir}/libphp5.so}
+%{_httpd_moddir}/libphp5-zts.so
+%{?scl: %{_root_httpd_moddir}/libphp5-zts.so}
</code></pre></li>
<li><p>  <strong>TL;DR:</strong> Read through the diff file, but you&rsquo;re making the SPEC file to be compatible with and without SCL build options. This is great because you don&rsquo;t have to maintain a second SPEC file for building SCL packages. There are several conditions that if you are using an SCL, you can have files/scripts outside of the SCL root, like init.d scripts, logrotate configs, symlinks to binaries, etc.</p></li>
</ul>
</li>
<li><p>Apply the diff file as a patch to the AtomiCorp SPEC file. I&rsquo;m ignoring whitespace because the text editor I used (Sublime Text) removed some spaces for me.</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM. The <strong>&mdash;define &ldquo;scl php53&rdquo;</strong> option enables the Software Collection (without it, you&rsquo;d be building PHP packages that install into system default paths), <strong>-bs</strong> will only build a source package, and <strong>&mdash;nodeps</strong> will not check for <em>Requires</em> or <em>BuildRequires</em> on the build system (we&rsquo;ll use <code>mock</code> to build the binary RPMs and it will install required packages into the chroot):</p>

<ul>
<li><p>CentOS 5: Use MD5 for checksums:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> with the new chroot configurations we created in <em>/etc/mock</em> earlier:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-5.3.26-19.el6.src.rpm
</code></pre></li>
<li><p>After several minutes, you should have ready-to-install binary packages in <em>/var/lib/mock/epel-6-x86_64-scl-php53/result/</em>. We&rsquo;ll need some of them to build other packages, like PEAR, APC, Memcache, etc, so we&rsquo;ll add them to our local Yum repo we set up earlier (and this location will serve as where we collect all of our completed RPMs):</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre>

<p>At this point, you should have several packages in <em>~/rpmbuild/RPMS/repo/el6/x86_64</em>. You&rsquo;ll generally want to copy completed .rpm files out of /var/lib/mock as soon as they&rsquo;re finished being built so they aren&rsquo;t destroyed the next time to run <code>mock</code> with the same chroot (option <em>-r</em>).</p></li>
</ul>


<h2>PEAR</h2>

<ul>
<li><p>Get latest php-pear from Red Hat at <a href="http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/">http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/</a> and install:</p>

<pre><code>rpm -ivh php-pear-1.9.4-4.el6.src.rpm
</code></pre></li>
<li><p>Grab <a href="/files/php-pear_scl.diff">php-pear_scl.diff</a> to use with <code>patch</code> to convert the SPEC file for use with SCL:</p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php-pear_scl.diff
</code></pre>

<ul>
<li><p>I won&rsquo;t rehash with the same amount of detail as we covered for <em>php.spec</em>, but as a quick summary, this patch file will:</p></li>
<li><p>Define the SCL package name:</p>

<pre><code>+%{?scl:%scl_package php-pear}
+%{!?scl:%global pkg_name %{name}}
</code></pre></li>
<li><p>Add <code>%{scl_prefix}</code> to <em>Name</em>, <em>Requires</em>, <em>BuildRequires</em>, <em>Obsoletes</em>, <em>Conflicts</em>, and <em>Provides</em>. Here&rsquo;s one example:</p>

<pre><code>-Name: php-pear
+Name: %{?scl_prefix}php-pear
</code></pre></li>
<li><p>Add <code>%{?scl:Requires: %scl_runtime}</code> so the SCL Base Package is a requirement:</p>

<pre><code>+%{?scl:Requires: %scl_runtime}
</code></pre></li>
<li><p>Some macros need to use the system default paths. Remember, <code>%{_root_*}</code>-style macros are provided by the <em>scl-utils-build</em> package:</p>

<pre><code>-export PHP_PEAR_SIG_BIN=%{_bindir}/gpg
+export PHP_PEAR_SIG_BIN=%{_root_bindir}/gpg
</code></pre></li>
<li><p>The executable scripts for PEAR need to use the actual rpm macro instead of static paths like &ldquo;/usr&rdquo;:</p>

<pre><code>+for exe in pear pecl peardev; do
+    sed -e 's:/usr:%{_prefix}:' \
+        -i $RPM_BUILD_ROOT%{_bindir}/$exe
+done
</code></pre></li>
<li><p>Make symbolic links in the system default directories for the SCL executables:</p>

<pre><code>+# make the cli commands available in standard root for SCL build
+%if 0%{?scl:1}
+install -m 755 -d $RPM_BUILD_ROOT%{_root_bindir}
+ln -s %{_bindir}/pear      $RPM_BUILD_ROOT%{_root_bindir}/%{scl_prefix}pear
+ln -s %{_bindir}/pecl      $RPM_BUILD_ROOT%{_root_bindir}/%{scl_prefix}pecl
+%endif
</code></pre></li>
</ul>
</li>
<li><p>Apply the diff file as a patch to the Red Hat SPEC file:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php-pear_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php-pear.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php-pear.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> build the packages in our SCL chroot:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-pear-1.9.4-4.el6.src.rpm
</code></pre></li>
<li><p>Copy the files to the local Yum repo folder where we&rsquo;re keeping all of our completed RPMs:</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</code></pre></li>
<li><p>Since APC and Memcache will need <em>php53-php-pear</em> as a build dependency, we&rsquo;ll need to update the Yum repo files:</p>

<pre><code>createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h2>APC</h2>

<p>For the remaining packages, I will skip explaining the differences in the SPEC files and simply list the commands. If you look at the diff patch for <em>php-pecl-apc.spec</em>, you&rsquo;ll notice that it&rsquo;s very similar to the changes made for PEAR.</p>

<ul>
<li><p>Get latest php-pecl-apc from Red Hat at <a href="http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/">http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/</a> and install:</p>

<pre><code>rpm -ivh php-pecl-apc-3.1.9-2.el6.src.rpm
</code></pre></li>
<li><p>Grab <a href="/files/php-pecl-apc_scl.diff">php-pecl-apc_scl.diff</a> to use with <code>patch</code> to convert the SPEC file for use with SCL:</p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php-pecl-apc_scl.diff
</code></pre>

<ul>
<li><p>Actually, I will point out an important change in this spec file: adding the directory path in front of <code>php</code> and <code>php-config</code> to ensure we&rsquo;re using the SCL binary and not the system default <code>php</code>:</p>

<pre><code>-%global php_zendabiver %((echo 0; php -i 2&gt;/dev/null | sed -n 's/^PHP Extension =&gt; //p') | tail -1)
-%global php_version %((echo 0; php-config --version 2&gt;/dev/null) | tail -1)
+%global php_zendabiver %((echo 0; %{_bindir}/php -i 2&gt;/dev/null | sed -n 's/^PHP Extension =&gt; //p') | tail -1)
+%global php_version %((echo 0; %{_bindir}/php-config --version 2&gt;/dev/null) | tail -1)
</code></pre></li>
</ul>
</li>
<li><p>Apply the diff file as a patch to the Red Hat SPEC file:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php-pecl-apc_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php-pecl-apc.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php-pecl-apc.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> build the packages in our SCL chroot:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-pecl-apc-3.1.9-2.el6.src.rpm
</code></pre></li>
<li><p>Copy the files to the local Yum repo folder where we&rsquo;re keeping all of our completed RPMs:</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</code></pre></li>
<li><p>No other packages require the completed RPMs to build, so we skip the <code>createrepo</code> command here and move onto the next page.</p></li>
</ul>


<h2>Memcache</h2>

<p>We&rsquo;re going to upgrade php-pecl-memcache from 3.0.5 to 3.0.8. Both are considered &ldquo;beta&rdquo; on <a href="http://pecl.php.net/package/memcache">pecl.php.net</a> so it&rsquo;s not like we&rsquo;re losing stability, but we are gaining features.</p>

<ul>
<li><p>Get latest php-pecl-memcache from Red Hat at <a href="http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/">http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/</a> and install:</p>

<pre><code>rpm -ivh php-pecl-memcache-3.0.5-4.el6.src.rpm
</code></pre></li>
<li><p>Grab <a href="/files/php-pecl-memcache_scl.diff">php-pecl-memcache_scl.diff</a> to use with <code>patch</code> to convert the SPEC file for use with SCL:</p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php-pecl-memcache_scl.diff
</code></pre></li>
<li><p>Download the <a href="http://pecl.php.net/get/memcache-3.0.8.tgz">memcache 3.0.8 source</a> from the PECL website into the ~/rpmbuild/SOURCES directory</p>

<pre><code>curl --output ~/rpmbuild/SOURCES/memcache-3.0.8.tgz --location http://pecl.php.net/get/memcache-3.0.8.tgz
</code></pre></li>
<li><p>Apply the diff file as a patch to the Red Hat SPEC file, which will upgrade 3.0.5 to 3.0.8 and remove the need for 3 patches:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php-pecl-memcache_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php53" -bs --nodeps php-pecl-memcache.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php53" -bs --nodeps php-pecl-memcache.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> build the packages in our SCL chroot:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php53 php53-php-pecl-memcache-3.0.8-1.el6.src.rpm
</code></pre></li>
<li><p>Copy the files to the local Yum repo folder where we&rsquo;re keeping all of our completed RPMs:</p>

<pre><code>cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php53/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</code></pre></li>
</ul>


<h2>PHP 5.3 SCL Completed</h2>

<p>You should now have several binary RPMs in <em>~/rpmbuild/RPMS/repo/el6/x86_64</em> ready to be installed as a Software Collection. If you want to distribute your SRPMs, you&rsquo;ll probably want to use the ones generated by <code>mock</code> that are in <em>~/rpmbuild/RPMS/repo/el6/SRPMS</em>.</p>

<h2>PHP 5.2</h2>

<p>PHP 5.2 is quite old, but if 5.3 or higher broke compatibility with old websites, you can install PHP 5.2 as a Software Collection and use PHP-FPM to use only the older version for a specific website. As previously mentioned, I&rsquo;m using a SRPM that has backported patches (presumably from <a href="https://code.google.com/p/php52-backports/">https://code.google.com/p/php52-backports/</a>), so it&rsquo;s certainly more up-to-date than <a href="http://php.net/releases/index.php">the last 5.2 release from php.net</a> (Released: 06 January 2011).</p>

<p>I won&rsquo;t go into detail of the diff patches since they are largely similar to the changes made on the PHP 5.3 SPECs.</p>

<h3>Software Collection base</h3>

<ul>
<li><p>As with php53, start with <a href="http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm">http://people.redhat.com/rcollet/php54/rhel/5/SRPMS/php54-1-2.el5.src.rpm</a></p></li>
<li><p>Rename or copy php54.spec to php52.spec</p></li>
<li><p>Set the global variable <code>scl</code> to be <strong>php52</strong>:</p>

<pre><code>%global scl php52
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" -bs --nodeps php52.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild -bs --nodeps php52.spec
</code></pre></li>
</ul>
</li>
<li><p>Build with mock (repeat el6 instructions for el5):</p>

<pre><code>mock -v -r epel-6-x86_64 php52-1-2.el5.src.rpm
</code></pre></li>
<li><p>Copy resulting files to local folder and create a local Yum repo to be used later (repeat el6 instructions for el5):</p>

<pre><code>mkdir -vp ~/rpmbuild/RPMS/repo/el6/{x86_64,SRPMS}
cp -va /var/lib/mock/epel-6-x86_64/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h3>Mock</h3>

<p>These steps are nearly identical are for php53, but using php52 instead. As mentioned previously, if you need to repeat something for CentOS 5, use the CentOS 6 and change 6 to 5, el5 to el6, etc.</p>

<ul>
<li><p>Change to the mock configuration directory:</p>

<pre><code>cd /etc/mock
</code></pre></li>
<li><p>Copy the default EPEL files to new ones specific to our SCL:</p>

<pre><code>cp -a epel-6-x86_64.cfg epel-6-x86_64-scl-php52.cfg
</code></pre></li>
<li><p>Edit <em>epel-6-x86_64-scl-php52.cfg</em> and:</p>

<ul>
<li><p>Add <strong>-scl-php53</strong> to the existing value of <em>config_opts[&lsquo;root&rsquo;]</em>:</p>

<pre><code>config_opts['root'] = 'epel-6-x86_64-scl-php52'
</code></pre></li>
<li><p>CentOS 5 and 6 have different options for <em>config_opts[&lsquo;chroot_setup_cmd&rsquo;]</em>:</p>

<ul>
<li><p>CentOS 5: Add <strong>scl-utils-build php52-build</strong> the following to the existing value:</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install buildsys-build scl-utils-build php52-build'
</code></pre></li>
<li><p>CentOS 6: Change from &lsquo;groupinstall buildsys-build&rsquo; to <strong>install @buildsys-build scl-utils-build php52-build</strong>:</p>

<pre><code>config_opts['chroot_setup_cmd'] = 'install @buildsys-build scl-utils-build php52-build'
</code></pre></li>
</ul>
</li>
</ul>
</li>
<li><p>Add the local repo where you left the files from the section above as a new repo; I add mine above <em>[base]</em>. <strong>Change /home/alan to the appropriate path for your system!</strong></p>

<pre><code>[localrepo-6-x86_64]
name=localrepo-6-x86_64
enabled=1
baseurl=file:///home/alan/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h3>PHP</h3>

<ul>
<li><p>Use latest php-5.2.x SRPM from <a href="http://centos.alt.ru/pub/repository/centos/5/SRPMS/">http://centos.alt.ru/pub/repository/centos/5/SRPMS/</a></p></li>
<li><p>Install the SRPM</p>

<pre><code>rpm -ivh php-5.2.17-29.el5.src.rpm
</code></pre></li>
<li><p>Several changes are needed to add the SCL macros to the SPEC file; see the <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Developer_Toolset/1/html/Software_Collections_Guide/sect-Converting_a_Conventional_Spec_File.html">Red Hat documentation</a>. Download my patch file for a full list of changes needed to convert the alt.ru PHP SPEC to one that can be used with and without SCL options: <a href="/files/php52_scl.diff">php52_scl.diff</a></p>

<pre><code>curl --remote-name --location http://alanthing.com/files/php52_scl.diff
</code></pre></li>
<li><p>Apply the diff file as a patch to the alt.ru SPEC file:</p>

<pre><code>patch -p0 --ignore-whitespace &lt; php52_scl.diff
</code></pre></li>
<li><p>Use <code>rpmbuild</code> to build the SRPM:</p>

<ul>
<li><p>CentOS 5:</p>

<pre><code>rpmbuild --define "_source_filedigest_algorithm md5" --define "_binary_filedigest_algorithm md5" --define "scl php52" -bs --nodeps php.spec
</code></pre></li>
<li><p>CentOS 6:</p>

<pre><code>rpmbuild --define "scl php52" -bs --nodeps php.spec
</code></pre></li>
</ul>
</li>
<li><p>Use <code>mock</code> with the new chroot configurations we created in <em>/etc/mock</em> earlier:</p>

<pre><code>mock -v -r epel-6-x86_64-scl-php52 php52-php-5.2.17-29.el6.src.rpm
</code></pre></li>
<li><p>After <code>mock</code> is completed, copy the files to the local repo folder. Like before, we&rsquo;ll need some of these packages to build other packages:</p>

<pre><code>mkdir -vp ~/rpmbuild/RPMS/repo/el6/{SRPMS,x86_64}
cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.{noarch,x86_64}.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</code></pre></li>
</ul>


<h3>PEAR, APC, and Memcache</h3>

<p>You can repeat the same steps for php-pear, php-pecl-apc, and php-pecl-memcache as above for PHP 5.3. The only difference would be to change the SCL name during the <code>rpmbuild</code> and <code>mock</code> steps. Here are all of the steps without explanation:</p>

<h4>PEAR</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>curl --remote-name --location http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/php-pear-1.9.4-4.el6.src.rpm
</span><span class='line'>rpm -ivh php-pear-1.9.4-4.el6.src.rpm
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>curl --remote-name --location http://alanthing.com/files/php-pear_scl.diff
</span><span class='line'>patch -p0 --ignore-whitespace &lt; php-pear_scl.diff
</span><span class='line'>rpmbuild --define <span class="s2">&quot;scl php52&quot;</span> -bs --nodeps php-pear.spec
</span><span class='line'>mock -v -r epel-6-x86_64-scl-php52 php52-php-pear-1.9.4-4.el6.src.rpm
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.<span class="o">{</span>noarch,x86_64<span class="o">}</span>.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</span><span class='line'>createrepo -v -d ~/rpmbuild/RPMS/repo/el6/x86_64
</span></code></pre></td></tr></table></div></figure>


<h4>APC</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>curl --remote-name --location http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/php-pecl-apc-3.1.9-2.el6.src.rpm
</span><span class='line'>rpm -ivh php-pecl-apc-3.1.9-2.el6.src.rpm
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>curl --remote-name --location http://alanthing.com/files/php-pecl-apc_scl.diff
</span><span class='line'>patch -p0 --ignore-whitespace &lt; php-pecl-apc_scl.diff
</span><span class='line'>rpmbuild --define <span class="s2">&quot;scl php52&quot;</span> -bs --nodeps php-pecl-apc.spec
</span><span class='line'>mock -v -r epel-6-x86_64-scl-php52 php52-php-pecl-apc-3.1.9-2.el6.src.rpm
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.<span class="o">{</span>noarch,x86_64<span class="o">}</span>.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</span></code></pre></td></tr></table></div></figure>


<h4>Memcache</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>curl --remote-name --location http://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/php-pecl-memcache-3.0.5-4.el6.src.rpm
</span><span class='line'>rpm -ivh php-pecl-memcache-3.0.5-4.el6.src.rpm
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>curl --remote-name --location http://alanthing.com/files/php-pecl-memcache_scl.diff
</span><span class='line'>curl --output ~/rpmbuild/SOURCES/memcache-3.0.8.tgz --location http://pecl.php.net/get/memcache-3.0.8.tgz
</span><span class='line'>patch -p0 --ignore-whitespace &lt; php-pecl-memcache_scl.diff
</span><span class='line'>rpmbuild --define <span class="s2">&quot;scl php52&quot;</span> -bs --nodeps php-pecl-memcache.spec
</span><span class='line'>mock -v -r epel-6-x86_64-scl-php52 php52-php-pecl-memcache-3.0.8-1.el6.src.rpm
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.<span class="o">{</span>noarch,x86_64<span class="o">}</span>.rpm ~/rpmbuild/RPMS/repo/el6/x86_64
</span><span class='line'>cp -va /var/lib/mock/epel-6-x86_64-scl-php52/result/*.src.rpm ~/rpmbuild/RPMS/repo/el6/SRPMS
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>It does seem like a little bit of work to convert a SPEC file for SCL compatibility, but once the work is done, incremental updates are easy, and you can use the same SPEC to build a non-SCL package as well. I wouldn&rsquo;t be surprised if Red Hat begins to create SCL-compatible SPEC files for major applications in RHEL 7 and beyond because of the flexibility it offers, just see their <a href="http://www.redhat.com/about/news/archive/2013/6/red-hat-software-collections-1.0-beta-now-available">Red Hat Software Collections 1.0 Beta</a>. Unfortunately, it&rsquo;s difficult to fully grasp how to build one, so hopefully this guide has been helpful.</p>

<p>Personally, after having some trouble quickly switching from MySQL to MariaDB or Percona, I&rsquo;ll probably look to rebuild those as Software Collections instead of replacing the default packages, but that&rsquo;s another blog post!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/09/speed-up-php-on-nfs-with-turbo-realpath/">Speed Up PHP on NFS With Turbo_realpath</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-09T11:50:00-04:00" pubdate data-updated="true">May 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you run a website based on PHP, and have your source files on a network file system like NFS, OCFS2, or GlusterFS, and combine it with PHP&rsquo;s <a href="http://www.php.net/manual/en/ini.core.php#ini.open-basedir">open_basedir</a> protection, you&rsquo;ll quickly notice that the performance will degrade substantially. Normally, PHP can cache various path locations it learns after processing <a href="http://us2.php.net/manual/en/function.include-once.php">include_once</a> and <a href="http://us2.php.net/manual/en/function.require-once.php">require_once</a> calls via the <a href="http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-size">realpath_cache</a>. There&rsquo;s a <a href="https://bugs.php.net/bug.php?id=52312">bug in PHP</a> that effectively disables the realpath_cache entirely when combined with open_basedir. Popular PHP applications with Drupal and WordPress make heavy use of these functions to include other files, so you would very quickly notice the drop in performance in this scenario. If you want to isolate your websites from each other (or from the rest of the operating system), how can you retain any shred of performance?</p>

<p>This is where <a href="http://php.webtutor.pl/">Artur Graniszewski</a>&rsquo;s <a href="http://php.webtutor.pl/en/2011/07/12/running-php-on-nfs-version-1-2-of-turbo_realpath-extension/">turbo_realpath</a> extension really comes in handy. I won&rsquo;t retype his installation instructions, so follow the previous link to get it installed manually.</p>

<p>If you&rsquo;re running CentOS 5 or CentOS 6, check out <a href="http://yum.echoditto.com/">yum.echoditto.com</a> and you&rsquo;ll find source and compiled RPMs that will install alongside the RedHat/CentOS-supplied PHP packages. The RPM will create a basic configuration file at <code>/etc/php.d/turbo_realpath.ini</code>. Essentially, it enables the PHP module but defaults all settings off, so you will need to read the comments (taken from <a href="http://php.webtutor.pl/en/2011/07/12/running-php-on-nfs-version-1-2-of-turbo_realpath-extension/">Artur&rsquo;s most recent post on turbo_realpath</a>) to determine how you want to use it.</p>

<h1>Configuration</h1>

<p>We frequently use turbo_realpath on a per-VirtualHost basis with Apache 2.2 and mod_php. If you use PHP-FPM, you can apply similar settings in your FPM pool configuration files. If you install our RPM and don&rsquo;t edit <code>/etc/php.d/turbo_realpath.ini</code>, add something similar to the following to each VirtualHost:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nt">&lt;IfModule</span> <span class="s">php5_module</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">php_admin_value</span> realpath_cache_basedir <span class="s2">&quot;/var/www/vhosts/domain.com:/usr/share/pear:/usr/share/php:/usr/lib64/php:/usr/lib/php:/tmp:/var/tmp&quot;</span>
</span><span class='line'><span class="nt">&lt;/IfModule&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is effectively the same using <code>open_basedir</code>; any directories referenced in <code>realpath_cache_basedir</code> will be the only ones the website is allowed to access, and they will be cached as determined by the <a href="http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-size">realpath_cache_size</a> and <a href="http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-ttl">realpath_cache_ttl</a>. If you look in <code>php.ini</code>, you may notice the default values for these are:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="c1">; Determines the size of the realpath cache to be used by PHP. This value should</span>
</span><span class='line'><span class="c1">; http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-size</span>
</span><span class='line'><span class="na">realpath_cache_size</span> <span class="o">=</span> <span class="s">16k</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; Duration of time, in seconds for which to cache realpath information for a given</span>
</span><span class='line'><span class="c1">; http://www.php.net/manual/en/ini.core.php#ini.realpath-cache-ttl</span>
</span><span class='line'><span class="na">realpath_cache_ttl</span> <span class="o">=</span> <span class="s">120</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may want to increase these if you&rsquo;re finding your website is still not loading quickly. On our systems, we have bumped the <code>realpath_cache_size</code> and <code>realpath_cache_ttl</code> settings up to <code>1m</code> and <code>300</code>, respectively.</p>

<h1>Speed and Security!</h1>

<p>With turbo_realpath enabled, <code>realpath_cache_basedir</code> set to appropriate <code>open_basedir</code>-like values, and <code>realpath_cache_size</code> and <code>realpath_cache_ttl</code> increased from defaults, we&rsquo;re able to have isolated PHP sites and have better performance by caching the locations of included/required files effectively. Hopefully, our RPMs will help you on your system for a quick installation of the excellent turbo_realpath module!</p>

<h1>References</h1>

<ul>
<li><a href="http://php.webtutor.pl/en/2011/06/02/running-php-on-nfs-huge-performance-problems-and-one-simple-solution/">Running PHP on NFS: huge performance problems and one simple solution.</a></li>
<li><a href="http://php.webtutor.pl/en/2011/07/01/running-php-on-nfs-new-version-of-turbo_realpath-extension/">Running PHP on NFS: new version of turbo_realpath extension</a></li>
<li><a href="http://php.webtutor.pl/en/2011/07/12/running-php-on-nfs-version-1-2-of-turbo_realpath-extension/">Running PHP on NFS: version 1.2 of turbo_realpath extension</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/17/virtualbox-extension-pack-with-one-line/">VirtualBox Extension Pack With One Line</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-17T20:46:00-04:00" pubdate data-updated="true">Mar 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just installed <a href="http://www.virtualbox.org">VirtualBox</a> on OS X and need the <a href="http://www.virtualbox.org/wiki/Downloads">Extension Pack</a>? This (really long) one-liner will download and install it for you. Run in terminal and enter your password once and you&rsquo;re off to the races!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export version=$(/usr/bin/vboxmanage -v) && export var1=$(echo ${version} | cut -d 'r' -f 1) && export var2=$(echo ${version} | cut -d 'r' -f 2) && export file="Oracle_VM_VirtualBox_Extension_Pack-${var1}-${var2}.vbox-extpack" && curl --silent --location http://download.virtualbox.org/virtualbox/${var1}/${file} -o ~/Downloads/${file} && VBoxManage extpack install ~/Downloads/${file} --replace && rm ~/Downloads/${file} && unset version var1 var2 file</span></code></pre></td></tr></table></div></figure>


<p>Note that VirtualBox must be installed first :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/21/real-time-ruby-gem-development/">&#8220;Real-time&#8221; Ruby Gem Development</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-21T08:08:00-05:00" pubdate data-updated="true">Feb 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, I&rsquo;ve been working on adding functionality for <a href="http://www.stormondemand.com">Storm on Demand</a>&rsquo;s <a href="https://www.stormondemand.com/api/docs/1.0/">API</a> to the excellent <a href="http://fog.io">fog</a> library. There didn&rsquo;t seem to be a clear way, that I could find, to work on a Ruby gem in real-time, meaning I save the file in my editor and immediately run some code. Most <a href="http://gembundler.com/rubygems.html">guides</a> I <a href="http://blog.thepete.net/2010/11/creating-and-publishing-your-first-ruby.html">found</a> tended to advise to create the gem file and install it. <a href="http://rakeroutes.com/blog/lets-write-a-gem-part-two/">Stephen Ball demostrates</a> the use of <code>bundle console</code> which drops you into <code>irb</code> for testing, but I was looking for a way to test my own scripts outside of a shell with my recently-saved gem files.</p>

<p>Thankfully this isn&rsquo;t too difficult to set up and this will allow you to work on your gem in &ldquo;real-time;&rdquo; save and test, without <code>bundle console</code> or installing lots of dev gems.</p>

<p>I should note two things here: I&rsquo;m not a Ruby developer, and I&rsquo;ve really only tested this thoroughly with fog, no others. If this ends up being a terrible way to do things, please let me know.</p>

<p>I&rsquo;m using <a href="http://rvm.io/">RVM</a> to keep my gem development isolated from the rest of my system. If you haven&rsquo;t already, <a href="https://rvm.io/rvm/install/">set up rvm</a> on your system. If you&rsquo;re using <a href="https://github.com/sstephenson/rbenv">rbenv</a> instead, use <a href="https://github.com/jamis/rbenv-gemset">applicable commands</a>.</p>

<p>You&rsquo;ll obviously need to start in a gem development directory. In my case, I start with fog:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git@github.com:fog/fog.git
</span><span class='line'>cd fog</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m going to switch to ruby 1.9.3 and use a new gemset called fogdev:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rvm use 1.9.3 && rvm gemset create fogdev && rvm use 1.9.3@fogdev</span></code></pre></td></tr></table></div></figure>


<p>You may want to create a <code>.rvmrc</code> file so you don&rsquo;t have to use <code>rvm use</code> constantly.</p>

<p>Install the prerequesite gems as listed in the gemspec file with bundler:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle install</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m going to grab the version number of fog from the gemspec file so I can reuse it later (if there are multiple &lsquo;.gemspec&rsquo; files in your directory, change &lsquo;*.gemspec&rsquo; to &lsquo;name.gemspec&rsquo; as appropriate):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export GEMVERSION=$(grep -E '^[ \t]+s.version' *.gemspec | awk '{print $3}' | sed 's/'\''//g')</span></code></pre></td></tr></table></div></figure>


<p>Now at this point, you can build and install the gem with <code>rake build &amp;&amp; gem install pkg/fog-${GEMVERSION}.gem</code> or <code>gem build</code> or any other tools as most tutorials advise, but then whenever you edit the source files you&rsquo;ll have to repeat. Let&rsquo;s create some symbolic links instead. Start by going to the rvm gemset folder (this may be a different location for your environment):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ~/.rvm/gems/ruby-1.9.3-p286\@fogdev/</span></code></pre></td></tr></table></div></figure>


<p>It seems as though the earlier <code>bundle install</code> command created the file bin/fog for me, but it doesn&rsquo;t work without either installing a gem or running the remaining commands below. Particularly for fog, if this bin/fog file is missing and you need it, you can grab it with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ ! -f bin/fog ] && curl --silent --output bin/fog https://gist.github.com/alanthing/5004411/raw/13f748f1cc19df7511ea2a01de6824eac3358905/fog && chmod +x bin/fog</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s add our development gem with symbolic links (again, change as appropriate for your gem):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ln -s ~/fog/fog.gemspec specifications/fog-${GEMVERSION}.gemspec
</span><span class='line'>ln -s ~/fog gems/fog-${GEMVERSION}</span></code></pre></td></tr></table></div></figure>


<p>Now if you run <code>gem list</code> you should see your gem listed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gem list
</span><span class='line'>...snip...
</span><span class='line'>ffi (1.0.11)
</span><span class='line'>fission (0.4.0)
</span><span class='line'>fog (1.9.0)
</span><span class='line'>formatador (0.2.4)
</span><span class='line'>jekyll (0.12.0)
</span><span class='line'>...snip...</span></code></pre></td></tr></table></div></figure>


<p>And, in my case, running <code>fog</code> uses the gemset file bin/fog and drops me into a fog-ised irb:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ fog
</span><span class='line'>  Welcome to fog interactive!
</span><span class='line'>  :default provides VirtualBox and Vmfusion
</span><span class='line'>&gt;&gt; </span></code></pre></td></tr></table></div></figure>


<p>If you see any mistakes or have any questions, let me know!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/19/usable-mamp-os-x-108-mountain-lion/">Usable MAMP on OS X 10.8 Mountain Lion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-19T11:18:00-05:00" pubdate data-updated="true">Dec 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Install MAMP</h2>

<p>Download the latest MAMP from <a href="http://mamp.info/en/downloads/index.html">http://mamp.info/en/downloads/index.html</a> and run the installer.</p>

<h2>Choose APC Cache</h2>

<p>Open the MAMP app, open <strong>Preferences&hellip;</strong>, click the <strong>PHP</strong> tab, and change <strong>Cache</strong> to <strong>APC</strong>. Click <strong>OK</strong> to close Preferences and <strong>Quit</strong> MAMP.</p>

<p><img src="http://i46.tinypic.com/2wltqpw.png" alt="MAMP Screenshot" /></p>

<h2>PATH variable</h2>

<p>Put MAMP binaries, including PHP, in the front of your $PATH (this is a single command):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;export PATH=&quot;/Applications/MAMP/bin:/Applications/MAMP/Library/bin:$(find /Applications/MAMP/bin/php -type d -name &quot;php5.4*&quot; | sort | tail -1)/bin:$PATH&quot;&#39;</span> &gt;&gt; ~/.bash_profile <span class="o">&amp;&amp;</span> <span class="nb">source</span> ~/.bash_profile
</span></code></pre></td></tr></table></div></figure>


<h2>MySQL</h2>

<p>Set up MySQL and stop it (default MySQL password is <strong>root</strong>, you do not have to change it when running <code>mysql_secure_installation</code>, though I recommend all of the other defaults):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp -va /Applications/MAMP/Library/support-files/my-small.cnf /Applications/MAMP/conf/my.cnf
</span><span class='line'>
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s/^\(max_allowed_packet =\) [0-9]*M/\1 1G/g&quot;</span> /Applications/MAMP/conf/my.cnf
</span><span class='line'>
</span><span class='line'>egrep <span class="s2">&quot;^# Uncomment the following if you are using InnoDB tables$&quot;</span> /Applications/MAMP/conf/my.cnf &amp;&gt;/dev/null <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s/^\(# Uncomment the following if you are using InnoDB tables\)$/\1@innodb_file_per_table/; y/@/\n/; s/^#\(innodb_.*\)/\1/g&quot;</span> /Applications/MAMP/conf/my.cnf
</span><span class='line'>
</span><span class='line'>/Applications/MAMP/bin/startMysql.sh &amp;
</span><span class='line'>
</span><span class='line'><span class="c"># Secure MySQL setup:</span>
</span><span class='line'>/Applications/MAMP/Library/bin/mysql_secure_installation
</span><span class='line'><span class="c"># -- OR --</span>
</span><span class='line'><span class="c"># Less secure MySQL setup:</span>
</span><span class='line'><span class="c">#/Applications/MAMP/Library/bin/mysql -uroot -proot -e&quot;DELETE FROM mysql.user WHERE User=&#39;&#39;; DELETE FROM mysql.user WHERE User=&#39;root&#39; AND Host!=&#39;localhost&#39;; FLUSH PRIVILEGES;&quot;</span>
</span><span class='line'>
</span><span class='line'>/Applications/MAMP/bin/stopMysql.sh
</span></code></pre></td></tr></table></div></figure>


<h2>PHP</h2>

<p>Set timezone, and increase timeouts and memory values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;-default&#39;</span> <span class="s2">&quot;s|^;*\(date\.timezone[[:space:]]*=\).*|\1 \&quot;`systemsetup -gettimezone|awk -F&quot;</span><span class="se">\:</span> <span class="s2">&quot; &#39;{print $2}&#39;`\&quot;|; s|^\(memory_limit[[:space:]]*=\).*\(\;.*\)|\1 256M \2|; s|^\(post_max_size[[:space:]]*=\).*|\1 200M|; s|^\(upload_max_filesize[[:space:]]*=\).*|\1 100M|; s|^\(default_socket_timeout[[:space:]]*=\).*|\1 600|; s|^\(max_execution_time[[:space:]]*=\).*\(\;.*\)|\1 300 \2|; s|^\(max_input_time[[:space:]]*=\).*\(\;.*\)|\1 600 \2|;&quot;</span> <span class="k">$(</span>find /Applications/MAMP/bin/php -type d -name <span class="s2">&quot;php5.4*&quot;</span> | sort | tail -1<span class="k">)</span>/conf/php.ini
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n[apc]\napc.shm_size = 192M\napc.rfc1867 = 1&quot;</span> &gt;&gt; <span class="k">$(</span>find /Applications/MAMP/bin/php -type d -name <span class="s2">&quot;php5.4*&quot;</span> | sort | tail -1<span class="k">)</span>/conf/php.ini
</span></code></pre></td></tr></table></div></figure>


<h3>PECL Uploadprogress</h3>

<p><strong>Feel free to skip:</strong> This is quite involved when <code>apc.rfc1867=1</code> does the job in most cases. This is mostly an exercise in building PHP modules for MAMP.</p>

<p><strong>You&rsquo;ll need to install Xcode Command Line Tools from <a href="http://develop.apple.com/downloads">http://develop.apple.com/downloads</a> in order to complete all of the steps below.</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p <span class="k">$(</span>find /Applications/MAMP/bin/php -type d -name <span class="s2">&quot;php5.4*&quot;</span> | sort | tail -1<span class="k">)</span>/include
</span><span class='line'><span class="nb">cd</span> <span class="k">$(</span>find /Applications/MAMP/bin/php -type d -name <span class="s2">&quot;php5.4*&quot;</span> | sort | tail -1<span class="k">)</span>/include
</span><span class='line'><span class="nb">export </span><span class="nv">PHPVER</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> /Applications/MAMP/bin/php <span class="o">&amp;&amp;</span> find * -type d -name <span class="s2">&quot;php5.4*&quot;</span> | sort | tail -1 | sed <span class="s1">&#39;s/php//&#39;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> curl -L -o php-<span class="k">${</span><span class="nv">PHPVER</span><span class="k">}</span>.tar.bz2 http://us3.php.net/get/php-<span class="k">${</span><span class="nv">PHPVER</span><span class="k">}</span>.tar.bz2/from/us3.php.net/mirror <span class="o">&amp;&amp;</span> <span class="nb">unset </span>PHPVER
</span><span class='line'>ls php-5.4*bz2 | xargs -L1 tar jxpf <span class="o">&amp;&amp;</span> rm php-5.4*bz2
</span><span class='line'>mv -v <span class="k">$(</span>find * -type d -name <span class="s2">&quot;php-5.4*&quot;</span><span class="k">)</span> php
</span><span class='line'><span class="nb">cd </span>php
</span><span class='line'>./configure
</span><span class='line'><span class="nb">cd</span> ..
</span><span class='line'>
</span><span class='line'><span class="c">## Build automake and related tools</span>
</span><span class='line'><span class="nb">export </span><span class="nv">build</span><span class="o">=</span><span class="s2">&quot;$PWD/build&quot;</span>
</span><span class='line'>mkdir -p <span class="nv">$build</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$build</span>
</span><span class='line'>curl -OL http://ftpmirror.gnu.org/autoconf/autoconf-2.68.tar.gz
</span><span class='line'>tar xzf autoconf-2.68.tar.gz
</span><span class='line'><span class="nb">cd </span>autoconf-2.68
</span><span class='line'>./configure --prefix<span class="o">=</span><span class="nv">$build</span>/autotools-bin
</span><span class='line'>make
</span><span class='line'>make install
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$build</span>/autotools-bin/bin
</span><span class='line'><span class="nb">cd</span> <span class="nv">$build</span>
</span><span class='line'>curl -OL http://ftpmirror.gnu.org/automake/automake-1.11.tar.gz
</span><span class='line'>tar xzf automake-1.11.tar.gz
</span><span class='line'><span class="nb">cd </span>automake-1.11
</span><span class='line'>./configure --prefix<span class="o">=</span><span class="nv">$build</span>/autotools-bin
</span><span class='line'>make
</span><span class='line'>make install
</span><span class='line'><span class="nb">cd</span> <span class="nv">$build</span>
</span><span class='line'>curl -OL http://ftpmirror.gnu.org/libtool/libtool-2.4.tar.gz
</span><span class='line'>tar xzf libtool-2.4.tar.gz
</span><span class='line'><span class="nb">cd </span>libtool-2.4
</span><span class='line'>./configure --prefix<span class="o">=</span><span class="nv">$build</span>/autotools-bin
</span><span class='line'>make
</span><span class='line'>make install
</span><span class='line'><span class="nb">cd</span> <span class="nv">$build</span>
</span><span class='line'><span class="nb">unset </span>build
</span><span class='line'>rm autoconf-2.68.tar.gz automake-1.11.tar.gz libtool-2.4.tar.gz
</span><span class='line'>rm -rf autoconf-2.68 automake-1.11 libtool-2.4
</span><span class='line'><span class="nb">cd</span> ..
</span><span class='line'>
</span><span class='line'>pecl download uploadprogress
</span><span class='line'>ls uploadprogress*z | xargs -L1 tar zxpf <span class="o">&amp;&amp;</span> rm -v uploadprogress*z package*xml
</span><span class='line'>mv -v <span class="k">$(</span>find * -type d -name <span class="s2">&quot;uploadprogress*&quot;</span><span class="k">)</span> uploadprogress
</span><span class='line'><span class="nb">cd </span>uploadprogress
</span><span class='line'>phpize
</span><span class='line'>./configure --with-php-config<span class="o">=</span><span class="k">$(</span>find /Applications/MAMP/bin/php -type d -name <span class="s2">&quot;php5.4*&quot;</span> | sort | tail -1<span class="k">)</span>/bin/php-config
</span><span class='line'>make
</span><span class='line'>make install
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n[uploadprogress]\nextension=uploadprogress.so&quot;</span> &gt;&gt; <span class="k">$(</span>find /Applications/MAMP/bin/php -type d -name <span class="s2">&quot;php5.4*&quot;</span> | sort | tail -1<span class="k">)</span>/conf/php.ini
</span></code></pre></td></tr></table></div></figure>


<p>Reference 1: <a href="http://www.lullabot.com/articles/installing-php-pear-and-pecl-extensions-on-mamp-mac-os-x-107-lion">http://www.lullabot.com/articles/installing-php-pear-and-pecl-extensions-on-mamp-mac-os-x-107-lion</a>
Reference 2: <a href="http://jsdelfino.blogspot.com/2012/08/autoconf-and-automake-on-mac-os-x.html">http://jsdelfino.blogspot.com/2012/08/autoconf-and-automake-on-mac-os-x.html</a></p>

<h2>Apache</h2>

<p>Set up VirtualHosts in <strong>~/Sites/mamp-vhosts.conf</strong> so it&rsquo;s easy to edit later:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp -av /Applications/MAMP/conf/apache/httpd.conf<span class="o">{</span>,-default<span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">USERHOME</span><span class="o">=</span><span class="k">$(</span>dscl . -read /Users/<span class="sb">`</span>whoami<span class="sb">`</span> NFSHomeDirectory | awk -F<span class="s2">&quot;\: &quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -e <span class="s2">&quot;\n# User VirtualHosts file (added after MAMP installer)\nInclude ${USERHOME}/Sites/mamp-vhosts.conf&quot;</span> &gt;&gt; /Applications/MAMP/conf/apache/httpd.conf <span class="o">&amp;&amp;</span> <span class="nb">unset </span>USERHOME
</span><span class='line'>
</span><span class='line'><span class="o">[</span> ! -d ~/Sites/logs <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir -pv ~/Sites/logs
</span></code></pre></td></tr></table></div></figure>


<p><strong><em>IMPORTANT!</em></strong> Be sure to copy and paste the lines containing <code>PORTNUM</code> through the last <code>EOF</code> as a <strong><em>single</em></strong> command (this entire block is a single copy+paste):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="err">PORTNUM=$(</span><span class="nb">egrep</span> &#39;^Listen [0-9]*&#39; <span class="sx">/Applications/MAMP/conf/apache/httpd.conf</span> | awk &#39;{print $2}&#39;) USERHOME=$(dscl . -read <span class="sx">/Users/</span>`whoami` NFSHomeDirectory | awk -F<span class="s2">&quot;\: &quot;</span> &#39;{print $2}&#39;) cat &gt; ~/Sites/mamp-vhosts.conf &lt;&lt;EOF
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Use name-based virtual hosting.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="nb">NameVirtualHost</span> *:${PORTNUM}
</span><span class='line'>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Set up permissions for VirtualHosts in ~/Sites</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="nt">&lt;Directory</span> <span class="s">&quot;${USERHOME}/Sites&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">Options</span> Indexes FollowSymLinks MultiViews
</span><span class='line'>    <span class="nb">AllowOverride</span> <span class="k">All</span>
</span><span class='line'>    <span class="nb">Order</span> allow,deny
</span><span class='line'>    <span class="nb">Allow</span> from <span class="k">all</span>
</span><span class='line'><span class="nt">&lt;/Directory&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># For http://localhost in the MAMP default location</span>
</span><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">_default_:${PORTNUM}</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">ServerName</span> localhost
</span><span class='line'>    <span class="nb">DocumentRoot</span> <span class="s2">&quot;/Applications/MAMP/htdocs&quot;</span>
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># VirtualHosts</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="c">## VirtualHost template</span>
</span><span class='line'><span class="c">#&lt;VirtualHost *:${PORTNUM}&gt;</span>
</span><span class='line'><span class="c">#  ServerName domain.local</span>
</span><span class='line'><span class="c">#  CustomLog &quot;${USERHOME}/Sites/logs/domain.local-access_log&quot; combined</span>
</span><span class='line'><span class="c">#  ErrorLog &quot;${USERHOME}/Sites/logs/domain.local-error_log&quot;</span>
</span><span class='line'><span class="c">#  DocumentRoot &quot;${USERHOME}/Sites/domain.local&quot;</span>
</span><span class='line'><span class="c">#&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Automatic VirtualHosts</span>
</span><span class='line'><span class="c"># A directory at ${USERHOME}/Sites/webroot can be accessed at http://webroot.dev</span>
</span><span class='line'><span class="c"># In Drupal, uncomment the line in .htaccess with: RewriteBase /</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This log format will display the per-virtual-host as the first field followed by a typical log line</span>
</span><span class='line'><span class="nb">LogFormat</span> <span class="s2">&quot;%V %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot;</span> combinedmassvhost
</span><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">*:${PORTNUM}</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">ServerName</span> dev
</span><span class='line'>  <span class="nb">ServerAlias</span> *.dev
</span><span class='line'>
</span><span class='line'>  <span class="nb">CustomLog</span> <span class="s2">&quot;${USERHOME}/Sites/logs/dev-access_log&quot;</span> combinedmassvhost
</span><span class='line'>  <span class="nb">ErrorLog</span> <span class="s2">&quot;${USERHOME}/Sites/logs/dev-error_log&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">VirtualDocumentRoot</span> ${USERHOME}/Sites/%-2+
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span><span class='line'><span class="nb">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you read that closely, you&rsquo;ll see that it&rsquo;s set up to do <a href="http://httpd.apache.org/docs/2.2/vhosts/mass.html">MassVirtualHosts</a> using the <code>*.dev</code> tld. For example, set up a web root at <code>$HOME/Sites/project</code> and you will be able to view it at <a href="http://project.dev:8888">http://project.dev:8888</a> without needing to create a separate VirtualHost. A custom log format is used, putting the domain name at the beginning of the line, so you can easily see the output as it related to a project.</p>

<h2>Finishing Up</h2>

<p>Open the MAMP application to <strong>Start Servers</strong>. Note that if you ever change the Apache port number, you&rsquo;ll need to edit <code>~/Sites/mamp-vhosts.conf</code> appropriately.</p>

<p>As always with MAMP, you can work out of <a href="http://localhost:8888/">http://localhost:8888/</a> by putting files in <code>/Applications/MAMP/htdocs</code>. For example, the folder <code>/Applications/MAMP/drupal</code> will be accessible at <a href="http://localhost:8888/drupal">http://localhost:8888/drupal</a>. You can find other MAMP tools at <a href="http://localhost:8888/MAMP">http://localhost:8888/MAMP</a>.</p>

<p>If you&rsquo;re having trouble connecting to MySQL with Sequel Pro or another utility, use <code>/Applications/MAMP/tmp/mysql/mysql.sock</code> as the socket path. If MAMP&rsquo;s MySQL is the only service running mysqld, this should not be necessary but YMMV&hellip;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/04/apache-modules-on-os-x-with-homebrew/">Apache Modules on OS X With Homebrew</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-04T11:27:00-04:00" pubdate data-updated="true">Sep 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have long been a big fan of <a href="http://mxcl.github.com/homebrew">Homebrew</a>, a way of adding open-source software to OS X without much of the overhead and systems link <a href="http://www.macports.org">MacPorts</a> and <a href="http://www.finkproject.org">Fink</a> introduce. It&rsquo;s quickly become my favorite way to do PHP-based development on a Mac, and I&rsquo;ve <a href="http://echodittolabs.org/blog/2012/04/os-x-107-lion-development-nginx-php-mariadb-homebrew">blogged</a> <a href="http://echodittolabs.org/blog/2011/09/os-x-107-lion-development-native-apache-php-homebrew-mysql-or-mariadb">before</a> about various ways to integrate Homebrew-based software into your workflow.</p>

<p>In preparing new documentation for using Homebrew on 10.7 and 10.8 (coming soon to <a href="http://echodittolabs.org/blogs/alan-ivey">my EchoDitto blog</a>), I wanted to find a way to run either <a href="http://httpd.apache.org/docs/2.2/mod/mod_suexec.html">mod_suexec</a> or <a href="http://www.fastcgi.com/mod_fastcgi/docs/mod_fastcgi.html">mod_fastcgi</a> so I could use the built-in version of Apache without having to change folder ownership in random places where the web server needed to modify files. Homebrew did not have any formulas, but I found that <a href="http://github.com/lifepillar">Lifepillar</a> had written formulas <a href="https://github.com/mxcl/homebrew/pull/12093/files">(mod_fastcgi)</a> <a href="https://github.com/mxcl/homebrew/pull/12091">(mod_suexec)</a> for them both and was hoping to get them into Homebrew.</p>

<p>Driven solely by my desire to have my documentation easier to follow, I set up a <a href="https://github.com/mxcl/homebrew/wiki/Homebrew-0.9">brew tap</a> for these two Apache modules. Shortly after adding it to the list of <a href="https://github.com/mxcl/homebrew/wiki/Interesting-Taps-&amp;-Branches">interesting taps and branches</a>, the decision was made to <a href="https://github.com/mxcl/homebrew/issues/14622">incorporate the repository under the Homebrew organization</a> and have a place just for Apache modules.</p>

<p>As of today, here are the modules available in the tap:</p>

<ul>
<li><a href="https://github.com/Homebrew/homebrew-apache/blob/master/mod_fastcgi.rb">mod_fastcgi</a> &ndash; written by <a href="https://github.com/lifepillar">lifepillar</a></li>
<li><a href="https://github.com/Homebrew/homebrew-apache/blob/master/mod_suexec.rb">mod_suexec</a> &ndash; written by <a href="https://github.com/lifepillar">lifepillar</a>, 10.8 work by <a href="https://github.com/alanthing">me</a></li>
<li><a href="https://github.com/Homebrew/homebrew-apache/blob/master/mod_fcgid.rb">mod_fcgid</a> &ndash; written by <a href="https://github.com/rjocoleman">rjocoleman</a></li>
<li><a href="https://github.com/Homebrew/homebrew-apache/blob/master/mod_bonjour.rb">mod_bonjour</a> &ndash; written by <a href="https://github.com/joemaller">joemaller</a></li>
<li><a href="https://github.com/Homebrew/homebrew-apache/blob/master/mod_python.rb">mod_python</a> and <a href="https://github.com/Homebrew/homebrew-apache/blob/master/mod_wsgi.rb">mod_wsgi</a> &ndash; copied from main Homebrew formulas</li>
</ul>


<p>If you have any problems or questions, let me know in the issue queue! Or write a formula and submit a pull request!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/29/three-ways-get-drush-os-x/">Three Ways to Get Drush on OS X</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-29T15:18:00-04:00" pubdate data-updated="true">Aug 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://echodittolabs.org/blog/2011/03/keep-drush-up-to-date">As I&rsquo;ve said before</a>, we love <a href="http://drupal.org/project/drush">drush</a>. It&rsquo;s hard to imagine doing Drupal work without it. If OS X is your workstation, it&rsquo;s pretty simple to install with pear, as described on the project page. Let&rsquo;s review that method and cover two others, git and Homebrew, and how to keep them updated.</p>

<p>All commands listed below are to be executed on the command line with the Terminal application. But if you use Drush regularly then you already knew that!</p>

<h2>Homebrew</h2>

<p>If you need introduced to Homebrew, or need help installing it, check out the <a href="http://mxcl.github.com/homebrew/">Homebrew project homepage</a>. The installation script is at the bottom.</p>

<p>Ready to install drush?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install drush</span></code></pre></td></tr></table></div></figure>


<p>Yup, that&rsquo;s it! Upgrading is simple as well, as explained in the <a href="https://github.com/mxcl/homebrew/wiki/FAQ">Homebrew FAQ</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew update
</span><span class='line'>brew upgrade drush</span></code></pre></td></tr></table></div></figure>


<h2>PEAR</h2>

<p>Whether you&rsquo;ve installed your own copy of PHP with Homebrew, are using the one included with MAMP, or the version provided by OS X, drush is easy to install using the <code>pear</code> command.</p>

<p>If you are using the built-in php with OS X, you&rsquo;ll need to prefix each command with <code>sudo</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pear channel-discover pear.drush.org</span></code></pre></td></tr></table></div></figure>


<p><strong>Homebrew Note:</strong> If you are using Homebrew and get an error about not being able to create a lock file, run the following command (change php54 to php53 if applicable): <code>touch $(brew --prefix php54)/lib/php/.lock &amp;&amp; chmod 0644 $(brew --prefix php54)/lib/php/.lock</code></p>

<p>Continue by installing drush now that the channel is added:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pear install drush/drush
</span><span class='line'>pear upgrade --force Console_Getopt</span></code></pre></td></tr></table></div></figure>


<p><strong>Homebrew Note:</strong> If you do not have drush available in your path after installing, relink PHP and you should then have the symlink available in <em>/usr/local/bin</em>: <code>brew unlink php54 &amp;&amp; brew link php54</code></p>

<p>Upgrading is also easy (again, if using the built-in PHP with OS X, prefix with <code>sudo</code>):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pear channel-update pear.drush.org
</span><span class='line'>pear upgrade drush</span></code></pre></td></tr></table></div></figure>


<h2>Git</h2>

<p>If you would prefer to keep track of the source code for Drush, or perhaps be a contributor, you will want to use Git so you can easily make and keep track of changes. If you do not have git installed on your system, install <a href="http://itunes.apple.com/us/app/xcode/id497799835?mt=12">Xcode</a> or <a href="http://developer.apple.com/downloads">Command Line Tools for Xcode</a> and then proceed. These commands will clone the drush repository, checkout the latest stable tag, and create a symlink in <em>/usr/local/bin</em>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ ! -d /usr/local ] && sudo mkdir /usr/local && sudo chgrp admin /usr/local && sudo chmod g+rwx /usr/local
</span><span class='line'>git clone http://git.drupal.org/project/drush.git /usr/local/drush
</span><span class='line'>cd /usr/local/drush
</span><span class='line'>git checkout $(git tag|grep "^[0-9]"|egrep -v "alpha|beta|rc"|tail -1)
</span><span class='line'>cd /usr/local/bin 2&gt;/dev/null || mkdir /usr/local/bin && cd /usr/local/bin
</span><span class='line'>ln -s ../drush/drush || sudo ln -s ../drush/drush</span></code></pre></td></tr></table></div></figure>


<p>To update, fetch the latest code and grab the latest stable tag:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /usr/local/drush
</span><span class='line'>git fetch
</span><span class='line'>git checkout $(git tag|grep "^[0-9]"|egrep -v "alpha|beta|rc"|tail -1)</span></code></pre></td></tr></table></div></figure>


<p>If you have any questions or improvements, please leave a comment!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/24/never-touch-your-local-etchosts-file-os-x-again/">Never Touch Your Local /etc/hosts File in OS X Again</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-24T08:20:00-04:00" pubdate data-updated="true">Apr 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In each of my posts on setting up a <a href="http://echodittolabs.org/blog/2012/04/os-x-107-lion-development-nginx-php-mariadb-homebrew">local</a> <a href="http://echodittolabs.org/blog/2011/10/os-x-107-lion-development-macports">development</a> <a href="http://echodittolabs.org/blog/2011/09/os-x-107-lion-development-native-apache-php-homebrew-mysql-or-mariadb">environment</a> <a href="http://echodittolabs.org/blog/2011/08/os-x-107-lion-development-native-mamp-mysql-installer">on OS X</a>, it&rsquo;s mentioned that you need to add your website&rsquo;s domain, even though it&rsquo;s local, in your /etc/hosts file. My preferred way to edit the hosts file on OS X is using <a href="http://code.google.com/p/gmask/">Gas Mask</a>. If you wanted to create the local virtual host <strong>projectx.dev</strong>, you would add the line <code>127.0.0.1 projectx.dev</code> in /etc/hosts or with Gas Mask, and then use that same value in either <strong>ServerName</strong> in Apache or <strong>server_name</strong> in Nginx. This can be tedious for adding new sites. Luckily there&rsquo;s a way to set this up once and then never have to edit your hosts file again for adding new local virtual hosts.</p>

<p>You&rsquo;ll need a copy of dnsmasq, and I find this is most easily installed via Homebrew. If you haven&rsquo;t already, grab either <a href="http://itunes.apple.com/us/app/xcode/id448457090">Xcode</a> or <a href="http://kennethreitz.com/xcode-gcc-and-homebrew.html">Xcode Command Line Tools</a> and <a href="https://github.com/mxcl/homebrew/wiki/installation">install Homebrew</a>.</p>

<p>The steps below will install dnsmasq from Homebrew, configure dnsmasq to return the IP address &lsquo;127.0.0.1&rsquo; for all requests to the fake top-level-domain &ldquo;.dev,&rdquo; start dnsmasq on boot (don&rsquo;t worry, it&rsquo;s an extremely light-weight process), and configure OS X to use dnsmasq for queries ending in &ldquo;.dev.&rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install dnsmasq
</span><span class='line'>mkdir -pv $(brew --prefix)/etc/
</span><span class='line'>echo 'address=/.dev/127.0.0.1' &gt; $(brew --prefix)/etc/dnsmasq.conf
</span><span class='line'>sudo cp -v $(brew --prefix dnsmasq)/homebrew.mxcl.dnsmasq.plist /Library/LaunchDaemons
</span><span class='line'>sudo launchctl load -w /Library/LaunchDaemons/homebrew.mxcl.dnsmasq.plist
</span><span class='line'>sudo mkdir -v /etc/resolver
</span><span class='line'>sudo bash -c 'echo "nameserver 127.0.0.1" &gt; /etc/resolver/dev'</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it! You can run <code>scutil --dns</code> to show all of your current resolvers, and you should see that all requests for a domain ending in .dev will go to the DNS server at 127.0.0.1:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resolver #9
</span><span class='line'>  domain   : dev
</span><span class='line'>  nameserver[0] : 127.0.0.1</span></code></pre></td></tr></table></div></figure>


<p>If you ping any domain that ends in .dev, you&rsquo;ll get the IP address 127.0.0.1 back as a result:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ping -c 1 thereisnowaythisisarealdomain.dev
</span><span class='line'>PING thereisnowaythisisarealdomain.dev (127.0.0.1): 56 data bytes
</span><span class='line'>64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.057 ms</span></code></pre></td></tr></table></div></figure>


<p>Note that if you&rsquo;re using Mountain Lion you may need to reboot before the /etc/resolver settings take effect globally. I was able to get pings to work right away but Chrome would not resolve properly until I restarted.</p>

<p>Now you can set up a new virtual host with <strong>anydomain.dev</strong>, and it&rsquo;ll be available as soon as you reload Apache or Nginx! You could extend this by enabling <a href="http://httpd.apache.org/docs/2.2/vhosts/mass.html">Mass Virtual Hosting for Apache</a> or <a href="http://forum.nginx.org/read.php?2,218617,218617#msg-218617">similar with Nginx</a>, though both require consistent layout of directories. Have fun configuring less stuff on your system!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/23/redirect-all-port-80-requests-port-8080/">Redirect All Port 80 Requests to Port 8080</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-23T09:50:00-04:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://echodittolabs.org/blog/2012/04/os-x-107-lion-development-nginx-php-mariadb-homebrew">In my previous post</a>, I walked through how to set up a local environment using Nginx running on port 8080 so as to avoid running anything as root or with sudo. Something that I&rsquo;ve found incredibly annoying is when I forget to specify the port I get an error in my browser, or Chrome might even suggest something based on a search term. It&rsquo;s fairly easy though to configure Apache to route everything to another port.</p>

<p>Create the file <em>/etc/apache2/other/port8080-redirect.conf</em> as root. It&rsquo;s probably easiest to hop into Terminal and use nano:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo nano -w /etc/apache2/other/port8080-redirect.conf
</span></code></pre></td></tr></table></div></figure>


<p>Enter the following lines and save and exit the editor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">_default_:80</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">DocumentRoot</span> <span class="sx">/Library/WebServer/Documents</span>
</span><span class='line'>  <span class="nb">RewriteEngine</span> <span class="k">On</span>
</span><span class='line'>  <span class="c"># Redirect all requests to the local Apache server to port 8080</span>
</span><span class='line'>  <span class="nb">RewriteRule</span> ^.*$ http://%{HTTP_HOST}:8080%{REQUEST_URI}
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Even though the <em>DocumentRoot</em> doesn&rsquo;t appear to be necessary, I wasn&rsquo;t able to get this working without it.</p>

<p>Go into System Preferences, open the Sharing preference pane, and check the box for Web Sharing. If you have trouble getting the check to &ldquo;stick,&rdquo; you can run the following in Terminal: <code>sudo apachectl restart</code></p>

<p>Now if you go in your browser and hit a domain you have defined in <em>/etc/hosts</em>, like <strong><a href="http://drupal.local/**,">http://drupal.local/**,</a> you&rsquo;ll automatically be redirected to </strong><a href="http://drupal.local:8080/**">http://drupal.local:8080/**</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/22/os-x-107-lion-development-nginx-php-mariadb-homebrew/">OS X 10.7 Lion Development: Nginx, PHP, MariaDB With Homebrew</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T20:41:00-04:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://wiki.nginx.org">Nginx</a> is quickly becoming a popular, low resource alternative to Apache for many websites. This doesn&rsquo;t come without challenges, such as using PHP as CGI due to not having mod_php available. Nginx also does not use any Apache configuration rules, nor does it use .htaccess or anything like it, so it requires additional configuration regardless of the web application being deployed. A big help in getting Nginx started with Drupal is <a href="https://github.com/perusio">António P. P. Almeida&rsquo;s</a> <a href="https://github.com/perusio/drupal-with-nginx/">drupal-with-nginx configuration</a>, which makes it fairly simple to deploy in Linux. But what about local development on OS X? Read on to learn get all of the required components set up for your system, as well as the modifications necessary to get drupal-with-nginx set up on OS X.</p>

<h2>Prerequisites</h2>

<p>We&rsquo;ll be building all of our packages with <a href="http://mxcl.github.com/homebrew/">Homebrew</a>, which is, in my opinion, one of the best ways to easily add lot&rsquo;s of great open-source software on OS X. Homebrew requires that you have a compiler, so you can either install the huge <a href="http://itunes.apple.com/us/app/xcode/id448457090">Xcode package</a>, or I would recommend Apple&rsquo;s <a href="http://kennethreitz.com/xcode-gcc-and-homebrew.html">Xcode Command Line Tools</a> which is a much smaller download and officially supported by Homebrew.</p>

<p>Once you have either Xcode or Xcode Command Line Tools installed, <a href="https://github.com/mxcl/homebrew/wiki/installation">install Homebrew</a>.</p>

<p>Note that for all commands below that are starting with a <strong>$</strong>, the dollar sign is showing a command-line prompt in <a href="http://www.apple.com/macosx/apps/all.html#terminal">Terminal</a>, and you should not actually type it as part of the commands. I also make heavy use of <code>$(brew --prefix)</code> to make these instructions persist passed current Homebrew formula versions, and hopefully also for an installation with Homebrew in a path other than /usr/local, though I have not tested it.</p>

<p>Also note that many times in this post you will see <strong>/n</strong>; make sure you type those or include them with your copy and paste, they are not CMS errors :)</p>

<h2>Database: MariaDB</h2>

<p>I&rsquo;ve <a href="http://echodittolabs.org/blog/2011/09/os-x-107-lion-development-native-apache-php-homebrew-mysql-or-mariadb">covered before why I like MariaDB</a>, but you could easily swap this out with MySQL if you would rather. We&rsquo;ll start by installing MariaDB with Homebrew.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install mariadb pidof <span class="o">(</span>note: OS X may ask you <span class="k">if </span>you want to install <span class="s1">&#39;javac&#39;</span><span class="o">)</span>
</span><span class='line'><span class="nb">unset </span>TMPDIR
</span><span class='line'>mysql_install_db --verbose --user<span class="o">=</span><span class="sb">`</span>whoami<span class="sb">`</span> --basedir<span class="o">=</span><span class="s2">&quot;$(brew --prefix mariadb)&quot;</span> --datadir<span class="o">=</span><span class="k">$(</span>brew --prefix<span class="k">)</span>/var/mysql --tmpdir<span class="o">=</span>/tmp
</span><span class='line'>cp <span class="k">$(</span>brew --prefix mariadb<span class="k">)</span>/share/mysql/my-small.cnf <span class="k">$(</span>brew --prefix mariadb<span class="k">)</span>/my.cnf
</span><span class='line'>sed -i <span class="s2">&quot;&quot;</span> <span class="s1">&#39;s/max_allowed_packet = 1.*M/max_allowed_packet = 2G/g&#39;</span> <span class="k">$(</span>brew --prefix mariadb<span class="k">)</span>/my.cnf
</span><span class='line'><span class="o">[</span> ! -d ~/Library/LaunchAgents <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir ~/Library/LaunchAgents
</span><span class='line'><span class="o">[</span> -f <span class="k">$(</span>brew --prefix mariadb<span class="k">)</span>/homebrew.mxcl.mariadb.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> cp -v <span class="k">$(</span>brew --prefix mariadb<span class="k">)</span>/homebrew.mxcl.mariadb.plist ~/Library/LaunchAgents/
</span><span class='line'><span class="o">[</span> -f ~/Library/LaunchAgents/homebrew.mxcl.mariadb.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.mariadb.plist
</span><span class='line'><span class="k">$(</span>brew --prefix mariadb<span class="k">)</span>/bin/mysql_secure_installation
</span></code></pre></td></tr></table></div></figure>


<p>Note: you could alternatively run: <code>$(brew --prefix mariadb)/bin/mysqladmin -u root password 'new-password'</code> instead of <code>mysql_secure_installation</code></p>

<h2>PHP</h2>

<p>OS X comes with PHP installed, but it doesn&rsquo;t come with PHP-FPM. While it&rsquo;s likely possible to run PHP as FastCGI with the built-in OS X, I prefer to install PHP with Homebrew since we&rsquo;re using Homebrew for everything else, and it keeps everything self-contained in Homebrew&rsquo;s root (defaults to /usr/local). Note that the <code>brew tap</code> command requires <a href="https://github.com/mxcl/homebrew/wiki/Homebrew-0.9">Homebrew 0.9 or greater</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew tap josegonzalez/php
</span><span class='line'>brew install php --with-mariadb --with-suhosin --with-fpm
</span><span class='line'>mkdir -v <span class="k">$(</span>brew --prefix php<span class="k">)</span>/var/log
</span><span class='line'>cp -v <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php-fpm.conf.default <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php-fpm.conf
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s|;\(daemonize[[:space:]]*=[[:space:]]*\)yes|\1no|g&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php-fpm.conf
</span><span class='line'><span class="o">[</span> ! -d ~/Library/LaunchAgents <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir ~/Library/LaunchAgents
</span><span class='line'><span class="o">[</span> -f <span class="k">$(</span>brew --prefix php<span class="k">)</span>/org.php-fpm.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> cp -v <span class="k">$(</span>brew --prefix php<span class="k">)</span>/org.php-fpm.plist ~/Library/LaunchAgents/
</span><span class='line'><span class="o">[</span> -f ~/Library/LaunchAgents/org.php-fpm.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> launchctl load -w ~/Library/LaunchAgents/org.php-fpm.plist
</span></code></pre></td></tr></table></div></figure>


<p>I would recommend the following settings for full compatibility with drupal-with-nginx, and to set the time zone to silence a lot of PHP warnings:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s|;\(pm.status_path[[:space:]]*=[[:space:]]*/\)\(status\)|\1fpm-\2|g&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php-fpm.conf
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s|;\(ping.path[[:space:]]*=[[:space:]]*/ping\)|\1|g&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php-fpm.conf
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s|;\(ping.response[[:space:]]*=[[:space:]]*pong\)|\1|g&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php-fpm.conf
</span><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s|;\(date\.timezone[[:space:]]*=\).*|\1 $(php -d &#39;error_reporting=&#39; -r &#39;echo date(&quot;</span>e<span class="s2">&quot;, time());&#39;)|g&quot;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php.ini
</span></code></pre></td></tr></table></div></figure>


<p>By default, PHP-FPM runs on a socket, which means that connections to PHP-FPM will require using TCP. You also have the option to use Unix sockets, which means slightly less overhead in PHP-FPM connections. Note that the drupal-with-nginx repository is set up for TCP by default, though if you choose to run the following command I will tell you how to use Unix sockets with Nginx.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s|\(listen[[:space:]]*=[[:space:]]*\)127.0.0.1:9000|\1var/www.sock|g&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php-fpm.conf
</span></code></pre></td></tr></table></div></figure>


<h3>Optional: PHP Extensions</h3>

<p>The <a href="https://github.com/josegonzalez/homebrew-php">third-party Homebrew keg that we &ldquo;tapped&rdquo; into</a> also provides easy formulas for PHP extensions. None of these are required to run Nginx and Drupal locally. You may also note that <em>uploadprogress</em> does not work with anything but mod_php, but by installing it now you could theoretically use the same PHP installation with Apache if you wanted and already have it ready to go. Feel free to omit it, or any of these below, though I would at least recommend APC for performance reasons.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install uploadprogress-php
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n[uploadprogress]\nextension=\&quot;$(brew --prefix uploadprogress-php)/uploadprogress.so\&quot;&quot;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php.ini
</span><span class='line'>brew install apc-php
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n[apc]\nextension=\&quot;$(brew --prefix apc-php)/apc.so\&quot;\napc.enabled=1 \napc.shm_segments=1 \napc.shm_size=64M \napc.ttl=7200 \napc.user_ttl=7200 \napc.num_files_hint=1024 \napc.mmap_file_mask=/tmp/apc.XXXXXX \napc.enable_cli=1&quot;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/php.ini
</span><span class='line'>brew install memcache-php
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n[memcache]\nextension=\&quot;$(brew --prefix memcache-php)/memcache.so\&quot;&quot;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php.ini
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;memcache.hash_strategy=\&quot;consistent\&quot;&quot;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php.ini
</span><span class='line'>brew install xdebug-php
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n[xdebug]\nzend_extension=\&quot;$(brew --prefix xdebug-php)/xdebug.so\&quot;&quot;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php.ini
</span><span class='line'>brew install xhprof-php
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n[xhprof]\nextension=\&quot;$(brew --prefix xhprof-php)/xhprof.so\&quot;&quot;</span> &gt;&gt; <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/php.ini
</span></code></pre></td></tr></table></div></figure>


<p>Once you&rsquo;ve finished configuring PHP, you can reload the settings for PHP-FPM (or, you could find the pid of the first php-fpm process and send it the SIGUSR2 signal; this is easier):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span> -f ~/Library/LaunchAgents/org.php-fpm.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> launchctl unload -w ~/Library/LaunchAgents/org.php-fpm.plist <span class="o">&amp;&amp;</span> launchctl load -w ~/Library/LaunchAgents/org.php-fpm.plist
</span></code></pre></td></tr></table></div></figure>


<h2>Nginx</h2>

<p>After compiling MariaDB and PHP, you&rsquo;re probably not too excited about compiling another application. Luckily, Nginx is a faily quick build, at least compared to MariaDB and PHP. We&rsquo;ll include some build options not on by default since they add features references in drupal-with-nginx, and we&rsquo;ll also add some 3rd party extensions as well. We&rsquo;ll start by grabbing those extensions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -s -L -o /tmp/nginx-upload-progress.tar.gz https://github.com/masterzen/nginx-upload-progress-module/tarball/v0.9.0 <span class="o">&amp;&amp;</span> mkdir /tmp/nginx-upload-progress <span class="o">&amp;&amp;</span> tar zxpf /tmp/nginx-upload-progress.tar.gz --strip-components 1 -C /tmp/nginx-upload-progress <span class="o">&amp;&amp;</span> rm /tmp/nginx-upload-progress.tar.gz
</span><span class='line'>curl -s -L -o /tmp/nginx-fair.tar.gz http://github.com/gnosek/nginx-upstream-fair/tarball/master <span class="o">&amp;&amp;</span> mkdir /tmp/nginx-fair <span class="o">&amp;&amp;</span> tar zxpf /tmp/nginx-fair.tar.gz --strip-components 1 -C /tmp/nginx-fair <span class="o">&amp;&amp;</span> rm /tmp/nginx-fair.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>The next section is one giant line of sed regex that will edit the Homebrew formula for nginx to add the additional compile options that we need. Make sure it all gets entered as one line (yes, you should use copy and paste here)!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -i <span class="s1">&#39;-default&#39;</span> <span class="s1">&#39;s/\([[:space:]]*\[&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;--\)\(with-webdav\)\(&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;,[[:space:]]*&quot;\)\(Compile with support for WebDAV module\)\(&quot;\]\)/\1\2\3\4\5,%\1with-realip\3Compile with support for RealIP module\5,%\1with-gzip_static\3Compile with support for Gzip Static module\5,%\1with-uploadprogress\3Compile with support for Upload Progress module\5,%\1with-fair\3Compile with support for Fair module\5,%\1with-mp4\3Compile with support for MP4 module\5,%\1with-flv\3Compile with support for FLV module\5,%\1with-stub_status\3Compile with support for Stub Status module\5/; s/\([[:space:]]* args &lt;&lt; &quot;--\)\(with-http_dav_module\)\(&quot; if ARGV.include? &#39;</span><span class="se">\&#39;</span><span class="s1">&#39;--with-\)\(webdav\)\(&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;.*\)/\1\2\3\4\5%\1with-http_realip_module\3realip\5%\1with-http_gzip_static_module\3gzip_static\5%\1add-module=\/tmp\/nginx-upload-progress\3uploadprogress\5%\1add-module=\/tmp\/nginx-fair\3fair\5%\1with-http_mp4_module\3mp4\5%\1with-http_flv_module\3flv\5%\1with-http_stub_status_module\3stub_status\5/; y/%/\n/&#39;</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/Library/Formula/nginx.rb
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;ll install Nginx with our new build options and extensions and start it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install nginx --with-realip --with-gzip_static --with-mp4 --with-flv --with-stub_status --with-uploadprogress --with-fair
</span><span class='line'><span class="o">[</span> <span class="nv">$?</span> -eq 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -rf /tmp/nginx-upload-progress /tmp/nginx-fair
</span><span class='line'>mkdir -vp <span class="k">$(</span>brew --prefix nginx<span class="k">)</span>/var/<span class="o">{</span>microcache,log,run<span class="o">}</span>
</span><span class='line'><span class="o">[</span> ! -d ~/Library/LaunchAgents <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir ~/Library/LaunchAgents
</span><span class='line'><span class="o">[</span> -f <span class="k">$(</span>brew --prefix nginx<span class="k">)</span>/homebrew.mxcl.nginx.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> cp -v <span class="k">$(</span>brew --prefix nginx<span class="k">)</span>/homebrew.mxcl.nginx.plist ~/Library/LaunchAgents/
</span><span class='line'><span class="o">[</span> -f ~/Library/LaunchAgents/homebrew.mxcl.nginx.plist <span class="o">]</span> <span class="o">&amp;&amp;</span> launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.nginx.plist
</span></code></pre></td></tr></table></div></figure>


<h2>Nginx-With-Drupal</h2>

<p>We&rsquo;re now ready to set up Nginx to work with Drupal. <a href="https://github.com/alanthing/drupal-with-nginx/tree/osx-1.0.x">I&rsquo;ve created a fork of the original repository</a> to make some necessary changes for OS X. I also make several changes for the stable 1.0.x branch of Nginx, which we&rsquo;ve just installed, rather than the unstable 1.1.x branch that is in the original configuration.</p>

<p>If you want to stick with the original project, <a href="https://github.com/alanthing/drupal-with-nginx/commit/f13f7d8ce9af0853a5601dcbb90c5e0c2ed8dadd">check out the changes I made for OS X and 1.0.x</a> and you can apply them yourself and skip the git steps below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span> -d <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/nginx <span class="o">]</span> <span class="o">&amp;&amp;</span> mv -v <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/nginx <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/nginx-default
</span><span class='line'>git clone https://github.com/alanthing/drupal-with-nginx.git <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/nginx
</span><span class='line'><span class="nb">cd</span> <span class="k">$(</span>brew --prefix<span class="k">)</span>/etc/nginx
</span><span class='line'>git checkout osx-1.0.x
</span><span class='line'>mkdir sites-enabled
</span><span class='line'><span class="nb">cd </span>sites-enabled
</span><span class='line'>ln -s ../sites-available/000-default
</span><span class='line'>cp -a ../sites-available/example.com.conf yournewsite.conf
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s about as much as I can automate for you with copy+paste-able commands! You&rsquo;ll want to do the following to <em>yournewsite</em>.conf, which you can rename to be anything, to configure Nginx for your website:</p>

<ul>
<li>Change <code>server_name</code>, <code>access_log</code>, and <code>error_log</code> to use your local domain name for your virtual host</li>
<li>Change root to the path of your Drupal installation. On my system, this may be <em>/Users/alan/Sites/drupal-7.14</em>. Note that you cannot use <em>~</em> in place of <em>/Users/name</em></li>
<li>Unless you have a valid SSL certificate, you&rsquo;ll probably want to completely delete the second half of the file. So find the line containing <code>} HTTP server</code> and remove all following lines</li>
<li>If you&rsquo;re using Boost with Drupal 7, or Drupal 6 with/without Boost, note that you&rsquo;ll want to comment out the <code>include sites-available/drupal.conf</code> line and uncomment the other relevant one for your site</li>
<li>If you want to get additional status messages from PHP-FPM, uncomment <code>include php_fpm_status_vhost.conf</code> in this file, and also <code>include php_fpm_status_allowed_hosts.conf</code> in <code>$(brew --prefix)/etc/nginx/nginx.conf</code></li>
<li>If you configured PHP-FPM earlier to use Unix sockets instead of TCP, open nginx.conf and comment out <code>include upstream_phpcgi_tcp.conf</code> and uncomment <code>include upstream_phpcgi_unix.conf</code></li>
<li>Depending on the location of your files directory, you may need to edit the <code>sites-available/drupal.conf</code> (or other drupal*.conf) file and change the relevant sites/default/files paths appropriately</li>
</ul>


<p>Once you&rsquo;re finished editing your virtual host conf file (and possibly nginx.conf), you can reload nginx easily:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">$(</span>brew --prefix<span class="k">)</span>/sbin/nginx -s reload
</span></code></pre></td></tr></table></div></figure>


<h2>Bonus: Drush</h2>

<p>You&rsquo;ll need Drush to install a new Drupal site, as install.php is blocked for security reasons by default. Also, you&rsquo;ll find cron.php is inaccessible as well. There&rsquo;s a weird little hack required to get Drush installed with Homebrew without requiring sudo, so below is an example of how to both get around the sudo requirement and set up a blank Drupal 7 website (note that using the root MySQL user is bad form, but this is meant more as a quick demo of using drush with this setup than a recommended setup).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch <span class="k">$(</span>brew --prefix php<span class="k">)</span>/lib/php/.lock
</span><span class='line'>chmod 0644 <span class="k">$(</span>brew --prefix php<span class="k">)</span>/lib/php/.lock
</span><span class='line'><span class="k">$(</span>brew --prefix<span class="k">)</span>/bin/pear channel-discover pear.drush.org
</span><span class='line'><span class="k">$(</span>brew --prefix<span class="k">)</span>/bin/pear install drush/drush
</span><span class='line'>brew unlink php <span class="o">&amp;&amp;</span> brew link php
</span><span class='line'><span class="nb">cd</span> ~/Sites 2&gt;/dev/null <span class="o">||</span> mkdir ~/Sites <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/Sites
</span><span class='line'>drush dl
</span><span class='line'>mysql -uroot -p<span class="s1">&#39;yourpassword&#39;</span> -e<span class="s1">&#39;create database drupal;&#39;</span>
</span><span class='line'><span class="nb">cd </span>drupal-7.14
</span><span class='line'>drush si --db-url<span class="o">=</span>mysql://root:yourpassword@localhost/drupal
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/11/creating-php-packages-software-collection/">Creating PHP Packages as a Software Collection</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/09/speed-up-php-on-nfs-with-turbo-realpath/">Speed Up PHP on NFS With Turbo_realpath</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/17/virtualbox-extension-pack-with-one-line/">VirtualBox Extension Pack With One Line</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/21/real-time-ruby-gem-development/">&#8220;Real-time&#8221; Ruby Gem Development</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/19/usable-mamp-os-x-108-mountain-lion/">Usable MAMP on OS X 10.8 Mountain Lion</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Coderwall</h1>
  <ul id="cw_badges">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <div>
    <a href="http://coderwall.com/alanthing" target="_blank" class="cw_badge"><img
       alt="Endorse alanthing on Coderwall"
       src="http://api.coderwall.com/alanthing/endorsecount.png" /></a>
  </div>
  

  <script type="text/javascript">
    var coderwall = (function(){
      function render(options, badges){
        var fragment = '',
            t = $(options.target),
            height = 65,
            width = 65,
            index;

        for (index in badges) {
          fragment += '<a class="cw_badge"title="' + badges[index].description + '" target="_blank" href="http://coderwall.com/' + options.user + '">';
          fragment +=   '<img alt="' + badges[index].description + '" height="' + width + '" width="' + height + '" src="' + badges[index].badge + '"/>';
          fragment += '</a>';
        }

        t.html(fragment);
      }
      return {
        showBadges: function(options){
          $.ajax({
              url: 'http://coderwall.com/' + options.user + '.json?callback=?'
            , dataType: 'jsonp'
            , error: function (err) { $(options.target + ' li.loading').addClass('error').text("Error loading feed"); }
            , success: function(res) {
                render(options, res.data.badges);
            }
          });
        }
      };
    })();

    $(document).ready(function(){
      coderwall.showBadges({
        user: 'alanthing',
        target: '#cw_badges'
      });
    });
  </script>
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/alanthing">@alanthing</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'alanthing',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Alan Ivey -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'alanthing';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
