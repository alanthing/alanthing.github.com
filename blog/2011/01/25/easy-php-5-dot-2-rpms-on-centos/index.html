
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Easy PHP 5.2 RPMs on CentOS - alanthing</title>
  <meta name="author" content="Alan Ivey">

  
  <meta name="description" content="I had previously written a post on one method of upgrading PHP from 5.1 to 5.2 on CentOS and Red Hat servers by creating new RPMs. Since then, I have &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alanthing.com/blog/2011/01/25/easy-php-5-dot-2-rpms-on-centos">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="alanthing" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34327970-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">alanthing</a></h1>
  
    <h2>Linux and other things</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alanthing.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Easy PHP 5.2 RPMs on CentOS</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-25T10:13:00-05:00" pubdate data-updated="true">Jan 25<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I had previously <a href="http://echodittolabs.org/blog/2009/05/all-i-want-php-52-centosrhel">written a post</a> on one method of upgrading PHP from 5.1 to 5.2 on CentOS and Red Hat servers by creating new RPMs. Since then, I have found a much better way to create PHP 5.2.17 (or newer) RPMs to easily upgrade (and later remove, if you want) the older version available by default. I&rsquo;ll presume you have no prior experience building PHP RPMs.</p>

<p>We start by adding the <a href="http://fedoraproject.org/wiki/EPEL">Extra Packages for Enterprise Linux (EPEL) repository</a> to our server. EPEL is safe to add as an additional repository and leave enabled because it <a href="http://fedoraproject.org/wiki/EPEL/FAQ#How_is_EPEL_different_from_other_third_party_repositories_for_RHEL_and_derivatives.3F">provides complementary packages only</a> and will not conflict with the CentOS or Red Hat repositories. Since their installation method may change, I won&rsquo;t reproduce it here; instead head over to the <a href="http://fedoraproject.org/wiki/EPEL/FAQ#howtouse">installation portion of the FAQ</a> and it&rsquo;s just one line to get started with EPEL.</p>

<p>With EPEL enabled, we will need just one new package to build RPMs: <a href="http://fedoraproject.org/wiki/Projects/Mock">Mock</a>. Mock will create a chroot, download what&rsquo;s necessary to build your RPM, build, and cleanup afterwards. Mock only requires a couple of python packages as dependencies; it will not require a compiler or anything like that since mock will grab them as needed during operation. I will presume you are not running as root so I will use sudo as necessary. To install mock:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum install mock
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it. You can run all mock operations with the &lsquo;sudo&rsquo; command to run as root, but your packages will be built inside the chroot as a non-root user. Or, if you prefer to not use sudo when running mock, add your user to the mock group (where username is your user):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo /usr/sbin/usermod -G mock username
</span></code></pre></td></tr></table></div></figure>


<p>Using the source code from php.net and creating a RPM spec file from scratch would be a lot of work, so we&rsquo;ll grab a source RPM for PHP 5.2. I&rsquo;ve found that <a href="http://blog.famillecollet.com/">Remi</a> has the most up-to-date RPM spec with the latest patches and robust install scripts. <a href="http://rpms.famillecollet.com/SRPMS/">Browse Remi&rsquo;s SRPMS</a> and download the latest PHP 5.2 file. As of this writing, it&rsquo;s php-5.2.17-1.remi.src.rpm. On your system, download it with wget in your home directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~
</span><span class='line'>wget http://rpms.famillecollet.com/SRPMS/php-5.2.17-1.remi.src.rpm
</span></code></pre></td></tr></table></div></figure>


<p>Now, we could just run mock and rebuild this source RPM and hopefully install the results, but it would fail due to not having sqlite2-devel installed. Remi provides sqlite2 and sqlite2-devel, so you could add Remi&rsquo;s yum repository to your mock settings, but then it would grab Remi&rsquo;s other updated packages like MySQL 5.5 and others during the PHP build. My goal here is to only build PHP against Base CentOS and EPEL packages. So, we have to edit the spec file and rebuild the source RPM before passing it off to mock. Don&rsquo;t worry; while there are a few steps, it&rsquo;s not very difficult if you follow closely.</p>

<p>To unpack the source RPM we just downloaded into our home directory, we&rsquo;ll need to set up the .rpmmacros file in our home directory. Why? Without it, it will attempt to extract to /usr/src/redhat, and only root can use that directory, and you should <a href="http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment">never build any packages as a privileged user</a>. We&rsquo;ll create the macros file and the directories it needs from your home directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;%_topdir %(echo $HOME)/rpmbuild&#39;</span> &gt; ~/.rpmmacros
</span><span class='line'>mkdir -p ~/rpmbuild/<span class="o">{</span>SOURCES,SPECS,SRPMS<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unpack the source RPM. This will extract the PHP 5.2.17 source and any patches and configuration files into ~/rpmbuild/SOURCES, and the spec file will be in ~/rpmbuild/SPECS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rpm -ivh php-5.2.17-1.remi.src.rpm
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to make a couple of changes to the spec file. We&rsquo;ll change to the SPECS directory and make a copy of Remi&rsquo;s spec file so we can keep it for reference:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>cp -a php52.spec php.spec
</span></code></pre></td></tr></table></div></figure>


<p>Open up php.spec in your favorite text editor and let&rsquo;s have the PHP configure script use the bundled SQLite2 libraries instead of searching for ones on your system:</p>

<ol>
<li>Find the line &ldquo;BuildRequires: sqlite2-devel >= 2.8.0&rdquo; and delete it</li>
<li>Find &ldquo;&mdash;with-sqlite=shared,%{_prefix} \&rdquo; and replace it with &ldquo;&mdash;with-sqlite=shared \&rdquo;</li>
<li>Optionally: Add your own lines to the %changelog describing that you removed the sqlite2-devel build requirement</li>
<li>Optionally: Remove the first 4 lines after &ldquo;%pre common&rdquo; to remove Remi&rsquo;s note about their forums</li>
</ol>


<p>It took 2 small tweaks to remove the sqlite2-devel RPM requirement not found in our standard repositories. See <a href="http://paste.ly/4Yrx">php.spec.diff</a> to see only the changes we made; or <a href="http://paste.ly/4Ys5">php.spec</a> for the complete file if you do not want to edit it yourself.</p>

<p>The hard part is now over! It&rsquo;s easy from here on out. First step is to build the newly-edited spec into your own source RPM. But first, if you don&rsquo;t have &ldquo;rpmbuild&rdquo; available, it&rsquo;s a quick install via yum:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum install rpm-build
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s possible your system may have already had the yum package rpm-build installed. We&rsquo;ll build our source RPM with &ldquo;-bs&rdquo; to <strong>b</strong>uild the <strong>s</strong>ource, and &ldquo;&mdash;nodeps&rdquo; to prevent our system from checking all of the &ldquo;Requires&rdquo; in the spec since we&rsquo;re just building the source:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rpmbuild --nodeps -bs php.spec
</span><span class='line'>Wrote: /home/username/rpmbuild/SRPMS/php-5.2.17-1.src.rpm
</span></code></pre></td></tr></table></div></figure>


<p>rpmbuild will show you where it wrote your source RPM. All we have to do is provide it to mock; &ldquo;-v&rdquo; will give us verbose output and &ldquo;-r epel-5-x86_64&rdquo; will use the mock profile at &ldquo;/etc/mock/epel-5-x86_64.cfg&rdquo;. If you&rsquo;re on a 32-bit system, change &ldquo;epel-5-x86_64&rdquo; to &ldquo;epel-5-i386&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>mock -v -r epel-5-x86_64 php-5.2.17-1.src.rpm
</span></code></pre></td></tr></table></div></figure>


<p>The output shows you that mock is creating a chroot, downloading the bare essentials needed for a chroot and compiling tools, ccache to speed up compilation, and the packages in all &ldquo;Requires&rdquo; lines in the spec file. When mock is finished with the build after several minutes, you&rsquo;ll see output similar to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO: Done<span class="o">(</span>php-5.2.17-1.src.rpm<span class="o">)</span> Config<span class="o">(</span>epel-5-x86_64<span class="o">)</span> 10 minutes 20 seconds
</span><span class='line'>INFO: Results and/or logs in: /var/lib/mock/epel-5-x86_64/result
</span></code></pre></td></tr></table></div></figure>


<p>The /var/lib/mock/epel-5-x86_64/results/ folder will contain all of your PHP RPMs, including another source RPM. You can now either install these PHP packages by hand, or you can dump them into <a href="http://www.techrepublic.com/blog/opensource/create-your-own-yum-repository/609">your own Yum repository</a> and install with yum.</p>

<h3>TL;DR</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum install mock
</span><span class='line'>sudo /usr/sbin/usermod -G mock username
</span><span class='line'><span class="nb">cd</span> ~
</span><span class='line'>wget http://rpms.famillecollet.com/SRPMS/php-5.2.17-1.remi.src.rpm
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;%_topdir %(echo $HOME)/rpmbuild&#39;</span> &gt; ~/.rpmmacros
</span><span class='line'>mkdir -p ~/rpmbuild/<span class="o">{</span>SOURCES,SPECS,SRPMS<span class="o">}</span>
</span><span class='line'>rpm -ivh php-5.2.17-1.remi.src.rpm
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SPECS
</span><span class='line'>cp -a php52.spec php.spec
</span><span class='line'>sed -i <span class="s2">&quot;/BuildRequires\: sqlite2-devel/d&quot;</span> php.spec
</span><span class='line'>sed -i <span class="s2">&quot;s/--with-sqlite=shared,%{_prefix}/--with-sqlite=shared/&quot;</span> php.spec
</span><span class='line'>sudo yum install rpm-build
</span><span class='line'>rpmbuild --nodeps -bs php.spec
</span><span class='line'><span class="nb">cd</span> ~/rpmbuild/SRPMS
</span><span class='line'>mock -v -r epel-5-x86_64 php-5.2.17-1.src.rpm
</span></code></pre></td></tr></table></div></figure>


<p>Resulting RPMs will be in /var/lib/epel-5-x86_64/results. If on a 32-bit system, replace epel-5-x86_64 with epel-5-i386.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alan Ivey</span></span>

      








  


<time datetime="2011-01-25T10:13:00-05:00" pubdate data-updated="true">Jan 25<span>th</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://alanthing.com/blog/2011/01/25/easy-php-5-dot-2-rpms-on-centos/" data-via="alanthing" data-counturl="http://alanthing.com/blog/2011/01/25/easy-php-5-dot-2-rpms-on-centos/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/01/05/are-your-wordpress-sites-running-the-latest-core/" title="Previous Post: Are your WordPress sites running the latest core?">&laquo; Are your WordPress sites running the latest core?</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/02/15/fix-pear-permissions-problem-mac-os-x/" title="Next Post: Fix pear permissions problem on Mac OS X">Fix pear permissions problem on Mac OS X &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/11/creating-php-packages-software-collection/">Creating PHP Packages as a Software Collection</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/09/speed-up-php-on-nfs-with-turbo-realpath/">Speed Up PHP on NFS With Turbo_realpath</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/17/virtualbox-extension-pack-with-one-line/">VirtualBox Extension Pack With One Line</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/21/real-time-ruby-gem-development/">"Real-time" Ruby Gem Development</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/19/usable-mamp-os-x-108-mountain-lion/">Usable MAMP on OS X 10.8 Mountain Lion</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Coderwall</h1>
  <ul id="cw_badges">
    <li class="loading">Status updating...</li>
  </ul>
  
  <div>
    <a href="http://coderwall.com/alanthing" target="_blank" class="cw_badge"><img
       alt="Endorse alanthing on Coderwall"
       src="http://api.coderwall.com/alanthing/endorsecount.png" /></a>
  </div>
  

  <script type="text/javascript">
    var coderwall = (function(){
      function render(options, badges){
        var fragment = '',
            t = $(options.target),
            height = 65,
            width = 65,
            index;

        for (index in badges) {
          fragment += '<a class="cw_badge"title="' + badges[index].description + '" target="_blank" href="http://coderwall.com/' + options.user + '">';
          fragment +=   '<img alt="' + badges[index].description + '" height="' + width + '" width="' + height + '" src="' + badges[index].badge + '"/>';
          fragment += '</a>';
        }

        t.html(fragment);
      }
      return {
        showBadges: function(options){
          $.ajax({
              url: 'http://coderwall.com/' + options.user + '.json?callback=?'
            , dataType: 'jsonp'
            , error: function (err) { $(options.target + ' li.loading').addClass('error').text("Error loading feed"); }
            , success: function(res) {
                render(options, res.data.badges);
            }
          });
        }
      };
    })();

    $(document).ready(function(){
      coderwall.showBadges({
        user: 'alanthing',
        target: '#cw_badges'
      });
    });
  </script>
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/alanthing">@alanthing</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'alanthing',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Alan Ivey -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'alanthing';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://alanthing.com/blog/2011/01/25/easy-php-5-dot-2-rpms-on-centos/';
        var disqus_url = 'http://alanthing.com/blog/2011/01/25/easy-php-5-dot-2-rpms-on-centos/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
